<h2 id="前言">前言</h2>

<h3 id="easy-connect">Easy Connect</h3>

<p>  公司、学校、云服务等一般需要将内外网进行分离，如果想要从外部网络访问某些内部应用，通常需要使用公司、学校、云服务提供的专用网络接入服务。国内公司、学校比较常用的是由深信服开发的 Easy Connect，一种 SSL VPN 技术的实现。虽然每年需要支付一定的费用来维护、升级 Easy Connect 服务，但是毕竟它能够提供比较细粒度的权限控制，比如说对目标 IP、目标端口的特别指定，能够有效保护内网服务器只有 Web 应用本身能被用户接入，而类似于 SSH 等服务及端口则可以通过单独申请和配置来实现。总而言之，除了需要付费，似乎没有什么不好的地方。</p>

<p>  实际上如果是在大公司或者学校的话，可能在内网里面还会有更深的内网存在。举个例子，正常的内网是日常的办公或开发网络，服务器所处的内网是独立的网络，即使是已经连接了办公网络，还是需要通过专用网络接入服务器内网才能进行服务器的维护。如果是以数据中心的模式运营的话，甚至说每一次访问服务器都是需要经过临时审批和登录密码发放的。一旦过了有效时间或者完成了任务，访问都将会被拒绝。</p>

<h3 id="openvpn">OpenVPN</h3>

<p>  虽然 Easy Connect 可以用于上述的场景，但是似乎显得有些大材小用了，毕竟还是要支付一定费用的。为了尽量降低成本，开源的 OpenVPN 或许是一种不错的选择。据笔者所知，Easy Connect 根据购买的许可不同允许的同时在线人数可能也会不同，实际上可能存在“需大于供”的问题。为了缓解这一可能存在的问题，还是会搭建一套 OpenVPN 来作为冗余接入方式。其实 OpenVPN 的商业版本许可也是会有人数限制的，只不过因为只是备份方式也没有太大关系。</p>

<p>  OpenVPN 除了开源免费之外，还支持大部分主流的认证方式，比如说 LDAP 认证、微软的商业级目录服务 Active Directory（简称 AD）认证等。近年来，基于 Identify Provider（简称 IdP）、Single Sign On（简称 SSO）、Central Authentication Service（简称 CAS）等的国产化的一站式登录服务解决方案也在逐渐替换原来的 LDAP 或 AD 直接认证，LDAP 或 AD 将作为底层的基础认证方式存在。所以说，开源免费的 LDAP 目录服务在一般的团队中还是足够的，作为 OpenVPN 的认证方式也是完全能满足要求的。</p>

<blockquote>
  <p>warning “提醒”
  在公网上搭建专用网络接入服务是需要有工信部颁发的专门资格许可的，一般公司、学校、云服务都是有该类资格许可，所以可以对外提供该项服务。而个人是无法获得这类许可，除非注册公司并申请该类许可。如果个人在云服务上搭建该类服务，将会面临被云服务提供商警告甚至单方面停止服务的风险。</p>
</blockquote>

<h2 id="实践">实践</h2>

<h3 id="环境要求">环境要求</h3>

<p>  在实践前请务必保证具备以下环境：</p>

<ul>
  <li>Docker</li>
  <li>docker-compose</li>
  <li>可用的 LDAP 目录服务</li>
</ul>

<h3 id="启动实例">启动实例</h3>

<p>  为了方便部署和测试，这里采用 <a href="https://hub.docker.com/r/wheelybird/openvpn-ldap-otp">wheelybird/openvpn-ldap-otp</a> 提供的 Docker 镜像。这个镜像比较小，同时也支持 x64 和 arm 两种体系架构，能满足大部分主流服务器平台。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># docker-compose.yml</span>

<span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3'</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">openvpn</span><span class="pi">:</span>
    <span class="na">cap_add</span><span class="pi">:</span>
     <span class="pi">-</span> <span class="s">NET_ADMIN</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">wheelybird/openvpn-ldap-otp</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">openvpn</span>
    <span class="na">ports</span><span class="pi">:</span>
     <span class="pi">-</span> <span class="s2">"</span><span class="s">1194:1194/udp"</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">always</span>
    <span class="na">volumes</span><span class="pi">:</span>
     <span class="pi">-</span> <span class="s">/etc/localtime:/etc/localtime:ro</span>
     <span class="pi">-</span> <span class="s">/etc/timezone:/etc/timezone:ro</span>
     <span class="pi">-</span> <span class="s">./openvpn-data:/etc/openvpn</span>
    <span class="na">environment</span><span class="pi">:</span>
     <span class="pi">-</span> <span class="s">OVPN_SERVER_CN=oc-vpn.example.com</span>
     <span class="pi">-</span> <span class="s">LDAP_URI=ldap://ldap.example.com</span>
     <span class="pi">-</span> <span class="s">LDAP_BASE_DN=ou=users,dc=example,dc=com</span>
     <span class="pi">-</span> <span class="s">LDAP_BIND_USER_DN=cn=admin,dc=example,dc=com</span>
     <span class="pi">-</span> <span class="s">LDAP_BIND_USER_PASS=password</span>
     <span class="pi">-</span> <span class="s">LDAP_LOGIN_ATTRIBUTE=uid</span>
     <span class="pi">-</span> <span class="s">LOG_TO_STDOUT=false</span>
     <span class="pi">-</span> <span class="s">OVPN_DNS_SEARCH_DOMAIN=example.com</span>
</code></pre></div></div>

<p>  使用以下 docker-compose.yml 文件和 <code class="language-plaintext highlighter-rouge">docker-compose up -d</code> 命令启动实例。为了能够避免实例在重新创建后证书发生改变，将 Docker 实例中 /etc/openvpn 的目录持久化（与本地目录绑定）是非常重要的。在这里给出的环境变量（environment）中，前三项 OVPN_SERVER_CN、LDAP_URI、LDAP_BASE_DN 是必须要有的。如果 LDAP 目录服务默认是不能被匿名查找的，也必须包含 LDAP_BIND_USER_DN 和 LDAP_BIND_USER_PASS 变量的（即管理员账户名和密码）。当然，如果你想要指定匹配登录用户名字段，则需要新增 LDAP_LOGIN_ATTRIBUTE 变量。该变量默认是 uid 字段，也可以指定为其他 LDAP 目录服务中包含的字段，比如 email。这个镜像默认是会将服务的实时输出打印在终端，如果想要以日志文件的形式保存下来，则将变量 LOG_TO_STDOUT 置为 false 即可。</p>

<p>  一般来说，服务器内网为了管理方便，会根据服务器的 ip 和编号来配置对应的域名解析及反向域名解析，形如 <code class="language-plaintext highlighter-rouge">ec2-1-1-1-1.aws.com</code>，也有可能就是简单的 <code class="language-plaintext highlighter-rouge">c1.sever.aws.com</code>。所以当接入服务器内网后，我们可能会期望用 c1 来作为这台服务器的标签，而在终端我们也可能通过 <code class="language-plaintext highlighter-rouge">ping c1</code> 来测试通路。实际上只要在启动实例时新增变量 OVPN_DNS_SEARCH_DOMAIN 就可以实现，当然这里变量对应的值也应该变成 <code class="language-plaintext highlighter-rouge">server.aws.com</code>。相当于，有了这个配置后，本地 DNS 解析没有记录时会自动尝试加入后缀来解析。这样一来，是不是方便了很多呢？</p>

<p>  除此之外，该镜像还支持其他一些特性，比如 OTP，请访问 <a href="https://github.com/wheelybird/openvpn-server-ldap-otp">wheelybird/openvpn-ldap-otp</a> 了解更多。</p>

<h4 id="生成配置文件">生成配置文件</h4>

<p>  在生成配置文件上，<a href="https://github.com/wheelybird/openvpn-server-ldap-otp">wheelybird/openvpn-ldap-otp</a> 要比 <a href="https://github.com/kylemanna/docker-openvpn">kylemanna/docker-openvpn</a> 更复杂一些，可以手动从 Docker 实例的日志文件或终端输出内容中看到内容，大致内容形式如下所示：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#---------- Start of client.ovpn ----------</span>

client
tls-client
dev tun
persist-key
persist-tun
remote-cert-tls server
key-direction 1
auth SHA512
proto tcp
reneg-sec 0

comp-lzo
redirect-gateway def1
auth-user-pass

<span class="c"># Set log file verbosity</span>
verb 3

&lt;connection&gt;
remote oc-vpn.example.com 1194 udp
float
nobind
&lt;/connection&gt;

&lt;ca&gt;
<span class="nt">-----BEGIN</span> CERTIFICATE-----
.........
.........
<span class="nt">-----END</span> CERTIFICATE-----
&lt;/ca&gt;
&lt;tls-auth&gt;
<span class="c">#</span>
<span class="c"># 2048 bit OpenVPN static key</span>
<span class="c">#</span>
<span class="nt">-----BEGIN</span> OpenVPN Static key V1-----
.........
.........
<span class="nt">-----END</span> OpenVPN Static key V1-----
&lt;/tls-auth&gt;
key-direction 1
<span class="c">#----------  End of client.ovpn  ----------</span>
</code></pre></div></div>

<p>  将以上内容复制保存在 oc-vpn.example.com.ovpn 文件中即可。</p>

<h3 id="测试">测试</h3>

<p>  通常来说使用 OpenVPN 专用或者兼容客户端来加载配置文件 oc-vpn.example.com.ovpn，当然也可以用终端命令连接，如下所示：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>openvpn <span class="nt">--config</span> oc-vpn.example.com.ovpn
</code></pre></div></div>

<p>  执行上述命令后会提示输入用户名和密码进行认证，认证通过后会建立连接。默认分配的是 10.50.50.0/24 段中的某个 IP，网关为 10.50.50.254，当然这个也可以在启动实例时自行设置。</p>

<blockquote>
  <p>warning “再次提醒”
  以上内容比较适用于团队办公或开发网络与服务器网络独立分离的情况（<strong>内网环境</strong>）。请勿在未获得工信部的资质许可的情况下在公网部署类似服务，一旦被云服务提供商监测到，云服务提供商有权进行警告、断网、关停等操作，并且无法申诉。</p>
</blockquote>

<h2 id="参考资料">参考资料</h2>

<ul>
  <li><a href="https://github.com/wheelybird/openvpn-server-ldap-otp">wheelybird/openvpn-ldap-otp</a></li>
  <li><a href="https://github.com/kylemanna/docker-openvpn">kylemanna/docker-openvpn</a></li>
</ul>

<blockquote>
  <p>note “提示”
我的博客即将同步至腾讯云开发者社区，邀请大家一同入驻：<a href="https://cloud.tencent.com/developer/support-plan?invite_code=1jkj42lj2m4nn">加入链接</a>。</p>
</blockquote>
