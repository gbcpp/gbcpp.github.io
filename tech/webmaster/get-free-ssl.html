<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Letsencrypt 泛域名 SSL 证书免费申请 - 仲儿的自留地</title>
    <meta name="author"  content="zhonger">
    <meta name="description" content="Letsencrypt 泛域名 SSL 证书免费申请">
    <meta name="keywords"  content="Letsencrypt, ssl, 泛域名, 免费">
    <!-- Open Graph -->
    <meta property="og:title" content="Letsencrypt 泛域名 SSL 证书免费申请 - 仲儿的自留地">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://lisz.me/tech/webmaster/get-free-ssl.html">
    <meta property="og:description" content="个人的一个技术博客站点，主要用于记录个人在学习过程中遇到的技术问题及解决方法、技术实验，以及一些比较有趣的事情。">
    <meta property="og:site_name" content="仲儿的自留地">
    <link rel="Shortcut Icon" href="/assets/icons/favicon.ico">
    <link rel="bookmark" href="/assets/icons/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.min.css">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_roc50gemkxpw4s4i.css">
    <link rel="stylesheet" href="/assets/css/plugins.min.css">
    <link rel="preload" href="/assets/fonts/Merriweather-Regular.ttf" as="font" crossorigin=”anonymous”>
    <link rel="stylesheet" href="/assets/css/app.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-164207041-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-164207041-1');
    </script>
</head>
<body>
    <!--[if lt IE 10]>
<div class="alert-danger" role="alert">你的浏览器实在太太太旧了，放学别走，升级完浏览器再说！<a target="_blank" class="alert-link" href="http://browsehappy.com">立即升级</a></div>
<![endif]-->
<input id="nm-switch" type="hidden" value="false">

<header class="g-header">
    <div class="g-logo">
      <a href="/" aria-label="Homepage"></a>
    </div>
    <!-- <i id="menu-toggle" class="iconfont icon-menu"></i> -->
    <svg id="menu-toggle" class="icon-menu" aria-hidden="true">
        <use xlink:href="#icon-menu"></use>
    </svg>
    <nav class="g-nav">
        <ul>
            
            <li><a href="/">home</a></li>
            
            <li><a href="/blog/index.html">blog</a></li>
            
            <li><a href="/archives.html">archives</a></li>
            
            <li><a href="{"CONQUEST"=>"/tags.html#CONQUEST", "LDAP"=>"/tags.html#LDAP", "博客"=>"/tags.html#blog"}">collections</a></li>
            
            <li><a href="/tags.html">tags</a></li>
            
            <li><a href="{"logs"=>"/logs.html", "tos"=>"/tos.html", "RSS"=>"/feed.xml", "CV"=>"/cv.html", "links"=>"/links.html"}">about</a></li>
            
        </ul>
    </nav>
</header>


<header class="g-banner post-header post-pattern-food bgcolor-default " data-theme="default">
    <div class="post-wrapper">
        <div class="post-tags">
            
            
            <a href="/tags.html#Letsencrypt" class="post-tag">Letsencrypt</a>
            
            <a href="/tags.html#ssl" class="post-tag">ssl</a>
            
            <a href="/tags.html#%E6%B3%9B%E5%9F%9F%E5%90%8D" class="post-tag">泛域名</a>
            
            <a href="/tags.html#%E5%85%8D%E8%B4%B9" class="post-tag">免费</a>
            
            
        </div>
        <h1>Letsencrypt 泛域名 SSL 证书免费申请</h1>
        <div class="post-meta">
            <span class="post-meta-item"><i class="iconfont icon-author"></i><a href="https://lisz.me" target="_blank" rel="author">zhonger</a></span>
            <time class="post-meta-item" datetime="18-03-14"><i class="iconfont icon-date"></i>Wed, 14 Mar 2018 21:25:44 +0900</time>
        </div>
        <div class="post-meta">
            <span>本文总共 3199 字 <b>·</b> 阅读全文大约需要 10 分钟</span>
        </div>
    </div>
    
    <div class="filter"></div>
    <div class="post-cover" style="background: url('https://i.lisz.top/cover/3ruY1v.webp') center no-repeat; background-size: cover;">
    
</header>

<div class="post-content">
    
    <h2 class="post-subtitle">内网站点也可以轻松 HTTPS 化了</h2>
    
    <article class="markdown-body" id="lightgallery">
        <h2 id="https-和-lets-encrypt-简介">HTTPS 和 Let’s encrypt 简介</h2>

<p>  超文本传输安全协议（英语：Hypertext Transfer Protocol Secure，缩写：HTTPS，常称为 HTTP over TLS，HTTP over SSL 或 HTTP Secure）是一种网络安全传输协议。在计算机网络上，HTTPS 经由超文本传输协议进行通信，但利用 SSL/TLS 来加密数据包。HTTPS 开发的主要目的，是提供对网络服务器的身份认证，保护交换数据的隐私与完整性。这个协议由网景公司（Netscape）在1994年首次提出，随后扩展到互联网上。</p>

<p>  HTTPS 连接经常用于万维网上的交易支付和企业信息系统中敏感信息的传输，而如今在 Goolge 、 Mozilla 等大厂的联合推广下， HTTPS 已经成为了每一个站点的安全必备要素。</p>

<p>  然而 HTTPS 要求在一层加密连接（TLS 或 SSL）上来进行常规的 HTTP 协议，因此搭建 HTTPS 站点必须要先获得一个 SSL 证书。 SSL 证书是经过所谓的国际顶级 CA 机构进行颁发，大部分情况下是需要支付一定的费用的。根据支付不同价格的费用，可以分别域名型 DV 、企业型 OV 和增强型 EV ，这个可以参考 <a href="https://cloud.tencent.com/product/ssl">腾讯云 SSL 产品介绍</a> 来理解一下。</p>

<p>  由于有了 Google 、 Mozilla 等大厂的 HTTPS 呼吁，他们也想能够提供给站点免费的 SSL 证书借此来提升大家迁移到 HTTPS 站点的热情，于是就有了非常著名的 Let’s encrypt 这样一款非常好看又好玩的产品。 Let’s encrypt 在发展之初仅支持向单域名或者多域名颁发一个证书、60 天有效期，每个证书最多包含 100 个域名，而且需要通过 DNS 解析记录和 HTTP 访问来验证域名的所有权，因此对于站点是否处于公网是有要求的。有人说站点不是都在公网上，难道连内网中的站点也要 HTTPS 化吗？其实如果按照之前的情况来看，内网站点 HTTPS 化只能采用曲线的方式实现。（用一台公网服务器来申请好证书，再将域名解析到内网并且部署证书在内网，这样的坏处就是始终需要通过这样一个方式来更新证书，十分麻烦。）于是，<a href="https://certbot.eff.org">certbot</a> 这款优秀的工具就诞生了。certbot 支持大部分的 web 服务器（例如 Nginx、Apache 、Haproxy 等）和大部分的操作系统（Centos 系列、Debian 系列、Archlinux 等），不得不说是所有 Let’s encrypt 衍生出的 SSL 证书申请工具的佼佼者。</p>

<p>  在2018年3月，Let’s encrypt 在很长一段时间的努力下，终于进一步缩小了 SSL 证书颁发的限制，已经支持颁发泛域名证书(<a href="https://community.letsencrypt.org/t/acme-v2-and-wildcard-certificate-support-is-live/55579">原文</a>)。这样一来，在内网中部署 SSL 证书将不再受限，所有的要求只剩下一点—-你对申请证书的域名具有所有权。在众多的 Let’s encrypt SSL 证书申请工具中，<a href="https://acme.sh">acme.sh</a> 一下子就脱颖而出了。<code class="language-plaintext highlighter-rouge">acme.sh</code> 支持通过 DNS 来验证域名所有权，因此你只需在指定域名时前面加上 <code class="language-plaintext highlighter-rouge">*</code> 就可以申请一枚免费的泛域名了。</p>

<h2 id="ssl-证书申请">SSL 证书申请</h2>

<p>  下面我们将会以申请 <code class="language-plaintext highlighter-rouge">*.shu.aixinwu.org</code> 为例来讲一下这款工具的用法，真的是很清真。</p>

<h3 id="申请泛域名">申请泛域名</h3>

<p>  申请泛域名的第一步自然是安装 SSL 证书申请工具了，当然我们选用的是 <code class="language-plaintext highlighter-rouge">acme.sh</code>。</p>

<h3 id="下载-acmesh-工具">下载 acme.sh 工具</h3>

<p>  acme.sh 官方提供一个非常简单的一键安装脚本，老少皆宜。当然，安装这个工具对于是否在公网并没有任何要求，你可以选择在将要部署 SSL 证书的内网服务器中安装即可，请用<strong>非root用户</strong>全程执行命令。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 安装acme.sh</span>
curl https://get.acme.sh | sh

<span class="c"># 使acme.sh在bash中生效</span>
<span class="nb">source</span> .bashrc 
</code></pre></div></div>

<h3 id="提交泛域名">提交泛域名</h3>

<p>  安装好<code class="language-plaintext highlighter-rouge">acme.sh</code>工具，就可以开始提交泛域名申请了，按照下面命令就可以使用 DNS 验证的方式来提交申请。结果会返回一个 TXT 记录新增的要求。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>acme.sh <span class="nt">--issue</span> <span class="nt">--dns</span> <span class="nt">-d</span> shu.aixinwu.org <span class="nt">-d</span> <span class="k">*</span>.shu.aixinwu.org <span class="nt">--yes-I-know-dns-manual-mode-enough-go-ahead-please</span>
</code></pre></div></div>

<h3 id="添加-dns-记录">添加 DNS 记录</h3>

<p>  根据上一步返回的 TXT 记录添加要求，在相应的域名 DNS 服务提供商那里添加好对应的 TXT 记录即可。如下图所示。</p>

<p><img src="https://i.lisz.top/blog/bI1lze.webp" alt="TXT 记录新增 Add TXT record" /></p>

<h3 id="生成泛域名证书">生成泛域名证书</h3>

<p>  在添加好 TXT 记录之后，就可以使用更新命令来请求颁发泛域名证书。执行下面这条命令之后可以发现返回了生成的文件的本地路径。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>acme.sh <span class="nt">--renew</span> <span class="nt">-d</span> shu.aixinwu.org <span class="nt">-d</span> <span class="k">*</span>.shu.aixinwu.org <span class="nt">--yes-I-know-dns-manual-mode-enough-go-ahead-please</span>
</code></pre></div></div>

<p>  到此为止，泛域名证书已经申请完成，但是用于部署还有点小毛病。因为通过 DNS 申请生成的 SSL 证书的 key 和 cer 两个文件都不是标准的 pem 文件格式，在某些浏览器或者终端中会出现缺少中间 CA 机构证书的问题（尽管在大部分浏览器中是没有任何问题的，但是为了终端中不产生问题最好还是修复该问题），所以需要在正式部署之前生成好 pem 证书。</p>

<h2 id="部署泛域名">部署泛域名</h2>

<p>  这里以 Nginx 为例来展示部署泛域名的步骤。首先是通过 key 和 cer 文件来生成对应包含完整证书链的 pem 文件。</p>

<h3 id="生成-pem-证书">生成 pem 证书</h3>

<p>  acme.sh 工具自身就提供一键生成 pem 证书的方式，无须像网上很多博客中讲的通过 <code class="language-plaintext highlighter-rouge">openssl</code> 原生命令来转换文件。以下操作即可生成的 key 和 cert 的 pem 文件到用户主目录的 ssl 文件中。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>acme.sh <span class="nt">--install-cert</span> <span class="nt">-d</span> shu.aixinwu.org <span class="se">\</span>
<span class="nt">--key-file</span> /home/ubuntu/ssl/shu.aixinwu.org.key.pem <span class="se">\</span>
<span class="nt">--fullchain-file</span> /home/ubuntu/ssl/shu.aixinwu.org.cert.pem 
</code></pre></div></div>

<h3 id="添加到-nginx-中">添加到 Nginx 中</h3>

<p>  以下为 Nginx 文件文件示例。</p>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">server</span>
    <span class="p">{</span>
        <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
        <span class="kn">listen</span> <span class="s">[::]:80</span><span class="p">;</span>
        <span class="kn">server_name</span> <span class="s">shu.aixinwu.org</span> <span class="s">*.shu.aixinwu.org</span><span class="p">;</span>
        <span class="kn">return</span> <span class="mi">301</span> <span class="s">https://</span><span class="nv">$host$request_uri</span><span class="p">;</span>
    <span class="p">}</span>

<span class="k">server</span>
    <span class="p">{</span>
        <span class="kn">listen</span> <span class="mi">443</span><span class="p">;</span>
        <span class="kn">listen</span> <span class="s">[::]:443</span><span class="p">;</span>
        <span class="kn">server_name</span> <span class="s">shu.aixinwu.org</span> <span class="s">*.shu.aixinwu.org</span><span class="p">;</span>
        <span class="kn">ssl</span> <span class="no">on</span><span class="p">;</span>
        <span class="kn">ssl_certificate</span> <span class="n">/home/ubuntu/ssl/shu.aixinwu.org.cert.pem</span><span class="p">;</span>
        <span class="kn">ssl_certificate_key</span> <span class="n">/home/ubuntu/ssl/shu.aixinwu.org.key.pem</span><span class="p">;</span>
        <span class="kn">index</span> <span class="s">index.html</span> <span class="s">index.htm</span> <span class="s">index.php</span> <span class="s">default.html</span> <span class="s">default.htm</span> <span class="s">default.php</span><span class="p">;</span>
        <span class="kn">root</span>  <span class="n">/home/wwwroot/shu.aixinwu.org</span><span class="p">;</span>

        <span class="kn">location</span> <span class="n">/</span>
        <span class="p">{</span>
            <span class="kn">try_files</span> <span class="nv">$uri</span> <span class="s">@apache</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kn">location</span> <span class="s">@apache</span>
        <span class="p">{</span>
            <span class="kn">internal</span><span class="p">;</span>
            <span class="kn">proxy_pass</span> <span class="s">http://127.0.0.1:89</span><span class="p">;</span>
            <span class="kn">include</span> <span class="s">proxy.conf</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kn">access_log</span>  <span class="n">/home/wwwlogs/shu.aixinwu.org.log</span>  <span class="s">access</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<h2 id="总结">总结</h2>

<p>  虽然通过这样的方式我们成功实现了免费申请内网 SSL 泛域名证书，但是经过实践发现，目前 Let’s encrypt 所提供的泛域名证书只能支持到最近一级通配。比如说，现在申请的是 <code class="language-plaintext highlighter-rouge">*.shu.aixinwu.org</code> ，如果站点域名为 <code class="language-plaintext highlighter-rouge">www.t.shu.aixinwu.org</code> 即被判别为无效域名，像 <code class="language-plaintext highlighter-rouge">www.shu.aixinwu.org</code> 即可认定为合法 SSL 证书。其实因为这种泛域名证书目前并没有提出任何限制，我们可以多级通配就申请多个即可。</p>

    </article>
    
    <div class="social-share-wrapper">
        <div class="social-share"></div>
    </div>
    
</div>

<section class="author-detail">
    <section class="post-footer-item author-card">
        <div class="avatar">
            <img src="/assets/img/profile.webp" alt="">
        </div>
        <div class="author-name" rel="author">zhonger</div>
        <div class="bio">
            <p>Developer & Maintainer</p>
        </div>
        
        <ul class="sns-links">
            
            <li>
                <a href="https://scholar.google.com/citations?user=AUupIooAAAAJ" target="_blank">
                    <svg class="icon" aria-hidden="true">
                        <use xlink:href="#icon-google-scholar"></use>
                    </svg>
                </a>
            </li>
            
            <li>
                <a href="https://www.researchgate.net/profile/Shengzhou-Li" target="_blank">
                    <svg class="icon" aria-hidden="true">
                        <use xlink:href="#icon-researchgate"></use>
                    </svg>
                </a>
            </li>
            
            <li>
                <a href="https://orcid.org/0000-0001-6973-3825" target="_blank">
                    <svg class="icon" aria-hidden="true">
                        <use xlink:href="#icon-ORCID"></use>
                    </svg>
                </a>
            </li>
            
            <li>
                <a href="https://github.com/zhonger" target="_blank">
                    <svg class="icon" aria-hidden="true">
                        <use xlink:href="#icon-github"></use>
                    </svg>
                </a>
            </li>
            
            <li>
                <a href="https://www.linkedin.com/in/shengzhouli/" target="_blank">
                    <svg class="icon" aria-hidden="true">
                        <use xlink:href="#icon-linkedin"></use>
                    </svg>
                </a>
            </li>
            
            <li>
                <a href="https://segmentfault.com/u/wuwozhonger" target="_blank">
                    <svg class="icon" aria-hidden="true">
                        <use xlink:href="#icon-segmentfault"></use>
                    </svg>
                </a>
            </li>
            
        </ul>
        
    </section>
    <section class="post-footer-item read-next">
        
        <div class="read-next-item">
            <a href="/tech/docker/nextcloud.html" class="read-next-link"></a>
            <section>
                <span>Nextcloud 搭建自己的云盘</span>
                <p>Nextcloud 简介</p>
            </section>
            
            <div class="filter"></div>
            <img src="https://i.lisz.top/cover/gLQGHs.webp" alt="">
            
        </div>
        
        
        <div class="read-next-item">
            <a href="/tech/linux/unbound-dns.html" class="read-next-link"></a>
            <section>
                <span>Unbound + Dnscrypt 搭建无污染 DNS 服务</span>
                <p>前言</p>
            </section>
            
            <div class="filter"></div>
            <img src="https://i.lisz.top/cover/mL0Jdi.webp" alt="">
            
        </div>
        
    </section>
    
</section>

<footer class="g-footer">
    <section>仲儿的自留地 © 
        
          2015
          -
        
        2023
        
        <a href="https://beian.miit.gov.cn/" target="_blank"></a>
        
    </section>
    <section>Powered by <a href="//jekyllrb.com">Jekyll</a> & <a href="https://github.com/zhonger/jekyll-theme-H2O-ac">Theme H2O-ac</a> (based on <a href="https://github.com/kaeyleo/jekyll-theme-H2O">Theme H2O</a>)  <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" /></a>  <script type="text/javascript">document.write(unescape("%3Cspan id='cnzz_stat_icon_1280712061'%3E%3C/span%3E%3Cscript src='https://v1.cnzz.com/z_stat.php%3Fid%3D1280712061%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script> </section>
</footer>
<script src="//at.alicdn.com/t/font_3046306_4quk6r21fv8.js"></script>

<script src="/assets/js/social-share.min.js"></script>
<script>
    socialShare('.social-share', {
        sites: ['wechat','weibo','douban','twitter'],
        wechatQrcodeTitle: "分享到微信朋友圈",
        wechatQrcodeHelper: '<p>扫码后点击右上角</p><p>将本文分享至朋友圈</p>'
    });
</script>
<script>
/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
/*写入自己的disqus信息*/
s.src = '';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
    // 给图片添加链接
    $(document).ready(function() {
        $("p img").each(function() {
            var strA = "<a data-fancybox='gallery' ref='gallery1' href='" + this.src + "'></a>";
            $(this).wrapAll(strA);
        });

        $('[data-fancybox="gallery"]').fancybox();
    });
</script>
<script src="/assets/js/prism.js"></script>
<script src="/assets/js/index.min.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script> 
    MathJax = {
      tex: {
        inlineMath: [['$', '$']],
        processEscapes: true
      }
    };
</script>
</body>
</html>
