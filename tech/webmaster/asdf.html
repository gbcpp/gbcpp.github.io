<h2 id="前言">前言</h2>

<p>  之前介绍了高性能集群中常用的运行环境和软件版本管理工具 Modules，今天打算介绍一款适合个人或团队开发使用的通用运行环境版本管理神器 <a href="https://asdf-vm.com/zh-hans/">ASDF</a>。与高性能计算任务不同，个人或团队开发项目一般来说都是使用独立的设备或环境，然后通过代码版本跟踪 git 等来进行异步协作。所以说，在每个人的单个或多个设备上都安装配置 Modules 显得有点不太现实和高效。但是项目开发所需的代码环境确实有的时候可能比较复杂，比如说同时需要 Ruby、NodeJS、Java、Python 四种环境，而且可能对于每种环境还有版本的限制。这样一来，光配置这一堆环境就要花上大半天时间了。</p>

<h3 id="asdf-简介">ASDF 简介</h3>

<p>  ASDF 提供了全平台通用的环境配置方案，使用单个命令行工具和交互界面就可以管理超复杂的运行环境。以往针对不同运行环境，需要使用不同的配置文件来进行版本的声明。对于 ASDF，只需要一个可共享的 <code class="language-plaintext highlighter-rouge">.tool-versions</code> 配置文件即可。ASDF 涵盖了包括 Ruby、NodeJS、Java、PHP、.Net 在内的几百种运行环境，具体可以查看 <a href="https://github.com/asdf-vm/asdf-plugins">ASDF 插件列表</a> 了解更多。</p>

<p>  另外，ASDF 完全支持包括 Bash、Zsh、Fish 和 Elvish 在内的常用 shell 类型，并提供补全功能。在类似 Github Actions 等的 CI/CD 工作流中，也可以轻松使用 ASDF。值得一提的是，笔者翻译了 ASDF 文档的中文版本并被官方采纳，现在 ASDF 官网支持英语、巴西语和中文三种语言。</p>

<h3 id="为何不选其他方案">为何不选其他方案</h3>

<h4 id="docker">Docker</h4>

<p>  很显然，如果大家的设备上都有 Docker 环境且 CPU 架构相同的话，Docker 无疑是最省心的方案。Docker 镜像的确可以轻松涵盖所有开发环境和实际运行环境（Apache 等 HTTP 服务器、数据库以及其他）。相比笨重的 VMware 或 Virtualbox 虚拟机镜像而言，Docker 镜像也更加小巧、便捷。而且团队可以通过在内部搭建自己的 Docker 镜像仓库，来分享这些镜像给所有参与项目的开发者。唯一可能会有问题的是，设备 CPU 架构和操作系统的多样性可能会给实际操作带来了不小的问题。实际上可能会有 Windows 系统、Linux 系统、MacOS 系统以及 Intel 架构、AMD 架构、ARM 架构（如 M1、M2 等）。可行的解决方法是，尽可能地构建更多架构的镜像。</p>

<h4 id="anaconda">Anaconda</h4>

<p>  Anaconda 现在可能已经完全超出了一个 Python 环境管理工具，有的时候也可以当成通用软件或环境管理器来用。但是毕竟还是以科学计算为主要目的，如果项目仅仅是 Python、R 语言可能还是比较合适的，对于实际编程所需的其他运行环境来说可能还是支持不够的。</p>

<blockquote>
  <p>note “小提示”
  据笔者所知，在 <code class="language-plaintext highlighter-rouge">conda-forge</code> 频道里的确有 PHP 等编程语言的支持。除此之外，也有一些热心开发者在个人频道提供了 java-jdk、golang 等编程环境支持。</p>
</blockquote>

<h4 id="云开发">云开发</h4>

<p>  云开发主要是指基于云基础设施的在线代码开发环境，主要的代表有：</p>

<ul>
  <li><a href="https://aws.amazon.com/cn/cloud9/">Cloud9</a>：笔者最早接触过的云开发，目前已被 AWS 收购，更名为 AWS Cloud9。</li>
  <li><a href="https://github.com/features/codespaces">Codespaces</a>：由 Azure 提供云服务、Github 负责运营的一站式云开发环境。</li>
  <li><a href="https://www.gitpod.io/">Gitpod</a>：基于 VS Code 研发的优秀云开发环境，早期以“便捷、快速”著称，较先于 Codespaces 出现。</li>
  <li><a href="https://cloud.tencent.com/product/cloudstudio">Cloud Studio</a>：由腾讯云提供云服务、基于 VS Code 的国产云开发环境，能够很好地支持个人开发、招聘笔试、课堂教学、应用快捷部署等各种场景。</li>
  <li><a href="https://www.huaweicloud.com/product/cloudide.html">CodeArts IDE Online</a>：由华为云提供云服务、基于 VS Code 的国产云开发环境。除了一般云开发所具备的特点，还支持华为鲲鹏原生环境，能够很好地满足跨架构应用开发的需求。</li>
  <li><a href="https://cn.aliyun.com/product/yunxiao/devstudio">DevStudio</a>：由阿里云提供云服务、基于 VS Code 的国产云开发环境。支持应用开发全流程管理，与阿里云各项基础服务紧密结合，适合大规模团队使用。</li>
</ul>

<p>除了以上列举的云开发之外，也有一些比较传统的小型云开发实践，比如说知名的 <a href="https://jsfiddle.net/">JSFiddle</a>、<a href="https://codepen.io/">CodePen</a>、<a href="https://replit.com/">Replit</a> 等。虽然说这些云开发主要是适合较小代码库，但在实际学习过程中用处也是很大的。</p>

<p>  云开发不仅兼顾了传统开发过程中的协同与流程，又将资源与环境整合在云里面，自然而然是最好的解决方案。随着 VS Code 在开发者之间的流行和云服务提供商的努力，基于 VS Code 的云开发环境层出不穷。即使云开发环境本身免费，云也还是要按量按时计费的。对于还没有足够支持上云的团队或个人来说，ASDF 依然是个不错的选择。</p>

<h2 id="实践">实践</h2>

<h3 id="环境需求">环境需求</h3>

<ul>
  <li>Linux/Unix 环境（Linux、MacOS、Windows WSL）</li>
  <li>git</li>
  <li>bash 等（此处以 zsh 为例）</li>
</ul>

<h3 id="环境配置">环境配置</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 下载源码到 ~/.asdf 目录</span>
git clone https://github.com/asdf-vm/asdf.git ~/.asdf <span class="nt">--branch</span> v0.11.3

<span class="c"># 在 ~/.zshrc 文件中加入内容</span>
<span class="nb">tee</span> <span class="nt">-a</span> ~/.zshrc <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh">
. "</span><span class="nv">$HOME</span><span class="sh">/.asdf/asdf.sh"
</span><span class="no">EOF

</span><span class="c"># 激活配置</span>
<span class="nb">source</span> ~/.zshrc

<span class="c"># 验证</span>
╰─<span class="nv">$ </span>asdf version
v0.11.3-0adc6c1
</code></pre></div></div>

<h3 id="安装插件">安装插件</h3>

<p>  由于 ASDF 支持插件较多，这里以 Python 环境为例介绍 ASDF 安装插件。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 添加插件</span>
asdf plugin add python

<span class="c"># 查看已安装插件</span>
╰─<span class="nv">$ </span>asdf plugin list
python

<span class="c"># 查看最新 Python 版本</span>
╰─<span class="nv">$ </span>asdf latest python
3.11.2

<span class="c"># ASDF 安装 Python 3.11.2 (latest)</span>
╰─<span class="nv">$ </span>asdf <span class="nb">install </span>python latest
python-build 3.11.2 /home/ubuntu/.asdf/installs/python/3.11.2
Downloading Python-3.11.2.tar.xz...
-&gt; https://www.python.org/ftp/python/3.11.2/Python-3.11.2.tar.xz
Installing Python-3.11.2...
Installed Python-3.11.2 to /home/ubuntu/.asdf/installs/python/3.11.2

<span class="c"># 查看已安装 Python 版本列表</span>
╰─<span class="nv">$ </span>asdf list
python
  3.11.2
</code></pre></div></div>

<h3 id="使用">使用</h3>

<p>  ASDF 提供全局版本（Global）和本地版本（Local）两种方式定义运行环境版本。全局版本是系统级别的，类似于 PATH 变量中定义的；本地版本则是为了某个代码库或者部分代码准备的，通常在目录中的 <code class="language-plaintext highlighter-rouge">.tool-versions</code> 文件里定义。为了区分全局和本地的效果差别，这里再安装一个指定 Python 版本。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 查询 Python 插件支持的所有版本</span>
╰─<span class="nv">$ </span>asdf list all python
2.1.3
2.2.3
......
stackless-3.7.5

<span class="c"># 安装 Python 3.9.0</span>
╰─<span class="nv">$ </span>asdf <span class="nb">install </span>python 3.9.0
python-build 3.9.0 /home/zhonger/.asdf/installs/python/3.9.0
Downloading Python-3.9.0.tar.xz...
-&gt; https://www.python.org/ftp/python/3.9.0/Python-3.9.0.tar.xz
Installing Python-3.9.0...
patching file Misc/NEWS.d/next/Build/2021-10-11-16-27-38.bpo-45405.iSfdW5.rst
patching file configure
patching file configure.ac
Installed Python-3.9.0 to /home/zhonger/.asdf/installs/python/3.9.0

<span class="c"># 查看已安装 Python 版本列表</span>
╰─<span class="nv">$ </span>asdf list
python
  3.11.2
  3.9.0

<span class="c"># 查看当前系统 Python 及 Python3 版本</span>
╰─<span class="nv">$ </span>python <span class="nt">-V</span>
No python executable found <span class="k">for </span>python system

╰─<span class="nv">$ </span>python3 <span class="nt">-V</span>
Python 3.10.6

<span class="c"># 更改全局版本为 3.11.2 并查看</span>
╰─<span class="nv">$ </span>asdf list
python
 <span class="k">*</span>3.11.2
  3.9.0

╰─<span class="nv">$ </span>python <span class="nt">-V</span>
Python 3.11.2

<span class="c"># 创建子目录指定本地版本并查看</span>
<span class="nb">mkdir </span>py <span class="o">&amp;&amp;</span> <span class="nb">cd </span>py
asdf <span class="nb">local </span>python 3.9.0

╰─<span class="nv">$ </span>python <span class="nt">-V</span>
Python 3.9.0

<span class="c"># 返回父目录查看 Python 版本</span>
╰─<span class="nv">$ </span><span class="nb">cd</span> .. <span class="o">&amp;&amp;</span> python <span class="nt">-V</span>
Python 3.11.2

<span class="c"># 查看当前系统 Python3 版本</span>
╰─<span class="nv">$ </span>python3 <span class="nt">-V</span>
Python 3.10.6
</code></pre></div></div>

<blockquote>
  <p>info “小提示”
  这里有一点比较有趣的是：由于 ASDF 接管的 <code class="language-plaintext highlighter-rouge">python</code> 命令而非 <code class="language-plaintext highlighter-rouge">python3</code> 命令，所以 <code class="language-plaintext highlighter-rouge">python3</code> 命令输出的版本依然还是系统安装版本。</p>
</blockquote>

<h3 id="其他相关">其他相关</h3>

<p>  如果想要恢复到系统指定版本，可以很容易使用 <code class="language-plaintext highlighter-rouge">asdf global python system</code> 命令。当然，对于本地版本，可以使用 <code class="language-plaintext highlighter-rouge">asdf local python system</code> 来实现。除此之外，还有一些常规操作如下。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 查看 Python 指定版本安装位置</span>
╰─<span class="nv">$ </span>asdf where python 3.11.2
/home/zhonger/.asdf/installs/python/3.11.2

<span class="c"># 查看命令所在位置</span>
╰─<span class="nv">$ </span>asdf which python
/home/zhonger/.asdf/installs/python/3.11.2/bin/python

<span class="c"># 查看当前 ASDF 管理的运行环境</span>
╰─<span class="nv">$ </span>asdf current
python          3.11.2          /home/ubuntu/.tool-versions

<span class="c"># 查看全局和本地版本配置文件</span>
╰─<span class="nv">$ </span><span class="nb">cat</span> ~/.tool-versions
python 3.11.2

╰─<span class="nv">$ </span><span class="nb">cat</span> ~/py/.tool-versions
python 3.9.0
</code></pre></div></div>

<h2 id="参考资料">参考资料</h2>

<ul>
  <li><a href="https://asdf-vm.com/zh-hans/guide/getting-started.html">ASDF 官网 - 快速入门</a></li>
  <li><a href="https://asdf-vm.com/zh-hans/manage/versions.html">ASDF 官网 - 版本</a></li>
</ul>
