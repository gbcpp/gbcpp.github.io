<h2 id="前言">前言</h2>

<p>  Docker 具有易迁移、镜像容量小的优势，已被广泛应用于快速应用部署。对于开发者而言，Docker 的这一优势也同样适用于开发环境的快速搭建。因此，具有个性化的 Docker 镜像将会为开发者使用提供更大的便利。笔者习惯在 Mac 或者服务器上使用非 root 的 sudo 用户和 zsh，因此也希望在用于开发环境的 Docker 镜像也有这样的特点。</p>

<p>  为什么要使用非 root 的 sudo 用户，而不直接使用 root 用户？Docker 镜像默认提供的一般都是 root 用户，而所有人想要把应用 Docker 化，在 Docker 镜像中用于运行程序的一般不能是 root 用户。这也是因为如果使用 root 用户的话，应用一旦被他人渗透取得程序执行权限，该 Docker 实例运行的所在宿主机也可能被入侵。因此，大部分开发者都应该养成使用非 root 的 sudo 用户的习惯，既享有 sudo 权限，也要严格控制 Docker 镜像中的权限。</p>

<p>  为什么要使用 zsh 而不使用默认的 bash？一方面的原因是，bash 对于大小写的自动补全比较严格，不会像 zsh 那样可以无视大小写进行自动补全推荐。另一方面的原因是，bash 的历史功能只能在前后命令之间切换，而 zsh 可以根据历史命令进行自动补全推荐从而突破这一限制。当然，zsh 所支持的主题、插件也比较丰富，可以适应不同人的审美和使用需求。</p>

<h2 id="安装配置">安装配置</h2>

<p>  笔者想要构建的开发环境基础 Docker 镜像主要的特点是以上两点，具体来说是：</p>

<ul>
  <li>具有 sudo 权限的非 root 用户：ubuntu</li>
  <li>执行 sudo 命令时不需要输入密码，即免密 sudo</li>
  <li>ubuntu 用户的默认 shell 是 zsh</li>
</ul>

<p>  因此，所对应的 Docker 镜像生成配置文件（Dockerfile）如下所示。</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> ubuntu:latest</span>

<span class="k">LABEL</span><span class="s"> maintainer="zhonger zhonger@live.cn"</span>

<span class="c"># Create a no-passowrd sudo user</span>
<span class="k">RUN </span>apt update <span class="se">\
</span>    <span class="o">&amp;&amp;</span> apt <span class="nb">install</span> <span class="nt">-y</span> <span class="nb">sudo</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> useradd <span class="nt">-m</span> ubuntu <span class="nt">-s</span> /bin/bash <span class="o">&amp;&amp;</span> adduser ubuntu <span class="nb">sudo</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"ubuntu ALL=(ALL) NOPASSWD : ALL"</span> | <span class="nb">tee</span> /etc/sudoers.d/nopasswd4sudo

<span class="c"># Adjust Timezone</span>
<span class="k">ENV</span><span class="s"> DEBIAN_FRONTEND=noninteractive</span>
<span class="k">RUN </span>apt <span class="nb">install</span> <span class="nt">-y</span> tzdata <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">ln</span> <span class="nt">-fs</span> /usr/share/zoneinfo/Asia/Tokyo /etc/localtime

<span class="k">USER</span><span class="s"> ubuntu</span>
<span class="k">WORKDIR</span><span class="s"> /home/ubuntu</span>

<span class="c"># Install zsh</span>
<span class="k">RUN </span><span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> git zsh <span class="se">\
</span>    <span class="o">&amp;&amp;</span> git clone https://github.com/ohmyzsh/ohmyzsh.git ~/.oh-my-zsh <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">cp</span> ~/.oh-my-zsh/templates/zshrc.zsh-template ~/.zshrc <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/robbyrussell/bira/"</span> ~/.zshrc <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>usermod <span class="nt">-s</span> /bin/zsh ubuntu


<span class="c"># Clean apt-cache</span>
<span class="k">RUN </span><span class="nb">sudo </span>apt autoremove <span class="nt">-y</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt clean <span class="nt">-y</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">sudo rm</span> <span class="nt">-rf</span> /var/lib/apt/lists/<span class="k">*</span>

<span class="k">ENTRYPOINT</span><span class="s"> ["/bin/zsh"]</span>
</code></pre></div></div>

<p>  使用以下命令编译生成 Docker 镜像：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build <span class="nb">.</span> <span class="nt">-t</span> zhonger/ubuntu:latest
</code></pre></div></div>

<p>  使用以下命令运行一个 Docker 实例验证：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-ti</span> <span class="nt">-d</span> <span class="nt">--name</span> dev zhonger/ubuntu:latest
docker <span class="nb">exec</span> <span class="nt">-ti</span> dev /bin/zsh
<span class="c"># 登录后看见 zsh 主题即安装配置 zsh 成功</span>

<span class="nb">sudo </span>apt update
<span class="c"># 输入执行命令后立刻执行无需输入密码，表示安装配置免密且具有 sudo 权限的 ubuntu 用户成功</span>
</code></pre></div></div>
