<h2 id="前言">前言</h2>

<p>  <a href="https://jupyter.org/">Jupyter</a>， 想必大家对这个项目都耳熟能详吧。因为能够实时交互、支持异构计算、部署简单、几乎无运维成本，所以得到了很多人的青睐。笔者的身边也有很多从事科学研究的人选择了 Jupyter 作为编写 Python 的工具，当然也有一部分人选择了 <a href="https://www.jetbrains.com/pycharm/">PyCharm</a>。不过笔者还是比较喜欢 <a href="https://code.visualstudio.com/">VS Code</a>，简单的纯文本编辑功能，利用丰富的插件市场来添加各种想要的功能，无缝支持远程开发，简直就是理想中的编辑器了。但是，今天还是要来考虑一下 Jupyter，毕竟 JupyterLab 的服务功能也是非常强大的。</p>

<p>  在 Jupyter 出现之前，也有可以替代 Python 自带的 Python Shell 的 <a href="https://ipython.org/">IPython</a>。笔者在早期也曾使用过，体验还不错。其实，Jupyter 就是2014 年从 IPython 中衍生出来的，所以从 IPython 过渡到 Jupyter 毫无困难。如果说 IPython 是为了 Python 而量身定制的话，那么 Jupyter 则是为包括 Julia、Python、R 在内的几十种编程语言（<a href="https://github.com/jupyter/jupyter/wiki/Jupyter-kernels">详情连接</a>）的交互式数据科学和科学计算而生的。</p>

<p>  早期的 Jupyter 只包含 Jupyter Kernels 和 Jupyter Notebook，其中 Jupyter Kernels 是用于支持编程语言的内核，Jupyter Notebook 是基于 Web 的交互式计算环境，前身是 IPython Notebook。现在的 Jupyter 除了这两者以外还有 JupyterHub、JupyterHub API 和 JupyterLab。JupyterHub 是一个用于 Jupyter Notebook 的多用户服务器。它通过生成、管理和代理许多单一的 Jupyter Notebook 服务器来支持多用户。JupyterHub API 是以 REST 风格向开发者们提供的 API 接口，可以完成一系列对 Jupyter 的操作，比如生成用户环境、配置环境等。JupyterLab 号称是 Jupyter 项目的下一代用户界面，它以一个灵活且强大的用户界面向用户提供经典的 Jupyter Notebook、终端、编辑器、文件浏览器、丰富输出等模块，俨然像是朝着现代化的理想编辑器的目标进发的。</p>

<p>  无论之前的 Jupyter 是什么样子，现在的 JupyterLab 已经是和曾经的 Cloud9 （一款先进的在线代码编辑器，现已被 AWS 收购）一样的支持多用户多实例的代码运行平台。对于从事科学研究的团队来说，使用 JupyterLab 搭建一个内部科学计算平台成为了可能。当然，个人用户还是可以选择使用 Anaconda 或者 PIP 来安装单用户版本。</p>

<h2 id="搭建">搭建</h2>

<p>  说到搭建平台自然而然想到了使用 Docker，既可以保证用户对自己所需的软件或环境可以修改，又保证不同用户之间互不干扰、宿主机与 Jupyter 之间互不干扰。虽说 Jupyter 官方提供了一个使用 Docker 来部署 Jupyter 各个产品的 <a href="https://jupyter-docker-stacks.readthedocs.io/">文档网站</a>，但不得不说即使看了这个文档也很难搞清楚到底怎么部署一套 JupyterLab。可能唯一有用的就是 Jupyter 官方提供的镜像构建 <a href="https://github.com/jupyter/docker-stacks">Dockerfile 集合</a> 吧。</p>

<p>  JupyterLab 提供两种方式启动多用户多实例：</p>

<ul>
  <li><strong>DockerSpawner 方式</strong>：每个用户独享一个 Docker 实例，能有效隔离用户。</li>
  <li><strong>SystemSpawner 方式</strong>：共享同一个 Docker 实例，以系统用户身份运行。</li>
</ul>

<p>  事实上，既然我们选择了用 Docker 来部署，自然而然应该选择 DockerSpawner 方式了。JupyterLab 中主要实现多用户多实例功能的是 JupyterHub 模块（如下图）。JupyterHub 模块为整个 JupyterLab 对外提供了一个共同的 HTTP 接口，并可以进行用户鉴权和为通过鉴权的用户创建一个新的 Docker 实例。笔者在这里主要是使用 Gitlab 方式鉴权登录，图中涉及到 Admin 以及数据库这里不作探讨。</p>

<p><img src="https://i.lisz.top/blog/Uibi3q.webp" alt="架构图 JupyterHub Design" /></p>

<p>  以下为搭建所需的文件的列表：</p>

<p><img src="https://i.lisz.top/blog/tU3EqP.webp" alt="文件列表 Files" /></p>

<h3 id="构建-jupyter-notebook-实例镜像">构建 Jupyter Notebook 实例镜像</h3>

<h4 id="基础镜像-base-notebook">基础镜像 base-notebook</h4>

<p>  这里的基础镜像可以根据需要自行选择，与 <a href="https://github.com/jupyter/docker-stacks/tree/master/base-notebook">jupyter/docker-stacks</a> 相比镜像构建 Dockerfile 有些内容做了修改，本目录下其他文件和 <a href="https://github.com/jupyter/docker-stacks/tree/master/base-notebook">base-notebook 目录</a> 一致。</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Dockerfile</span>
<span class="k">ARG</span><span class="s"> ROOT_CONTAINER=nvidia/cuda:10.2-devel-ubuntu18.04</span>

<span class="k">ARG</span><span class="s"> BASE_CONTAINER=$ROOT_CONTAINER</span>
<span class="k">FROM</span><span class="s"> $BASE_CONTAINER</span>

<span class="k">ARG</span><span class="s"> NB_USER="ubuntu"</span>
<span class="k">ARG</span><span class="s"> NB_UID="1000"</span>
<span class="k">ARG</span><span class="s"> NB_GID="100"</span>

<span class="c"># Fix DL4006</span>
<span class="k">SHELL</span><span class="s"> ["/bin/bash", "-o", "pipefail", "-c"]</span>

<span class="k">USER</span><span class="s"> root</span>

<span class="c"># Install all OS dependencies for notebook server that starts but lacks all</span>
<span class="c"># features (e.g., download as all possible file formats)</span>
<span class="k">ENV</span><span class="s"> DEBIAN_FRONTEND noninteractive</span>
<span class="k">RUN </span>apt-get update <span class="se">\
</span>    <span class="o">&amp;&amp;</span> apt-get <span class="nb">install</span> <span class="nt">-yq</span> <span class="nt">--no-install-recommends</span> wget htop vim bzip2 ca-certificates <span class="nb">sudo </span>locales fonts-liberation run-one <span class="se">\
</span>    <span class="o">&amp;&amp;</span> apt-get clean <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">rm</span> <span class="nt">-rf</span> /var/lib/apt/lists/<span class="k">*</span>

<span class="k">RUN </span><span class="nb">echo</span> <span class="s2">"en_US.UTF-8 UTF-8"</span> <span class="o">&gt;</span> /etc/locale.gen <span class="o">&amp;&amp;</span> <span class="se">\
</span>    locale-gen

<span class="c"># Configure environment</span>
<span class="k">ENV</span><span class="s"> CONDA_DIR=/opt/conda \</span>
    SHELL=/bin/bash \
    NB_USER=$NB_USER \
    NB_UID=$NB_UID \
    NB_GID=$NB_GID \
    LC_ALL=en_US.UTF-8 \
    LANG=en_US.UTF-8 \
    LANGUAGE=en_US.UTF-8
<span class="k">ENV</span><span class="s"> PATH=$CONDA_DIR/bin:$PATH \</span>
    HOME=/home/$NB_USER

<span class="c"># Copy a script that we will use to correct permissions after running certain commands</span>
<span class="k">COPY</span><span class="s"> fix-permissions /usr/local/bin/fix-permissions</span>
<span class="k">RUN </span><span class="nb">chmod </span>a+rx /usr/local/bin/fix-permissions

<span class="c"># Enable prompt color in the skeleton .bashrc before creating the default NB_USER</span>
<span class="k">RUN </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/^#force_color_prompt=yes/force_color_prompt=yes/'</span> /etc/skel/.bashrc

<span class="c"># Create NB_USER wtih name ubuntu user with UID=1000 and in the 'users' group</span>
<span class="c"># and make sure these dirs are writable by the `users` group.</span>
<span class="k">RUN </span><span class="nb">echo</span> <span class="s2">"auth requisite pam_deny.so"</span> <span class="o">&gt;&gt;</span> /etc/pam.d/su <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">sed</span> <span class="nt">-i</span>.bak <span class="nt">-e</span> <span class="s1">'s/^%admin/#%admin/'</span> /etc/sudoers <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">sed</span> <span class="nt">-i</span>.bak <span class="nt">-e</span> <span class="s1">'s/^%sudo/#%sudo/'</span> /etc/sudoers <span class="se">\
</span>    <span class="o">&amp;&amp;</span> useradd <span class="nt">-m</span> <span class="nt">-s</span> /bin/bash <span class="nt">-N</span> <span class="nt">-u</span> <span class="nv">$NB_UID</span> <span class="nv">$NB_USER</span> <span class="nt">-g</span> <span class="nv">$NB_GID</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$CONDA_DIR</span> <span class="se">\
</span>    <span class="c"># &amp;&amp; chown $NB_USER:$NB_GID  </span><span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">chmod </span>g+w /etc/passwd <span class="se">\
</span>    <span class="o">&amp;&amp;</span> fix-permissions <span class="nv">$HOME</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> fix-permissions <span class="nv">$CONDA_DIR</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> adduser ubuntu <span class="nb">sudo</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"ubuntu ALL=(ALL) NOPASSWD : ALL"</span> | <span class="nb">tee</span> /etc/sudoers.d/nopasswd4sudo

<span class="k">USER</span><span class="s"> $NB_UID</span>
<span class="k">WORKDIR</span><span class="s"> $HOME</span>
<span class="k">ARG</span><span class="s"> PYTHON_VERSION=default</span>

<span class="c"># Setup work directory for backward-compatibility</span>
<span class="k">RUN </span><span class="nb">mkdir</span> /home/<span class="nv">$NB_USER</span>/work <span class="o">&amp;&amp;</span> <span class="se">\
</span>    fix-permissions /home/<span class="nv">$NB_USER</span>

<span class="c"># Install conda as ubuntu and check the md5 sum provided on the download site</span>
<span class="k">ENV</span><span class="s"> MINICONDA_VERSION=4.9.2 \</span>
    MINICONDA_MD5=122c8c9beb51e124ab32a0fa6426c656 \
    CONDA_VERSION=4.9.2

<span class="k">WORKDIR</span><span class="s"> /tmp</span>
<span class="k">RUN </span>wget <span class="nt">--quiet</span> https://repo.continuum.io/miniconda/Miniconda3-py38_<span class="k">${</span><span class="nv">MINICONDA_VERSION</span><span class="k">}</span><span class="nt">-Linux-x86_64</span>.sh  <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"</span><span class="k">${</span><span class="nv">MINICONDA_MD5</span><span class="k">}</span><span class="s2"> *Miniconda3-py38_</span><span class="k">${</span><span class="nv">MINICONDA_VERSION</span><span class="k">}</span><span class="s2">-Linux-x86_64.sh"</span> | <span class="nb">md5sum</span> <span class="nt">-c</span> -  <span class="se">\
</span>    <span class="o">&amp;&amp;</span> /bin/bash Miniconda3-py38_<span class="k">${</span><span class="nv">MINICONDA_VERSION</span><span class="k">}</span><span class="nt">-Linux-x86_64</span>.sh <span class="nt">-f</span> <span class="nt">-b</span> <span class="nt">-p</span> <span class="nv">$CONDA_DIR</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">rm </span>Miniconda3-py38_<span class="k">${</span><span class="nv">MINICONDA_VERSION</span><span class="k">}</span><span class="nt">-Linux-x86_64</span>.sh <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"conda </span><span class="k">${</span><span class="nv">CONDA_VERSION</span><span class="k">}</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> <span class="nv">$CONDA_DIR</span>/conda-meta/pinned <span class="se">\
</span>    <span class="o">&amp;&amp;</span> conda config <span class="nt">--system</span> <span class="nt">--prepend</span> channels conda-forge <span class="se">\
</span>    <span class="o">&amp;&amp;</span> conda config <span class="nt">--system</span> <span class="nt">--set</span> auto_update_conda <span class="nb">false</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> conda config <span class="nt">--system</span> <span class="nt">--set</span> show_channel_urls <span class="nb">true</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> conda config <span class="nt">--system</span> <span class="nt">--set</span> channel_priority strict <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nv">$PYTHON_VERSION</span> <span class="o">=</span> <span class="s1">'default'</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span>conda <span class="nb">install</span> <span class="nt">--yes</span> <span class="nv">python</span><span class="o">=</span><span class="nv">$PYTHON_VERSION</span><span class="p">;</span> <span class="k">fi</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> conda list python | <span class="nb">grep</span> <span class="s1">'^python '</span> | <span class="nb">tr</span> <span class="nt">-s</span> <span class="s1">' '</span> | <span class="nb">cut</span> <span class="nt">-d</span> <span class="s1">'.'</span> <span class="nt">-f</span> 1,2 | <span class="nb">sed</span> <span class="s1">'s/$/.*/'</span> <span class="o">&gt;&gt;</span> <span class="nv">$CONDA_DIR</span>/conda-meta/pinned <span class="se">\
</span>    <span class="o">&amp;&amp;</span> conda <span class="nb">install</span> <span class="nt">--quiet</span> <span class="nt">--yes</span> conda <span class="se">\
</span>    <span class="o">&amp;&amp;</span> conda <span class="nb">install</span> <span class="nt">--quiet</span> <span class="nt">--yes</span> pip <span class="se">\
</span>    <span class="o">&amp;&amp;</span> conda update <span class="nt">--all</span> <span class="nt">--quiet</span> <span class="nt">--yes</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> conda clean <span class="nt">--all</span> <span class="nt">-f</span> <span class="nt">-y</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">rm</span> <span class="nt">-rf</span> /home/<span class="nv">$NB_USER</span>/.cache/yarn <span class="se">\
</span>    <span class="o">&amp;&amp;</span> fix-permissions <span class="nv">$CONDA_DIR</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> fix-permissions /home/<span class="nv">$NB_USER</span>

<span class="c"># Install Tini</span>
<span class="k">RUN </span>conda <span class="nb">install</span> <span class="nt">--quiet</span> <span class="nt">--yes</span> <span class="s1">'tini=0.18.0'</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> conda list tini | <span class="nb">grep </span>tini | <span class="nb">tr</span> <span class="nt">-s</span> <span class="s1">' '</span> | <span class="nb">cut</span> <span class="nt">-d</span> <span class="s1">' '</span> <span class="nt">-f</span> 1,2 <span class="o">&gt;&gt;</span> <span class="nv">$CONDA_DIR</span>/conda-meta/pinned <span class="se">\
</span>    <span class="o">&amp;&amp;</span> conda clean <span class="nt">--all</span> <span class="nt">-f</span> <span class="nt">-y</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> fix-permissions <span class="nv">$CONDA_DIR</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> fix-permissions /home/<span class="nv">$NB_USER</span>

<span class="c"># Install Jupyter Notebook, Lab, and Hub</span>
<span class="c"># Generate a notebook server config</span>
<span class="c"># Cleanup temporary files</span>
<span class="c"># Correct permissions</span>
<span class="c"># Do all this in a single RUN command to avoid duplicating all of the</span>
<span class="c"># files across image layers when the permissions change</span>
<span class="k">RUN </span>conda <span class="nb">install</span> <span class="nt">--quiet</span> <span class="nt">--yes</span> <span class="se">\
</span>    <span class="s1">'notebook=6.4.0'</span> <span class="se">\
</span>    <span class="s1">'jupyterhub=1.4.2'</span> <span class="se">\
</span>    <span class="s1">'jupyterlab=3.0.16'</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> conda clean <span class="nt">--all</span> <span class="nt">-f</span> <span class="nt">-y</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> npm <span class="nb">install</span> <span class="nt">-g</span> npm@7.20.0 <span class="se">\
</span>    <span class="o">&amp;&amp;</span> npm cache clean <span class="nt">--force</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> jupyter notebook <span class="nt">--generate-config</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">rm</span> <span class="nt">-rf</span> <span class="nv">$CONDA_DIR</span>/share/jupyter/lab/staging <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">rm</span> <span class="nt">-rf</span> /home/<span class="nv">$NB_USER</span>/.cache/yarn <span class="se">\
</span>    <span class="o">&amp;&amp;</span> fix-permissions <span class="nv">$CONDA_DIR</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> fix-permissions /home/<span class="nv">$NB_USER</span>

<span class="k">EXPOSE</span><span class="s"> 8888</span>

<span class="c"># Configure container startup</span>
<span class="k">ENTRYPOINT</span><span class="s"> ["tini", "-g", "--"]</span>
<span class="k">CMD</span><span class="s"> ["start-notebook.sh"]</span>

<span class="c"># Copy local files as late as possible to avoid cache busting</span>
<span class="k">COPY</span><span class="s"> start.sh start-notebook.sh start-singleuser.sh /usr/local/bin/</span>
<span class="k">COPY</span><span class="s"> jupyter_notebook_config.py /etc/jupyter/</span>

<span class="c"># Fix permissions on /etc/jupyter as root</span>
<span class="k">USER</span><span class="s"> root</span>
<span class="k">RUN </span>fix-permissions /etc/jupyter/
<span class="k">RUN </span><span class="nb">chmod</span> +x /usr/local/bin/start-notebook.sh /usr/local/bin/start-singleuser.sh /usr/local/bin/start.sh

<span class="c"># Switch back to ubuntu to avoid accidental container runs as root</span>
<span class="k">USER</span><span class="s"> $NB_UID</span>

<span class="k">WORKDIR</span><span class="s"> $HOME</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build <span class="nt">-t</span> base-notebook:latest <span class="nb">.</span>
</code></pre></div></div>

<h4 id="单用户镜像-singleuser">单用户镜像 singleuser</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Dockerfile</span>
<span class="s">ARG BASE_IMAGE=base-notebook:latest</span>
<span class="s">FROM $BASE_IMAGE</span>

<span class="s">ADD install_jupyterhub /tmp/install_jupyterhub</span>
<span class="s">ARG JUPYTERHUB_VERSION=master</span>
<span class="c1"># install pinned jupyterhub and ensure notebook is installed</span>
<span class="s">RUN </span><span class="kc">true</span><span class="s"> &amp;&amp; \</span>
    <span class="s">python3 -m pip install notebook jupyterhub</span>
</code></pre></div></div>

<p>  install_jupyterhub 脚本文件</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span><span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">subprocess</span> <span class="kn">import</span> <span class="n">check_call</span>
<span class="kn">import</span> <span class="n">sys</span>

<span class="n">V</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">'</span><span class="s">JUPYTERHUB_VERSION</span><span class="sh">'</span><span class="p">]</span>

<span class="n">pip_install</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">sys</span><span class="p">.</span><span class="n">executable</span><span class="p">,</span> <span class="sh">'</span><span class="s">-m</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">pip</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">install</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">--no-cache</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">--upgrade</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">--upgrade-strategy</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">only-if-needed</span><span class="sh">'</span><span class="p">,</span>
<span class="p">]</span>
<span class="k">if</span> <span class="n">V</span> <span class="o">==</span> <span class="sh">'</span><span class="s">master</span><span class="sh">'</span><span class="p">:</span>
    <span class="n">req</span> <span class="o">=</span> <span class="sh">'</span><span class="s">https://github.com/jupyterhub/jupyterhub/archive/master.tar.gz</span><span class="sh">'</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">version_info</span> <span class="o">=</span> <span class="p">[</span> <span class="nf">int</span><span class="p">(</span><span class="n">part</span><span class="p">)</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">V</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">.</span><span class="sh">'</span><span class="p">)</span> <span class="p">]</span>
    <span class="n">version_info</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">upper_bound</span> <span class="o">=</span> <span class="sh">'</span><span class="s">.</span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">version_info</span><span class="p">))</span>
    <span class="n">vs</span> <span class="o">=</span> <span class="sh">'</span><span class="s">&gt;=%s,&lt;%s</span><span class="sh">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">upper_bound</span><span class="p">)</span>
    <span class="n">req</span> <span class="o">=</span> <span class="sh">'</span><span class="s">jupyterhub%s</span><span class="sh">'</span> <span class="o">%</span> <span class="n">vs</span>

<span class="nf">check_call</span><span class="p">(</span><span class="n">pip_install</span> <span class="o">+</span> <span class="p">[</span><span class="n">req</span><span class="p">])</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build <span class="nt">-t</span> singleuser:latest <span class="nb">.</span>
</code></pre></div></div>

<h4 id="jupyterlab-单用户镜像-jupyter_lab_singleuser">JupyterLab 单用户镜像 jupyter_lab_singleuser</h4>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ARG</span><span class="s"> BASE_IMAGE=singleuser:latest</span>
<span class="k">FROM</span><span class="s"> ${BASE_IMAGE}</span>

<span class="c"># Install jupyterlab</span>
<span class="k">RUN </span>conda update <span class="nt">-n</span> base conda <span class="se">\
</span>    <span class="o">&amp;&amp;</span> conda <span class="nb">install</span> <span class="nt">-c</span> conda-forge jupyterlab
<span class="k">RUN </span>jupyter serverextension <span class="nb">enable</span> <span class="nt">--py</span> jupyterlab <span class="nt">--sys-prefix</span>
<span class="k">USER</span><span class="s"> root</span>
<span class="k">RUN </span>chpasswd <span class="o">&lt;&lt;&lt;</span> <span class="s2">"ubuntu:ubuntu"</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/http:\/\/archive.ubuntu.com/https:\/\/mirrors.sjtug.sjtu.edu.cn/g'</span> /etc/apt/sources.list <span class="se">\
</span>    <span class="o">&amp;&amp;</span> apt update <span class="se">\
</span>    <span class="o">&amp;&amp;</span> apt <span class="nb">install</span> <span class="nt">-y</span> git zsh vim <span class="se">\
</span>    <span class="o">&amp;&amp;</span> usermod <span class="nt">-s</span> /bin/zsh ubuntu <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s1">'chown -R ubuntu:users /home/ubuntu/work'</span> <span class="o">&gt;&gt;</span> /usr/local/bin/start-notebook.sh

<span class="c"># Add supports for zsh and zh-CN language</span>
<span class="k">USER</span><span class="s"> ubuntu</span>
<span class="k">RUN </span>git clone https://gitee.com/mirrors/oh-my-zsh.git ~/.oh-my-zsh <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">cp</span> ~/.oh-my-zsh/templates/zshrc.zsh-template ~/.zshrc <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/robbyrussell/bira/"</span> ~/.zshrc <span class="se">\
</span>    <span class="o">&amp;&amp;</span> wget <span class="nt">-c</span> https://jfds-1252952517.cos.ap-chengdu.myqcloud.com/jupyterhub/jupyterlab_language_pack_zh_CN-0.0.1.dev0-py2.py3-none-any.whl <span class="se">\
</span>    <span class="o">&amp;&amp;</span> pip <span class="nb">install </span>jupyterlab_language_pack_zh_CN-0.0.1.dev0-py2.py3-none-any.whl <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">rm </span>jupyterlab_language_pack_zh_CN-0.0.1.dev0-py2.py3-none-any.whl
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build <span class="nt">-t</span> jupyter_lab_single:latest <span class="nb">.</span>
</code></pre></div></div>

<h3 id="构建-jupyterhub-镜像">构建 JupyterHub 镜像</h3>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Dockerfile</span>

<span class="k">ARG</span><span class="s"> BASE_IMAGE=jupyterhub/jupyterhub:latest</span>
<span class="k">FROM</span><span class="s"> ${BASE_IMAGE}</span>

<span class="k">RUN </span>pip <span class="nb">install</span> <span class="nt">--no-cache</span> <span class="nt">--upgrade</span> jupyter <span class="se">\
</span>    <span class="o">&amp;&amp;</span> pip <span class="nb">install</span> <span class="nt">--no-cache</span> dockerspawner <span class="se">\
</span>    <span class="o">&amp;&amp;</span> pip <span class="nb">install</span> <span class="nt">--no-cache</span> oauthenticator
<span class="k">EXPOSE</span><span class="s"> 8000</span>
</code></pre></div></div>

<p>  这里配置挂载的本地目录为根据用户名而区分的目录，当 Gitlab 用户名中包含 <code class="language-plaintext highlighter-rouge">-</code> 时，<code class="language-plaintext highlighter-rouge">-</code> 会被转义为 <code class="language-plaintext highlighter-rouge">2d</code>。另外，这里的本地目录需要预先建立好，否则由于 Docker 自身的安全性而新建立的目录的所有者会是 root 用户，这样就不能够正常使用该目录。以下配置文件需放置在 docker-compose.yml 的同层目录 data 里面。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># jupyterhub_config.py
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">oauthenticator.gitlab</span> <span class="kn">import</span> <span class="n">GitLabOAuthenticator</span>
<span class="n">c</span><span class="p">.</span><span class="n">JupyterHub</span><span class="p">.</span><span class="n">authenticator_class</span> <span class="o">=</span> <span class="n">GitLabOAuthenticator</span>
<span class="n">c</span><span class="p">.</span><span class="n">GitLabOAuthenticator</span><span class="p">.</span><span class="n">oauth_callback_url</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">GITLAB_OAUTH_CALLBACK</span><span class="sh">"</span><span class="p">)</span>
<span class="n">c</span><span class="p">.</span><span class="n">GitLabOAuthenticator</span><span class="p">.</span><span class="n">client_id</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">GITLAB_API_CLIENT</span><span class="sh">"</span><span class="p">)</span>
<span class="n">c</span><span class="p">.</span><span class="n">GitLabOAuthenticator</span><span class="p">.</span><span class="n">client_secret</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">GITLAB_API_KEY</span><span class="sh">"</span><span class="p">)</span>

<span class="n">c</span><span class="p">.</span><span class="n">JupyterHub</span><span class="p">.</span><span class="n">spawner_class</span> <span class="o">=</span> <span class="sh">'</span><span class="s">dockerspawner.DockerSpawner</span><span class="sh">'</span>
<span class="n">c</span><span class="p">.</span><span class="n">DockerSpawner</span><span class="p">.</span><span class="n">image</span> <span class="o">=</span> <span class="sh">'</span><span class="s">jupyter_lab_singleuser:latest</span><span class="sh">'</span>
<span class="n">c</span><span class="p">.</span><span class="n">DockerSpawner</span><span class="p">.</span><span class="n">environment</span> <span class="o">=</span> <span class="p">{</span>
  <span class="sh">'</span><span class="s">GRANT_SUDO</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">1</span><span class="sh">'</span><span class="p">,</span>
  <span class="sh">'</span><span class="s">UID</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">0</span><span class="sh">'</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">c</span><span class="p">.</span><span class="n">DockerSpawner</span><span class="p">.</span><span class="n">extra_create_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">user</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">ubuntu</span><span class="sh">'</span><span class="p">}</span>
<span class="n">c</span><span class="p">.</span><span class="n">DockerSpawner</span><span class="p">.</span><span class="n">extra_create_kwargs</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span> <span class="sh">'</span><span class="s">command</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">start-singleuser.sh --SingleUserNotebookApp.default_url=/lab</span><span class="sh">"</span> <span class="p">})</span>
<span class="c1"># Mount the real user's Docker volume on the host to the notebook user's
# notebook directory in the container
</span><span class="n">notebook_dir</span> <span class="o">=</span> <span class="sh">'</span><span class="s">/home/ubuntu/work</span><span class="sh">'</span>
<span class="n">c</span><span class="p">.</span><span class="n">DockerSpawner</span><span class="p">.</span><span class="n">notebook_dir</span> <span class="o">=</span> <span class="n">notebook_dir</span>
<span class="n">c</span><span class="p">.</span><span class="n">DockerSpawner</span><span class="p">.</span><span class="n">volumes</span> <span class="o">=</span> <span class="p">{</span> <span class="sh">'</span><span class="s">/home/data/jupyterhub/user-data-{username}</span><span class="sh">'</span><span class="p">:</span> <span class="n">notebook_dir</span> <span class="p">}</span>
<span class="n">c</span><span class="p">.</span><span class="n">DockerSpawner</span><span class="p">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">--allow-root</span><span class="sh">'</span><span class="p">]</span>
<span class="n">c</span><span class="p">.</span><span class="n">DockerSpawner</span><span class="p">.</span><span class="n">remove_containers</span> <span class="o">=</span> <span class="bp">True</span>

<span class="c1">#network
</span><span class="n">network_name</span> <span class="o">=</span> <span class="sh">'</span><span class="s">jupyterhub_network</span><span class="sh">'</span>
<span class="n">c</span><span class="p">.</span><span class="n">DockerSpawner</span><span class="p">.</span><span class="n">use_internal_ip</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">c</span><span class="p">.</span><span class="n">DockerSpawner</span><span class="p">.</span><span class="n">network_name</span> <span class="o">=</span> <span class="n">network_name</span>
<span class="c1"># Pass the network name as argument to spawned containers
</span><span class="n">c</span><span class="p">.</span><span class="n">DockerSpawner</span><span class="p">.</span><span class="n">extra_host_config</span> <span class="o">=</span> <span class="p">{</span> <span class="sh">'</span><span class="s">network_mode</span><span class="sh">'</span><span class="p">:</span> <span class="n">network_name</span> <span class="p">}</span>

<span class="c1"># IP Configurations
</span><span class="n">c</span><span class="p">.</span><span class="n">JupyterHub</span><span class="p">.</span><span class="n">hub_ip</span>  <span class="o">=</span> <span class="sh">'</span><span class="s">172.18.0.2</span><span class="sh">'</span>
<span class="c1">#c.JupyterHub.port = 8000
</span></code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2'</span>
<span class="na">services</span><span class="pi">:</span>
    <span class="na">jupyterhub</span><span class="pi">:</span>
        <span class="na">container_name</span><span class="pi">:</span> <span class="s">jupyterlab</span>
        <span class="na">restart</span><span class="pi">:</span> <span class="s">always</span>
        <span class="na">build</span><span class="pi">:</span> <span class="s">./</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">jupyterhub:latest</span>
        <span class="na">ports</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">8000:8000"</span>
        <span class="na">volumes</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">/var/run/docker.sock:/var/run/docker.sock</span>
            <span class="pi">-</span> <span class="s">./data/jupyterhub_config.py:/srv/jupyterhub/jupyterhub_config.py</span>
        <span class="na">networks</span><span class="pi">:</span>
            <span class="na">network</span><span class="pi">:</span>
                <span class="na">ipv4_address</span><span class="pi">:</span> <span class="s">172.18.0.2</span>
        <span class="na">environment</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">GITLAB_HOST=https://{Gitlab Domain}</span>
            <span class="pi">-</span> <span class="s">GITLAB_API_CLIENT=xxxxxx</span>
            <span class="pi">-</span> <span class="s">GITLAB_API_KEY=xxxxxx</span>
            <span class="pi">-</span> <span class="s">GITLAB_OAUTH_CALLBACK=https://{JupyterHub Domain}/hub/oauth_callback</span>
<span class="na">networks</span><span class="pi">:</span>
    <span class="na">network</span><span class="pi">:</span>
        <span class="na">driver</span><span class="pi">:</span> <span class="s">bridge</span>
        <span class="na">ipam</span><span class="pi">:</span>
            <span class="na">driver</span><span class="pi">:</span> <span class="s">default</span>
            <span class="na">config</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="na">subnet</span><span class="pi">:</span> <span class="s">172.18.0.0/24</span>
                  <span class="na">gateway</span><span class="pi">:</span> <span class="s">172.18.0.1</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose up <span class="nt">-d</span>
</code></pre></div></div>

<h2 id="测试">测试</h2>

<p>  访问 <code class="language-plaintext highlighter-rouge">https://{JupyterHub Domain}/</code> 即可，点击登录按钮后跳转到 Gitlab 登录页，如果 Gitlab 已登录会自动跳回。</p>

<h2 id="参考资料">参考资料</h2>

<ul>
  <li><a href="https://zh.wikipedia.org/wiki/Jupyter">Jupyter - 维基百科</a></li>
  <li><a href="http://zsduo.com/archives/244.html">JupyterLab 3.0 正式发布，同时解决中文语言包下载不成功，汉化不成功的问题，jupyterlab-language-pack-zh-CN 安装失败解决方案</a></li>
  <li><a href="https://cyfeng.science/2021/01/15/jupyterlab-error-when-install-chinses-language-pack/">Jupyterlab 安装中文语言包失败</a></li>
  <li><a href="https://zhuanlan.zhihu.com/p/258724435">使用JupyterHub向多用户提供jupyter服务的思路</a></li>
  <li><a href="https://www.kaifa99.com/GitHub/article_117797">dockerspawner, 在 Docker 容器中，生成JupyterHub单用户服务器</a></li>
</ul>
