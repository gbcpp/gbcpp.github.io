<h2 id="前言">前言</h2>

<p>  Docker 镜像是否有 SSH 远程登录的必要？这个问题其实对于开发者来说是相对而言的，在实际的生产环境中是无必要需求就不必要，而在开发环境中则显得大有裨益。当然，即使在开发环境中也仍然应该把安全性放在首位，因此采用凭一对公钥和私钥实现无密码登录是比较安全、稳妥的办法。</p>

<h2 id="安装配置">安装配置</h2>

<p>  公钥文件的导入是这项任务的重点。一般来说，可能会有人想要以固定文件的形式写入到 Docker 镜像中，这样一来根据这个镜像启动的所有实例都将包含所需的公钥文件。但这样明显的缺点也是无法进行修改，不便于其他人复用这个 Docker 镜像。有一个叫 ssh-import-id 的工具，可以帮助我们实现这一目标。只要你在 Github 上有账户且已导入公钥，都可以通过 ssh-import-id 工具从 Github 中导入指定用户名的公钥。</p>

<p>  Dockerfile 文件如下所示：</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> zhonger/ubuntu:latest</span>

<span class="k">LABEL</span><span class="s"> maintainer="zhonger zhonger@live.cn"</span>

<span class="c"># Install ssh-import-id tool</span>
<span class="k">RUN </span><span class="nb">sudo </span>apt update <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> ssh-import-id 
    
<span class="c"># Clean apt-cache</span>
<span class="k">RUN </span><span class="nb">sudo </span>apt autoremove <span class="nt">-y</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt clean <span class="nt">-y</span> <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">sudo rm</span> <span class="nt">-rf</span> /var/lib/apt/lists/<span class="k">*</span>

<span class="k">ADD</span><span class="s"> entrypoint.sh /entrypoint.sh</span>

<span class="k">ENTRYPOINT</span><span class="s"> ["/entrypoint.sh"]</span>
</code></pre></div></div>

<p>  文件 entrypoint.sh 内容如下：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
ssh-import-id gh:<span class="nv">$GITHUB_NAME</span>
<span class="nb">sudo </span>service ssh restart
/bin/zsh
</code></pre></div></div>

<h3 id="运行">运行</h3>

<h4 id="方式一">方式一</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-ti</span> <span class="nt">-d</span> <span class="nt">-e</span> <span class="nv">GITHUB_NAME</span><span class="o">=</span><span class="s2">"zhonger"</span> <span class="nt">--restart</span><span class="o">=</span>always <span class="nt">--name</span> dev zhonger/ubuntu:ssh
</code></pre></div></div>

<h4 id="方式二">方式二</h4>

<p>  docker-compose.yml 文件如下：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3.9"</span>
<span class="na">services</span><span class="pi">:</span>

  <span class="na">conquest</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">zhonger/ubuntu:ssh</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">dev</span>
    <span class="na">environment</span><span class="pi">:</span>
     <span class="pi">-</span> <span class="s">GITHUB_NAME=zhonger</span>
    <span class="na">stdin_open</span><span class="pi">:</span> <span class="kc">true</span>
    <span class="na">tty</span><span class="pi">:</span> <span class="kc">true</span>
    <span class="na">volumes</span><span class="pi">:</span>
     <span class="pi">-</span> <span class="s">~/web/test:/home/ubuntu/test</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">always</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose up <span class="nt">-d</span>
docker inspect dev <span class="c"># 查看 ip</span>
ssh ubuntu@&lt;instance ip&gt; <span class="c"># 尝试登陆验证</span>
</code></pre></div></div>
