<h2 id="nextcloud-简介">Nextcloud 简介</h2>

<p>  今年来，国内众多免费网盘相继倒下，于是大家都转投了百度网盘门下，然而这只独角兽限速倒逼开通会员下载速度依旧很难改善，还能维持多久也一直都是一个未知数。也有部分人开始涌向国外的有免费额度的网盘，比如以前以数据安全保障出名的 <a href="https://mgea.nz">Mega</a> （由于核心人员出走最近好像也不行了）、微软的 <a href="https://onedrive.live.com">OneDrive</a>、老牌网盘 <a href="https://www.dropbox.com">Dropbox</a>、<a href="https://box.com">Box</a>、谷家的 <a href="https://drive.google.com">Google drive</a>（除了微软的网盘其他几个网速都不怎么好）。在这么多产品中，一个计算机技术人员却难以选择一款合适的网盘，于是用 VPS 和对象存储搭建自托管的方案开始成为一种可行的方案。Nextcloud 就是这样一款网盘，来源于 Owncloud 却较之更加强大、安全（集成 Office 文档、图片相册、日历、RSS 阅读，几乎等同于一个私有的 Dropbox），搭建也是非常简单，适合大部分技术栈的技术人员。当然，此处先谈如何搭建 Nextcloud，至于结合对象存储下回再说。</p>

<p>  Docker 部署软件的好处我就不多提了：简单、高效，极其适合运维人员的应用管理工具。下面就先谈使用 Docker 一键搭建 Nextcloud。</p>

<h3 id="安装-docker-环境">安装 Docker 环境</h3>

<p>  请移步 <a href="/tech/docker-init.html">《Docker 入门》</a></p>

<h3 id="安装-docker-compose-工具">安装 docker-compose 工具</h3>

<p>  docker-compose 是一个由 Docker 官方提供的应用多容器搭配管理工具，适合一个应用需要多个容器配合统一管理，进一步简化部署、升级步骤。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 安装 python3 python3-pip</span>
<span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> python3 python3-pip

<span class="c"># 安装 docker-compose</span>
<span class="nb">sudo </span>pip3 <span class="nb">install </span>docker-compose
</code></pre></div></div>

<h3 id="编写-docker-composeyml">编写 docker-compose.yml</h3>

<p>  docker-compose 的管理主要依赖于一个名为 <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> 的 yaml 文件来进行管理，当然这个文件也可以以任何别的名称并以 <code class="language-plaintext highlighter-rouge">-f 文件名</code> 的方式来启用，但必须是符合 yaml 格式和 Docker 官方定义的字段和方式。以下为本实验所需的内容，其中用到了 mariadb 官方提供的数据库容器 和 Nextcloud 官方提供的应用容器。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2'</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">db</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">mariadb</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">always</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/home/data/nextcloud/db:/var/lib/mysql</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">MYSQL_ROOT_PASSWORD=root</span>
      <span class="pi">-</span> <span class="s">MYSQL_PASSWORD=nextcloud</span>
      <span class="pi">-</span> <span class="s">MYSQL_DATABASE=nextcloud</span>
      <span class="pi">-</span> <span class="s">MYSQL_USER=nextcloud</span>

  <span class="na">app</span><span class="pi">:</span>  
    <span class="na">image</span><span class="pi">:</span> <span class="s">nextcloud</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">always</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">7009:80</span>
    <span class="na">links</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">db</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/home/data/nextcloud/www:/var/www/html</span>
</code></pre></div></div>

<h3 id="启动容器">启动容器</h3>

<p>  以下命令即可开始拉取所需容器的镜像文件并根据 docker-compose.yml 文件配置好本地文件夹挂载和端口映射。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 启动容器</span>
<span class="nb">sudo </span>docker-compose up <span class="nt">-d</span>

<span class="c"># 更新nextcloud</span>
<span class="nb">sudo </span>docker pull nextcloud
<span class="nb">sudo </span>docker-compose down <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>docker-compose up <span class="nt">-d</span>
</code></pre></div></div>

<p>  然后 Nextcloud 就在 7009 端口（可自行修改 docker-compose.yml 文件来改变）开启好了，使用浏览器访问 <code class="language-plaintext highlighter-rouge">http://IP:7009</code> 。</p>

<h3 id="应用初始化配置">应用初始化配置</h3>

<p>  自行设置管理员用户名和密码，数据目录默认即可，数据库信息填写如 docker-composer.yml 中所示，数据库主机名填 db （配置文件中的数据库应用名）。</p>

<p><img src="https://i.lisz.top/blog/aG3Ax6.webp" alt="初始化示意图 Initialize" /></p>

<p>  所有初始化配置填写完毕之后，等待大约半分钟左右安装完成就可以看见 nextcloud 的主目录页面。到此处，Docker 搭建 Nextcloud 应用就大功告成了（也可在 80 端口安装 Nginx 服务代理到 7009 端口，此处不加赘述）。</p>

<h2 id="lnmpa-搭建-nextcloud">LNMPA 搭建 Nextcloud</h2>

<p>  本实验采用 Ubuntu 操作系统为例，其他 Linux 操作系统可以根据系统不同类比操作，操作步骤基本一致。</p>

<h3 id="安装-lnmpa-环境">安装 LNMPA 环境</h3>

<h4 id="为什么选用-lnmpa-而非-lnmp-或者-lmpa架构">为什么选用 LNMPA 而非 LNMP 或者 LMPA架构</h4>

<p>  LNMPA 的含义：</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">L</code>： Linux操作系统</li>
  <li><code class="language-plaintext highlighter-rouge">N</code>： Nginx web服务器软件</li>
  <li><code class="language-plaintext highlighter-rouge">M</code>： MySQL、Mariadb等类MySQL数据库软件</li>
  <li><code class="language-plaintext highlighter-rouge">P</code>： PHP编译环境</li>
  <li><code class="language-plaintext highlighter-rouge">A</code>： Apache服务</li>
</ul>

<p>  LNMPA 相比其他两种架构的优势在于充分发挥了 Nginx 和 Apache 的功能优势，即 Nginx 擅长提供静态文件服务、代理 HTTP 请求服务、Apache 擅长对于动态编程语言的结合接管编译工作。</p>

<h4 id="安装">安装</h4>

<p>  <a href="https://lnmp.org">LNMP.org</a> 提供一键式的环境安装脚本，所有软件均从各种软件官方下载源码编译安装，软件升级也相当方便。如果你的CPU 核数不够的话，那么第一次安装的时候编译可能需要花很长一段时间。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 建议使用 tmux 来管理后台任务</span>
<span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> tmux

<span class="c"># 新建一个后台session</span>
tmux new <span class="nt">-s</span> lnmpa
<span class="c"># ctrl+b+d 将任务放到后台</span>
<span class="c"># tmux attach -t lnmpa 进入后台session</span>

<span class="c"># 下载一键安装包</span>
wget <span class="nt">-c</span> http://soft1.vpser.net/lnmp/lnmp1.4-full.tar.gz

<span class="c"># 解压压缩包</span>
<span class="nb">tar </span>zxf lnmp1.4-full.tar.gz 

<span class="c"># 执行安装程序</span>
<span class="nb">cd </span>lnmp1.4-full
<span class="nb">sudo</span> ./install.sh lnmpa

<span class="c"># 安装完成后可以通过 http://IP 直接访问</span>
</code></pre></div></div>

<h3 id="准备工作">准备工作</h3>

<h4 id="新建数据库">新建数据库</h4>

<p>  使用 LNMPA 带的 phpMyadmin 可以直接新增数据库，比如数据库名为 nextcloud，分配用户名和密码均为 nextcloud。</p>

<h4 id="安装-php-扩展">安装 PHP 扩展</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 进入 lnmpa 一键安装包文件夹的 php 的 fileinfo 扩展源码目录</span>
<span class="nb">cd</span> ～/lnmp1.4-full/src/php-7.1.4/ext/fileinfo

<span class="c"># 从源码编译 fileinfo 扩展到 php 配置中</span>
/usr/local/php/bin/phpize
./configure <span class="nt">--with-php-config</span><span class="o">=</span>/usr/local/php/bin/php-config
make <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>make <span class="nb">install</span>

<span class="c"># 查看 fileinfo 是否启动</span>
 php <span class="nt">-i</span> | <span class="nb">grep </span>fileinfo
</code></pre></div></div>

<h4 id="修改-nginx-和-php-配置">修改 Nginx 和 PHP 配置</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># /usr/local/nginx/conf/nginx.conf</span>
<span class="c"># 修改下面一行参数为10240m(10G)，增加上传最大文件大小</span>
client_max_body_size 10240m<span class="p">;</span>

<span class="c"># /usr/local/php/etc/php.ini</span>
<span class="c"># 添加下面一行，以生效fileinfo扩展</span>
extension <span class="o">=</span> fileinfo.so

<span class="c"># 重启服务使配置生效</span>
<span class="nb">sudo </span>lnmp restart
</code></pre></div></div>

<h3 id="安装-nextcloud">安装 Nextcloud</h3>

<h4 id="下载-nextcloud-代码">下载 Nextcloud 代码</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 下载 Nextcloud 源码</span>
wget <span class="nt">-c</span> https://download.nextcloud.com/server/releases/nextcloud-13.0.1.zip

<span class="c"># 解压源码</span>
unzip nextcloud-13.0.1.zip

<span class="c"># 将源码拷贝至 wwwroot 目录</span>
<span class="nb">sudo cp</span> <span class="nt">-r</span> nextcloud /home/wwwroot/nextcloud
<span class="nb">sudo chown</span> <span class="nt">-R</span> www:www /home/wwwroot/nextcloud
</code></pre></div></div>

<h4 id="添加虚拟主机">添加虚拟主机</h4>

<p>  一种方式是使用 <code class="language-plaintext highlighter-rouge">lnmp vhost add</code> 的方式来添加（要求要域名，一步一步设置即可），另一种是直接添加文件，下面给出后一种方法无需域名的配置文件。</p>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># /usr/local/nginx/conf/vhost/default</span>

<span class="k">server</span>
    <span class="p">{</span>
        <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
        <span class="kn">listen</span> <span class="s">[::]:80</span><span class="p">;</span>
        <span class="kn">server_name</span> <span class="s">default</span><span class="p">;</span>
        <span class="kn">index</span> <span class="s">index.html</span> <span class="s">index.htm</span> <span class="s">index.php</span> <span class="s">default.html</span> <span class="s">default.htm</span> <span class="s">default.php</span><span class="p">;</span>
        <span class="kn">root</span>  <span class="n">/home/wwwroot/nextcloud</span><span class="p">;</span>

        <span class="c1">#error_page   404   /404.html;</span>
        <span class="kn">include</span> <span class="s">proxy-pass-php.conf</span><span class="p">;</span>

        <span class="kn">location</span> <span class="p">~</span> <span class="sr">.*\.(gif|jpg|jpeg|png|bmp|swf)$</span>
        <span class="p">{</span>
            <span class="kn">expires</span>      <span class="s">30d</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kn">location</span> <span class="p">~</span> <span class="sr">.*\.(js|css)?$</span>
        <span class="p">{</span>
            <span class="kn">expires</span>      <span class="s">12h</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kn">location</span> <span class="p">~</span> <span class="sr">/\.</span>
        <span class="p">{</span>
            <span class="kn">deny</span> <span class="s">all</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kn">access_log</span>  <span class="n">/home/wwwlogs/nextcloud.log</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<pre><code class="language-apacheconf"># /usr/local/apache/conf/vhost/default

&lt;VirtualHost *:88&gt;
ServerAdmin webmaster@example.com
php_admin_value open_basedir "/home/wwwroot/nextcloud:/tmp/:/var/tmp/:/proc/:Data将要放置目录的绝对路径:/dev/urandom"
DocumentRoot "/home/wwwroot/nextcloud"
ServerName default
ErrorLog "/home/wwwlogs/nextcloud-error_log"
CustomLog "/home/wwwlogs/nextcloud-access_log" combined
&lt;Directory "/home/wwwroot/nextcloud"&gt;
    SetOutputFilter DEFLATE
    Options FollowSymLinks
    AllowOverride All
    Order allow,deny
    Allow from all
    DirectoryIndex index.html index.php
&lt;/Directory&gt;
&lt;/VirtualHost&gt;
</code></pre>

<p>  使用 <code class="language-plaintext highlighter-rouge">sudo lnmp restart</code> 重启服务生效，接着即可通过浏览器访问 <code class="language-plaintext highlighter-rouge">http://IP</code> 或者 <code class="language-plaintext highlighter-rouge">http://域名</code> 来访问。</p>

<h3 id="配置-nextcloud">配置 Nextcloud</h3>

<p>  自行设置管理员用户名和密码，数据目录可任意选择一处有权限的目录即可（默认的应为 /home/wwwroot/nextcloud/data，建议填一个非源代码的目录便于版本更新，比如 /home/data/nextcloud，要求所属用户和用户组为 www-data），数据库信息均填写 nextcloud，数据库主机名默认填 localhost。</p>

<p><img src="https://i.lisz.top/blog/aG3Ax6.webp" alt="初始化示意图" /></p>

<p>  所有初始化配置填写完毕之后，等待大约半分钟左右安装完成就可以看见nextcloud的主目录页面。到此处， <code class="language-plaintext highlighter-rouge">LNMPA</code> 搭建 <code class="language-plaintext highlighter-rouge">Nextcloud</code> 应用就完成了，不过更新应用版本的话就更麻烦一点了。</p>

<h3 id="更新-nextcloud">更新 Nextcloud</h3>

<p>  这种方式安装的 Nextcloud 也需要通过源代码更新的方式来更新，以下为主要步骤。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 备份原来的源代码</span>
<span class="nb">sudo mv</span> /home/wwwroot/nextcloud /home/wwwroot/netxcloud-old/

<span class="c"># 下载最新的源代码</span>
wget <span class="nt">-c</span> https://download.nextcloud.com/server/releases/latest.zip
unzip latest.zip
<span class="nb">cd </span>nextcloud
<span class="nb">sudo cp</span> <span class="nt">-r</span> nextcloud /home/wwwroot/nextcloud
<span class="nb">sudo chown</span> <span class="nt">-R</span> www:www /home/wwwroot/nextcloud

<span class="c"># 应用更新</span>
<span class="nb">cd</span> /home/wwwroot/
<span class="nb">sudo cp </span>nextcloud-old/config/config.php nextcloud/confi/config.php

<span class="nb">cd</span> /home/wwwroot/nextcloud
<span class="nb">sudo</span> <span class="nt">-u</span> www /usr/local/php/bin/php occ maintenance:mode <span class="nt">--on</span>
<span class="nb">sudo</span> <span class="nt">-u</span> www /usr/local/php/bin/php occ upgrade
<span class="nb">sudo</span> <span class="nt">-u</span> www /usr/local/php/bin/php occ maintenance:mode <span class="nt">--off</span>
</code></pre></div></div>
