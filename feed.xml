<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.2">Jekyll</generator><link href="https://gbcpp.github.io/feed.xml" rel="self" type="application/atom+xml" /><link href="https://gbcpp.github.io/" rel="alternate" type="text/html" /><updated>2023-10-06T14:58:48+00:00</updated><id>https://gbcpp.github.io/feed.xml</id><title type="html">Mr Chen</title><subtitle>个人的一个技术博客站点，主要用于记录个人在学习过程中遇到的技术问题及解决方法、技术实验，以及一些比较有趣的事情。</subtitle><author><name>Mr Chen</name></author><entry><title type="html">RtcDataChannel(sctp) protocol optimize</title><link href="https://gbcpp.github.io/sctp-optimize.html" rel="alternate" type="text/html" title="RtcDataChannel(sctp) protocol optimize" /><published>2023-09-30T00:00:00+00:00</published><updated>2023-09-30T00:00:00+00:00</updated><id>https://gbcpp.github.io/sctp-optimize</id><content type="html" xml:base="https://gbcpp.github.io/sctp-optimize.html"><![CDATA[<h1 id="datachannel-实现">DataChannel 实现</h1>
<p>DataChannel 的实现有两种，webrtc 目前使用自行基于 C++ 开发的 dcsctp，mediasoup 和 libdatachannel 基于 usrsctp，usrsctp 为开源 sctp 协议实现，均遵守 rfc 4960 标准。
RFC：https://tools.ietf.org/html/rfc4960</p>

<h1 id="能力概述">能力概述</h1>
<p>DataChannel (SCTP）支持可靠传输、不可靠传输两种模式，其中不可靠传输有两种方式：一种基于配置包最大生命周期进行配置，另一种是基于最大重传次数进行配置。</p>

<p>如若使用可靠传输只需将Client 端的 reliable 配置为 true 即可，Server 的 usrsctp 中的 <code class="language-plaintext highlighter-rouge">spa.sendv_prinfo.pr_policy</code> 配置为  <code class="language-plaintext highlighter-rouge">SCTP_PR_SCTP_NONE</code> 即可；</p>

<p>如若需要使用不可靠传输模式，则分以下两种方式：基于生存时间和重传次数，二者只能选其一：
基于最大生命周期 <code class="language-plaintext highlighter-rouge">maxRetransTime</code> 为数据报在 sctp 队列中最大存活时间，该参数可以保证发送队列可以快速的情况，尽量降低后续包发送失败的概率，但是存在在网络拥塞的情况下，因 CC 控制导致数据报尚未发送便被清理的问题，即数据包没有经过一次发送便因超时而被清理了。</p>

<p>基于最大重传次数 <code class="language-plaintext highlighter-rouge">maxRetrans</code> 为数据报在发送队列中最多重传的次数，可保证数据至少在网络中发送一次，但如若出现了网络丢包，不会进行重传；注意：在 usrsctp 中，此参数至少要配置为 1 才能保证至少发送一次，与 client 不同。</p>

<h1 id="性能">性能</h1>
<p>两者默认都较弱，不论是其可靠传输，还是不可靠传输，抗弱网能力均较弱，但测试下来 usrsctp 比 dcsctp 要强一些，不过 usrsctp 基于 c 开发，代码缩写、简写严重，难以阅读理解，而 dcsctp 基于 C++ 实现，相对要容易理解一些；</p>

<h1 id="弱网性能">弱网性能</h1>
<p>在可靠传输模式下，30% 的丢包即为上限，整体还不如 tcp，具体数据暂不列了，更高的丢包率测试无法进行下去。</p>

<h2 id="原因分析">原因分析</h2>

<h3 id="发送窗口">发送窗口</h3>

<p>sctp 在拥塞控制算法上与 tcp 类似，分为慢启动、拥塞避免、快速恢复 和快速重传几个阶段。
在出现弱网，即出现 丢包 或者 重传超时的情况时，发送窗口 cwnd 和 慢启动阈值 ssthresh 减半，降低过快，同时其 cwnd 最低值过低，首先从这一点进行入手分析。
以下 Url 是 RFC 中对 CWnd 和 SStreash 的配置策略：
	https://datatracker.ietf.org/doc/html/rfc4960#section-6.3.3
	https://datatracker.ietf.org/doc/html/rfc4960#section-7.2.3
原文如下：</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>7.2.3.  Congestion Control

   Upon detection of packet losses from SACK (see Section 7.2.4), an
   endpoint should do the following:

      ssthresh = max(cwnd/2, 4*MTU)
      cwnd = ssthresh
      partial_bytes_acked = 0

   Basically, a packet loss causes cwnd to be cut in half.

   When the T3-rtx timer expires on an address, SCTP should perform slow
   start by:

      ssthresh = max(cwnd/2, 4*MTU)
      cwnd = 1*MTU

   and ensure that no more than one SCTP packet will be in flight for
   that address until the endpoint receives acknowledgement for
   successful delivery of data to that address.
</code></pre></div></div>
<p>大致意思如下：
在检测到丢包时，更新 sstresh 和 cwnd 机制如下：
对原 ssthresh 减半，但最大为 4 个 MTU 大小，这个是致命的，同时将 cwnd 更新为 ssthresh；
当 T3-rtx 重传定时器超时时：
对原 ssthresh 减半，但最大为 4 个 MTU 大小，但对 cwnd 更新为仅 1 个 MTU。
通过上述两种机制，可以看到，在高丢包率的弱网环境中，很容易进入到上述两种 case 中，结合 flighting 的数据大小，导致 sctp 协议可发送数据量奇小 （cwnd 过小），同时因为重传包的优先级高于新生成的数据包，导致协议唯一的一个发送窗口一直在重传旧包，新包很难获取发送机会，这就导致了明显的队头阻塞现象。
解决方案：目标只是为了不使 CWnd 的大小降低的过快，即在检测到丢包和 T3-rtx 超时时，不要立即对 ssthresh 减半，而是更加平滑的去降低，并且提高最小值的上限，通过这两种策略的优化，可以保证 sctp 协议有很高的带宽抢占能力，因为发送窗口越大，带宽抢占能力就越高。</p>

<h3 id="清空队列">清空队列</h3>

<p>通过上述策略优化发送窗口后，可以大幅度提高 sctp 在弱网（双向各30%丢包率）下的带宽传输能力，但是在更极端的网损（40%丢包，甚至更高）场景下，依然会出现队头阻塞现象，发送端不再主动发送新插入的数据，而是优先发送旧包（未收到 Ack），在实际应用场景中，我们希望不论是否收到对端的确认，都不应该阻塞新包的发送，和旧包的清理，以保证发送队列有一个快速的清理速度，且保证所有的数据均有机会被快速的发送到网络中去。
如果双方均为开源的实现，我们可以随意修改 sctp，可快速解决上述问题，但是当一端为浏览器时，我们只能考虑修改 Server 侧的协议实现，以期可以间接的影响到对端（浏览器），让对端（浏览器）最为发送端时，可以快速的清空发送队列，避免队头阻塞，答案就在 SACK 包中，首先看下 SACK 包的协议定义：
https://datatracker.ietf.org/doc/html/rfc4960#section-3.3.4</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>3.3.4.  Selective Acknowledgement (SACK) (3)

   This chunk is sent to the peer endpoint to acknowledge received DATA
   chunks and to inform the peer endpoint of gaps in the received
   subsequences of DATA chunks as represented by their TSNs.

   The SACK MUST contain the Cumulative TSN Ack, Advertised Receiver
   Window Credit (a_rwnd), Number of Gap Ack Blocks, and Number of
   Duplicate TSNs fields.

   By definition, the value of the Cumulative TSN Ack parameter is the
   last TSN received before a break in the sequence of received TSNs
   occurs; the next TSN value following this one has not yet been
   received at the endpoint sending the SACK.  This parameter therefore
   acknowledges receipt of all TSNs less than or equal to its value.

   The handling of a_rwnd by the receiver of the SACK is discussed in
   detail in Section 6.2.1.

   The SACK also contains zero or more Gap Ack Blocks.  Each Gap Ack
   Block acknowledges a subsequence of TSNs received following a break
   in the sequence of received TSNs.  By definition, all TSNs
   acknowledged by Gap Ack Blocks are greater than the value of the
   Cumulative TSN Ack.


        0                   1                   2                   3
        0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |   Type = 3    |Chunk  Flags   |      Chunk Length             |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                      Cumulative TSN Ack                       |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |          Advertised Receiver Window Credit (a_rwnd)           |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       | Number of Gap Ack Blocks = N  |  Number of Duplicate TSNs = X |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |  Gap Ack Block #1 Start       |   Gap Ack Block #1 End        |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       /                                                               /
       \                              ...                              \
       /                                                               /
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |   Gap Ack Block #N Start      |  Gap Ack Block #N End         |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                       Duplicate TSN 1                         |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       /                                                               /
       \                              ...                              \
       /                                                               /
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                       Duplicate TSN X                         |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

   Chunk Flags: 8 bits

      Set to all '0's on transmit and ignored on receipt.

   Cumulative TSN Ack: 32 bits (unsigned integer)

      This parameter contains the TSN of the last DATA chunk received in
      sequence before a gap.  In the case where no DATA chunk has been
      received, this value is set to the peer's Initial TSN minus one.

   Advertised Receiver Window Credit (a_rwnd): 32 bits (unsigned
   integer)

      This field indicates the updated receive buffer space in bytes of
      the sender of this SACK; see Section 6.2.1 for details.

   Number of Gap Ack Blocks: 16 bits (unsigned integer)

      Indicates the number of Gap Ack Blocks included in this SACK.

   

   Number of Duplicate TSNs: 16 bit

      This field contains the number of duplicate TSNs the endpoint has
      received.  Each duplicate TSN is listed following the Gap Ack
      Block list.

   Gap Ack Blocks:

      These fields contain the Gap Ack Blocks.  They are repeated for
      each Gap Ack Block up to the number of Gap Ack Blocks defined in
      the Number of Gap Ack Blocks field.  All DATA chunks with TSNs
      greater than or equal to (Cumulative TSN Ack + Gap Ack Block
      Start) and less than or equal to (Cumulative TSN Ack + Gap Ack
      Block End) of each Gap Ack Block are assumed to have been received
      correctly.

   Gap Ack Block Start: 16 bits (unsigned integer)

      Indicates the Start offset TSN for this Gap Ack Block.  To
      calculate the actual TSN number the Cumulative TSN Ack is added to
      this offset number.  This calculated TSN identifies the first TSN
      in this Gap Ack Block that has been received.

   Gap Ack Block End: 16 bits (unsigned integer)

      Indicates the End offset TSN for this Gap Ack Block.  To calculate
      the actual TSN number, the Cumulative TSN Ack is added to this
      offset number.  This calculated TSN identifies the TSN of the last
      DATA chunk received in this Gap Ack Block.
</code></pre></div></div>

<p>每一个 SACK 包中，均包括一个字段：<code class="language-plaintext highlighter-rouge">Cumulative TSN</code>，该字段标识接收端已确认（通知给 Application）的最大包序号（TSN），通过此字段告诉发送端，不要再发送小于此 TSN 的包，并清空所有队列中，小于等于此 TSN 的数据包，其它的字段均不是最重要的，可以自行决定是否调整。
只有当发送端不断的接收到接收端发来的 SACK 包后，通过其携带的强制前移的 <code class="language-plaintext highlighter-rouge">Cumulative TSN</code> 来清理本地的发送队列，可以保证自己的发送队列一直处于一个较小的 Cache，这样，新插入的数据包便可以被快速的发送出去，避免了因旧包未被 Ack 而导致的队头阻塞问题，更加的贴近 UDP 的行为。</p>

<p>Ok，那么回溯下这个问题的上一步：为什么发送端无法快速的清空自己的发送队列的呢？我们看下 RFC 的定义便知，https://datatracker.ietf.org/doc/html/rfc4960#section-6.1
原文如下：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>6.1.  Transmission of DATA Chunks

   This document is specified as if there is a single retransmission
   timer per destination transport address, but implementations MAY have
   a retransmission timer for each DATA chunk.

   The following general rules MUST be applied by the data sender for
   transmission and/or retransmission of outbound DATA chunks:

   A) At any given time, the data sender MUST NOT transmit new data to
      any destination transport address if its peer's rwnd indicates
      that the peer has no buffer space (i.e., rwnd is 0; see Section
      6.2.1).  However, regardless of the value of rwnd (including if it
      is 0), the data sender can always have one DATA chunk in flight to
      the receiver if allowed by cwnd (see rule B, below).  This rule
      allows the sender to probe for a change in rwnd that the sender
      missed due to the SACK's having been lost in transit from the data
      receiver to the data sender.

      When the receiver's advertised window is zero, this probe is
      called a zero window probe.  Note that a zero window probe SHOULD
      only be sent when all outstanding DATA chunks have been
      cumulatively acknowledged and no DATA chunks are in flight.  Zero
      window probing MUST be supported.

      If the sender continues to receive new packets from the receiver
      while doing zero window probing, the unacknowledged window probes
      should not increment the error counter for the association or any
      destination transport address.  This is because the receiver MAY
      keep its window closed for an indefinite time.  Refer to Section
      6.2 on the receiver behavior when it advertises a zero window.
      The sender SHOULD send the first zero window probe after 1 RTO
      when it detects that the receiver has closed its window and SHOULD
      increase the probe interval exponentially afterwards.  Also note
      that the cwnd SHOULD be adjusted according to Section 7.2.1.  Zero
      window probing does not affect the calculation of cwnd.

      The sender MUST also have an algorithm for sending new DATA chunks
      to avoid silly window syndrome (SWS) as described in [RFC0813].
      The algorithm can be similar to the one described in Section
      4.2.3.4 of [RFC1122].

      However, regardless of the value of rwnd (including if it is 0),
      the data sender can always have one DATA chunk in flight to the
      receiver if allowed by cwnd (see rule B below).  This rule allows
      the sender to probe for a change in rwnd that the sender missed
      due to the SACK having been lost in transit from the data receiver
      to the data sender.

   B) At any given time, the sender MUST NOT transmit new data to a
      given transport address if it has cwnd or more bytes of data
      outstanding to that transport address.

   C) When the time comes for the sender to transmit, before sending new
      DATA chunks, the sender MUST first transmit any outstanding DATA
      chunks that are marked for retransmission (limited by the current
      cwnd).

   D) When the time comes for the sender to transmit new DATA chunks,
      the protocol parameter Max.Burst SHOULD be used to limit the
      number of packets sent.  The limit MAY be applied by adjusting
      cwnd as follows:

      if((flightsize + Max.Burst*MTU) &lt; cwnd) cwnd = flightsize +
      Max.Burst*MTU

      Or it MAY be applied by strictly limiting the number of packets
      emitted by the output routine.

   E) Then, the sender can send out as many new DATA chunks as rule A
      and rule B allow.

   Multiple DATA chunks committed for transmission MAY be bundled in a
   single packet.  Furthermore, DATA chunks being retransmitted MAY be
   bundled with new DATA chunks, as long as the resulting packet size
   does not exceed the path MTU.  A ULP may request that no bundling is
   performed, but this should only turn off any delays that an SCTP
   implementation may be using to increase bundling efficiency.  It does
   not in itself stop all bundling from occurring (i.e., in case of
   congestion or retransmission).

   Before an endpoint transmits a DATA chunk, if any received DATA
   chunks have not been acknowledged (e.g., due to delayed ack), the
   sender should create a SACK and bundle it with the outbound DATA
   chunk, as long as the size of the final SCTP packet does not exceed
   the current MTU.  See Section 6.2.

   IMPLEMENTATION NOTE: When the window is full (i.e., transmission is
   disallowed by rule A and/or rule B), the sender MAY still accept send
   requests from its upper layer, but MUST transmit no more DATA chunks
   until some or all of the outstanding DATA chunks are acknowledged and
   transmission is allowed by rule A and rule B again.

   Whenever a transmission or retransmission is made to any address, if
   the T3-rtx timer of that address is not currently running, the sender
   MUST start that timer.  If the timer for that address is already
   running, the sender MUST restart the timer if the earliest (i.e.,
   lowest TSN) outstanding DATA chunk sent to that address is being
   retransmitted.  Otherwise, the data sender MUST NOT restart the
   timer.

   When starting or restarting the T3-rtx timer, the timer value must be
   adjusted according to the timer rules defined in Sections 6.3.2 and
   6.3.3.

   Note: The data sender SHOULD NOT use a TSN that is more than 2**31 -
   1 above the beginning TSN of the current send window.
</code></pre></div></div>

<p>根据上述定义，再结合上面 CWND 的更新策略，可以推测出，在高丢包的弱网情况下，Sender 很容易 Trigger 因连续未收到 Receiver 的 Ack，同时自己的 Inflighting 数据量较多，导致自己可发送的数据量非常小（最小为 1 个 MTU），甚至发送 0 Bytes 的探测包代替，从而出现严重的对头阻塞问题。</p>

<blockquote>
  <p>但是按照上述方案通过接收端强制偏移 TSN，以达到发送端快速清空发送队列的目标时，DataChannel/SCTP 的可靠传输能力便丧失了。</p>
</blockquote>

<h3 id="sack-chunk-源码">SACK Chunk 源码</h3>

<p>首先整理下 sctp 协议内接收端组装sack 的数据结构 （https://tools.ietf.org/html/rfc4960#section-3.3.4），在 dcsctp 的代码中比较易懂，定义如下：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">SackChunk</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Chunk</span><span class="p">,</span> <span class="k">public</span> <span class="n">TLVTrait</span><span class="o">&lt;</span><span class="n">SackChunkConfig</span><span class="o">&gt;</span> <span class="p">{</span>
 <span class="nl">public:</span>
  <span class="k">static</span> <span class="k">constexpr</span> <span class="kt">int</span> <span class="n">kType</span> <span class="o">=</span> <span class="n">SackChunkConfig</span><span class="o">::</span><span class="n">kType</span><span class="p">;</span>

  <span class="c1">// 可以看出包序号使用的是 uint16_t，只需两个字节  </span>
  <span class="k">struct</span> <span class="nc">GapAckBlock</span> <span class="p">{</span>
    <span class="n">GapAckBlock</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">start</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">end</span><span class="p">)</span> <span class="o">:</span> <span class="n">start</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="n">end</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="p">{}</span>

    <span class="kt">uint16_t</span> <span class="n">start</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">end</span><span class="p">;</span>

    <span class="kt">bool</span> <span class="k">operator</span><span class="o">==</span><span class="p">(</span><span class="k">const</span> <span class="n">GapAckBlock</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">start</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">start</span> <span class="o">&amp;&amp;</span> <span class="n">end</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">end</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="n">SackChunk</span><span class="p">(</span><span class="n">TSN</span> <span class="n">cumulative_tsn_ack</span><span class="p">,</span>
            <span class="kt">uint32_t</span> <span class="n">a_rwnd</span><span class="p">,</span>
            <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">GapAckBlock</span><span class="o">&gt;</span> <span class="n">gap_ack_blocks</span><span class="p">,</span>
            <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">TSN</span><span class="o">&gt;</span> <span class="n">duplicate_tsns</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">cumulative_tsn_ack_</span><span class="p">(</span><span class="n">cumulative_tsn_ack</span><span class="p">),</span>
        <span class="n">a_rwnd_</span><span class="p">(</span><span class="n">a_rwnd</span><span class="p">),</span>
        <span class="n">gap_ack_blocks_</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">gap_ack_blocks</span><span class="p">)),</span>
        <span class="n">duplicate_tsns_</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">duplicate_tsns</span><span class="p">))</span> <span class="p">{}</span>
  <span class="k">static</span> <span class="n">absl</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">SackChunk</span><span class="o">&gt;</span> <span class="n">Parse</span><span class="p">(</span><span class="n">rtc</span><span class="o">::</span><span class="n">ArrayView</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">uint8_t</span><span class="o">&gt;</span> <span class="n">data</span><span class="p">);</span>

  <span class="kt">void</span> <span class="n">SerializeTo</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;&amp;</span> <span class="n">out</span><span class="p">)</span> <span class="k">const</span> <span class="k">override</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">ToString</span><span class="p">()</span> <span class="k">const</span> <span class="k">override</span><span class="p">;</span>
  <span class="n">TSN</span> <span class="n">cumulative_tsn_ack</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">cumulative_tsn_ack_</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">uint32_t</span> <span class="n">a_rwnd</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a_rwnd_</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">rtc</span><span class="o">::</span><span class="n">ArrayView</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">GapAckBlock</span><span class="o">&gt;</span> <span class="n">gap_ack_blocks</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">gap_ack_blocks_</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">TSN</span><span class="o">&gt;&amp;</span> <span class="n">duplicate_tsns</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">duplicate_tsns_</span><span class="p">;</span> <span class="p">}</span>

 <span class="k">private</span><span class="o">:</span>
  <span class="k">static</span> <span class="k">constexpr</span> <span class="kt">size_t</span> <span class="n">kGapAckBlockSize</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="k">static</span> <span class="k">constexpr</span> <span class="kt">size_t</span> <span class="n">kDupTsnBlockSize</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

  <span class="k">const</span> <span class="n">TSN</span> <span class="n">cumulative_tsn_ack_</span><span class="p">;</span>             <span class="c1">// 最大已确认包序号，TSN 即为内部传输块的序号</span>
  <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">a_rwnd_</span><span class="p">;</span>                    <span class="c1">// 接收窗口的大小</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">GapAckBlock</span><span class="o">&gt;</span> <span class="n">gap_ack_blocks_</span><span class="p">;</span>  <span class="c1">// GAP 包序号范围，一次聚合多个</span>
  <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">TSN</span><span class="o">&gt;</span> <span class="n">duplicate_tsns_</span><span class="p">;</span>             <span class="c1">// 收到的已确认的包序号</span>
<span class="p">};</span>
</code></pre></div></div>

<p>这里，可能有些疑问，每次打包的 SACK 中，其 gap_ack_blocks_ 和 duplicate_tsns_ 是否有最大个数/长度限制，因为它们两个毕竟是要全部一个个的序列化到网络包中的，答案是：有的。
两者 gap_ack_blocks_ 和 duplicate_tsns_ 单次限制上限为 20 个，kMaxGapAckBlocksReported 和 kMazhimaxDuplicateTsnReported 均定义为 constexpr 值：20，声明在代码文件：data_tracker.h中。</p>

<h3 id="sack-发包时机">SACK 发包时机</h3>

<p>在 dcsctp 的实现中，sack 的发送时机是动态的。在没有数据包丢失时，每秒钟发送一次，当监测到丢包时，针对每个数据包发送一次 sack；当不直接发送 SACKS 时，将使用 timer 控制 sack 的延迟发送，比如 min(RTO/2，200ms)。</p>

<p>发送端接收到对端回应的 SACK 后，判断如果其 cumulative tsn 比本地记录的最大的 last cumulative tsn 要大（即没有回退），则重启 ts_rtx_ 定时器。</p>

<h1 id="遗留问题">遗留问题</h1>

<h2 id="rtt-计算">RTT 计算</h2>

<p>有明显问题，如下两种：
在 dcsctp 中看到 RTT 的计算是有漏洞的，其在 sack 中没有 gap_ack_blocks 时，通过 cumulative tsn 计算其 rtt，存在两种风险:</p>
<ul>
  <li>这个 sack 整体是有延迟的，其计算 rtt 时，是直接通过 sendts - current ts，明显没有考虑 delay ack time；</li>
  <li>其只有在没有 gap_ack_blocks 时，即没有出现丢包时才统计其 RTT，这样在丢包严重时，可能会出现长时间无法更新 rtt，或者在 rtt 和 loss 突然增大时，出现长时间无法更新 rtt 的情况，一直以旧的 rtt 为准。</li>
</ul>]]></content><author><name>Mr Chen</name></author><category term="协议" /><summary type="html"><![CDATA[DataChannel 实现 DataChannel 的实现有两种，webrtc 目前使用自行基于 C++ 开发的 dcsctp，mediasoup 和 libdatachannel 基于 usrsctp，usrsctp 为开源 sctp 协议实现，均遵守 rfc 4960 标准。 RFC：https://tools.ietf.org/html/rfc4960]]></summary></entry><entry><title type="html">后台服务绑定 CPU 核</title><link href="https://gbcpp.github.io/service-bind-cpu.html" rel="alternate" type="text/html" title="后台服务绑定 CPU 核" /><published>2023-09-30T00:00:00+00:00</published><updated>2023-09-30T00:00:00+00:00</updated><id>https://gbcpp.github.io/service-bind-cpu</id><content type="html" xml:base="https://gbcpp.github.io/service-bind-cpu.html"><![CDATA[<blockquote>
  <p>一个 Prod 用的服务启动升级脚本，检查了 CPU 核心数，并按照指定顺序绑定 CPU 核心，以提升性能。</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nv">SERVICENAME</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">VERSION</span><span class="o">=</span><span class="nv">$2</span>
<span class="nv">BINPATH</span><span class="o">=</span>/home/devops/<span class="nv">$SERVICENAME</span>/bin/
<span class="nv">PACKAGE</span><span class="o">=</span>/home/devops/<span class="nv">$SERVICENAME</span>/package/

<span class="c"># xxx 进程名|进程文件名</span>
<span class="nv">PROCESS</span><span class="o">=</span><span class="nv">$SERVICENAME</span>.exe
<span class="nv">LOCK_FILE</span><span class="o">=</span><span class="s2">"/</span><span class="nv">$BINPATH</span><span class="s2">/.xxxxx.</span><span class="nv">$PROCESS</span><span class="s2">.lock"</span>

<span class="c"># we think cpu binding means will enable cpu perception</span>
<span class="nv">USE_CPU_TOPOLOGY_SERVER_TYPE</span><span class="o">=</span><span class="s2">"server"</span>
<span class="nv">USE_CPU_TOPOLOGY_TAG</span><span class="o">=</span><span class="s2">"vm_use_cpu_topology:true vm_bind_cpu:true"</span>
<span class="nv">USE_CPU_TOPOLOGY_PROVIDER</span><span class="o">=</span><span class="s2">"aws"</span>
<span class="nv">USE_CPU_TOPOLOGY_IDC</span><span class="o">=</span><span class="s2">""</span>

<span class="nv">USE_CPU_TOPOLOGY</span><span class="o">=</span>

<span class="c"># control bind core and xdp in hybrid deployment machine</span>
<span class="nv">is_hybrid</span><span class="o">=</span>0

<span class="k">function </span>CheckDir<span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-d</span> <span class="nv">$BINPATH</span> <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nb">sudo mkdir</span> <span class="nt">-p</span> <span class="nv">$BINPATH</span><span class="p">;</span> <span class="k">fi</span>
<span class="o">}</span>

<span class="k">function </span>CheckHybridDeploy<span class="o">()</span> <span class="o">{</span>
    <span class="nv">get_message</span><span class="o">=</span><span class="sb">`</span>curl <span class="nt">-4</span> https://meta.xxxxx.co/latest/meta-data/tag <span class="nt">--max-time</span> 10<span class="sb">`</span>
    <span class="nv">match</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="k">${</span><span class="nv">get_message</span><span class="k">}</span> | <span class="nb">grep</span> <span class="nt">-a</span> <span class="s2">"servicevosmixed:1"</span> | <span class="nb">wc</span> <span class="nt">-l</span><span class="sb">`</span>
    <span class="k">if</span> <span class="o">[</span> <span class="k">${</span><span class="nv">match</span><span class="k">}</span> <span class="nt">-gt</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nv">is_hybrid</span><span class="o">=</span>1
    <span class="k">fi
    </span><span class="nb">echo</span> <span class="s2">"Is hybrid : </span><span class="k">${</span><span class="nv">is_hybrid</span><span class="k">}</span><span class="s2">"</span>
<span class="o">}</span>

<span class="c"># 排他锁，防止相同时间内进行其它操作，比如操作时，防止zabbix触发自动拉起</span>
<span class="k">function </span>Lock<span class="o">()</span> <span class="o">{</span>
    <span class="nb">ls</span> <span class="s2">"</span><span class="nv">$LOCK_FILE</span><span class="s2">"</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$?</span> <span class="nt">-ne</span> 0 <span class="o">]]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">sudo touch</span> <span class="s2">"</span><span class="nv">$LOCK_FILE</span><span class="s2">"</span>
    <span class="k">else
        </span><span class="nv">lockTime</span><span class="o">=</span><span class="si">$(</span><span class="nb">stat</span> <span class="nt">-t</span> <span class="s2">"</span><span class="nv">$LOCK_FILE</span><span class="s2">"</span> | <span class="nb">awk</span> <span class="s1">'{print $12}'</span><span class="si">)</span>
        <span class="nv">currentTime</span><span class="o">=</span><span class="si">$(</span><span class="nb">date</span> +%s<span class="si">)</span>
        <span class="nv">duration</span><span class="o">=</span><span class="k">$((</span>currentTime <span class="o">-</span> lockTime<span class="k">))</span>
        <span class="nb">echo</span> <span class="nv">$duration</span>
        <span class="k">if</span> <span class="o">[[</span> <span class="nv">$duration</span> <span class="nt">-gt</span> 20 <span class="o">]]</span><span class="p">;</span> <span class="k">then
            </span><span class="nb">sudo touch</span> <span class="s2">"</span><span class="nv">$LOCK_FILE</span><span class="s2">"</span>
        <span class="k">else
            </span><span class="nb">echo</span> <span class="s2">"Less than 20 seconds since last operation"</span>
            <span class="nb">exit </span>1
        <span class="k">fi
    fi</span>
<span class="o">}</span>

<span class="k">function </span>Unlock<span class="o">()</span> <span class="o">{</span>
    <span class="nb">sudo rm</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$LOCK_FILE</span><span class="s2">"</span>
<span class="o">}</span>

<span class="k">function </span>NeedUseCPUTopology<span class="o">()</span> <span class="o">{</span> <span class="c"># not zero mean need bind cpu</span>

    <span class="k">if</span> <span class="o">[[</span> <span class="nt">-n</span> <span class="k">${</span><span class="nv">USE_CPU_TOPOLOGY</span><span class="k">}</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
        return</span> <span class="k">${</span><span class="nv">USE_CPU_TOPOLOGY</span><span class="k">}</span>
    <span class="k">fi</span>
    
    <span class="c"># check is vm</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="k">${</span><span class="nv">USE_CPU_TOPOLOGY_SERVER_TYPE</span><span class="k">}</span><span class="s2">"</span> <span class="o">==</span> <span class="k">*</span><span class="s2">"</span><span class="si">$(</span>hostnamectl | <span class="nb">grep </span>Chassis | <span class="nb">cut</span> <span class="nt">-d</span> <span class="s1">':'</span> <span class="nt">-f2</span> | xargs<span class="si">)</span><span class="s2">"</span><span class="k">*</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
        </span><span class="nv">USE_CPU_TOPOLOGY</span><span class="o">=</span>1
        <span class="k">return</span> <span class="k">${</span><span class="nv">USE_CPU_TOPOLOGY</span><span class="k">}</span>
    <span class="k">fi</span>
    
    <span class="c"># get machine tag</span>
    <span class="k">for </span>machine_tag <span class="k">in</span> <span class="si">$(</span><span class="nb">timeout </span>10 curl https://meta.xxxxx.co/2022-09-13/meta-data/tag 2&gt;/dev/null<span class="si">)</span><span class="p">;</span> <span class="k">do
        if</span> <span class="o">[[</span> <span class="s2">"</span><span class="k">${</span><span class="nv">USE_CPU_TOPOLOGY_TAG</span><span class="k">}</span><span class="s2">"</span> <span class="o">==</span> <span class="k">*</span><span class="s2">"</span><span class="k">${</span><span class="nv">machine_tag</span><span class="k">}</span><span class="s2">"</span><span class="k">*</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
            </span><span class="nv">USE_CPU_TOPOLOGY</span><span class="o">=</span>1
            <span class="k">return</span> <span class="k">${</span><span class="nv">USE_CPU_TOPOLOGY</span><span class="k">}</span>
        <span class="k">fi
    done</span>
    
    <span class="c"># # get cluster name</span>
    <span class="c"># if [[ "${USE_CPU_TOPOLOGY_IDC}" == *"$(curl https://meta.xxxxx.co/2022-09-13/meta-data/cluster 2&gt;/dev/null)"* ]]; then</span>
    <span class="c">#     USE_CPU_TOPOLOGY=1;</span>
    <span class="c">#     return ${USE_CPU_TOPOLOGY}</span>
    <span class="c"># fi</span>
    
    <span class="c"># get provider</span>
    <span class="c"># if [[ "${USE_CPU_TOPOLOGY_PROVIDER}" == *"$(curl https://meta.xxxxx.co/2022-09-13/meta-data/provider 2&gt;/dev/null)"* ]]; then</span>
    <span class="c">#     USE_CPU_TOPOLOGY=1;</span>
    <span class="c">#     return ${USE_CPU_TOPOLOGY}</span>
    <span class="c"># fi</span>
    
    <span class="nv">USE_CPU_TOPOLOGY</span><span class="o">=</span>0
    <span class="k">return</span> <span class="k">${</span><span class="nv">USE_CPU_TOPOLOGY</span><span class="k">}</span>

<span class="o">}</span>

<span class="c"># 获取当前机器物理核心数</span>
<span class="k">function </span>GetCpuNumber<span class="o">()</span> <span class="o">{</span>
    <span class="c"># if not use topology, we will presume machine have open HT, and just return all process count / 2</span>
    NeedUseCPUTopology <span class="o">&amp;&amp;</span> <span class="o">{</span> <span class="nb">echo</span> <span class="k">$((</span><span class="si">$(</span><span class="nb">grep</span> <span class="nt">-c</span> processor /proc/cpuinfo<span class="si">)</span> <span class="o">/</span> <span class="m">2</span><span class="k">))</span> <span class="o">&amp;&amp;</span> <span class="k">return </span>0<span class="p">;</span> <span class="o">}</span>
    
    <span class="nv">CORE</span><span class="o">=</span><span class="si">$(</span><span class="nb">cat</span> /proc/cpuinfo | <span class="nb">grep</span> <span class="s2">"core id"</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> | <span class="nb">wc</span> <span class="nt">-l</span><span class="si">)</span>
    <span class="nv">PHYSICAL</span><span class="o">=</span><span class="si">$(</span><span class="nb">cat</span> /proc/cpuinfo | <span class="nb">grep</span> <span class="s2">"physical id"</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> | <span class="nb">wc</span> <span class="nt">-l</span><span class="si">)</span>
    <span class="nv">LOGIC</span><span class="o">=</span><span class="k">$((</span>CORE <span class="o">*</span> PHYSICAL<span class="k">))</span>
    <span class="nb">echo</span> <span class="nv">$LOGIC</span>
<span class="o">}</span>

<span class="k">function </span>GetMemTotalSize<span class="o">()</span> <span class="o">{</span>
    <span class="nv">memTotalSize</span><span class="o">=</span><span class="si">$(</span><span class="nb">cat</span> /proc/meminfo | <span class="nb">grep </span>MemTotal | <span class="nb">awk</span> <span class="s1">'{print $2}'</span><span class="si">)</span>
    <span class="nb">echo</span> <span class="nv">$memTotalSize</span>
<span class="o">}</span>

<span class="c"># 设置进程数</span>
<span class="k">function </span>GetProcessNumber<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">processNumber</span><span class="o">=</span>1
    <span class="nv">cpuNumber</span><span class="o">=</span><span class="si">$(</span>GetCpuNumber<span class="si">)</span>
    <span class="nv">memTotalSize</span><span class="o">=</span><span class="si">$(</span>GetMemTotalSize<span class="si">)</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$cpuNumber</span> <span class="nt">-ge</span> 10 <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nv">processNumber_tmp</span><span class="o">=</span><span class="k">$((</span>cpuNumber <span class="o">-</span> <span class="m">2</span><span class="k">))</span>
        <span class="c"># 内存总容量足够的机器按满配起</span>
        <span class="k">if</span> <span class="o">[[</span> <span class="nv">$memTotalSize</span> <span class="nt">-ge</span> <span class="k">$((</span>processNumber_tmp <span class="o">*</span> <span class="m">2359296</span><span class="k">))</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
            </span><span class="nv">processNumber_pre</span><span class="o">=</span><span class="nv">$processNumber_tmp</span>
            <span class="k">if</span> <span class="o">[[</span> <span class="nv">$approuter_running</span> <span class="nt">-eq</span> 1 <span class="o">]]</span><span class="p">;</span> <span class="k">then
                </span><span class="nv">processNumber</span><span class="o">=</span><span class="k">$((</span>processNumber_pre <span class="o">-</span> <span class="m">4</span><span class="k">))</span>
            <span class="k">else
                </span><span class="nv">processNumber</span><span class="o">=</span><span class="nv">$processNumber_pre</span>
            <span class="k">fi</span>
        <span class="c"># 内存总容量不够的机器计算实际要起的进程数</span>
        <span class="k">else
            </span><span class="nv">processNumber_pre</span><span class="o">=</span><span class="k">$((</span>memTotalSize <span class="o">/</span> <span class="m">2359296</span><span class="k">))</span>
            <span class="k">if</span> <span class="o">[[</span> <span class="nv">$approuter_running</span> <span class="nt">-eq</span> 1 <span class="o">]]</span><span class="p">;</span> <span class="k">then
                </span><span class="nv">processNumber</span><span class="o">=</span><span class="k">$((</span>processNumber_pre <span class="o">-</span> <span class="m">4</span><span class="k">))</span>
            <span class="k">else
                </span><span class="nv">processNumber</span><span class="o">=</span><span class="nv">$processNumber_pre</span>
            <span class="k">fi
        fi
    elif</span> <span class="o">[[</span> <span class="nv">$cpuNumber</span> <span class="nt">-gt</span> 1 <span class="o">]]</span><span class="p">;</span> <span class="k">then
        </span><span class="nv">processNumber_pre</span><span class="o">=</span><span class="k">$((</span>cpuNumber <span class="o">-</span> <span class="m">1</span><span class="k">))</span>
        <span class="k">if</span> <span class="o">[[</span> <span class="nv">$approuter_running</span> <span class="nt">-eq</span> 1 <span class="o">]]</span><span class="p">;</span> <span class="k">then
            </span><span class="nv">processNumber</span><span class="o">=</span><span class="k">$((</span>processNumber_pre <span class="o">-</span> <span class="m">4</span><span class="k">))</span>
        <span class="k">else
            </span><span class="nv">processNumber</span><span class="o">=</span><span class="nv">$processNumber_pre</span>
        <span class="k">fi
    elif</span> <span class="o">[[</span> <span class="nv">$cpuNumber</span> <span class="nt">-eq</span> 1 <span class="o">]]</span><span class="p">;</span> <span class="k">then
        </span><span class="nv">processNumber</span><span class="o">=</span>1
    <span class="k">fi
    if</span> <span class="o">[</span> <span class="nv">$processNumber</span> <span class="nt">-gt</span> 30 <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nv">processNumber</span><span class="o">=</span>30
    <span class="k">fi
    </span><span class="nb">echo</span> <span class="nv">$processNumber</span>
<span class="o">}</span>

<span class="k">function </span>CheckApprouterProcessRunningStaus<span class="o">()</span> <span class="o">{</span>
    <span class="nv">approuterNumber</span><span class="o">=</span><span class="si">$(</span>ps aux | <span class="nb">grep</span> <span class="nt">-w</span> <span class="s2">"reuseport.exe"</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="nb">grep</span> | <span class="nb">wc</span> <span class="nt">-l</span><span class="si">)</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$approuterNumber</span> <span class="nt">-gt</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nv">approuter_running</span><span class="o">=</span>1
    <span class="k">else
        </span><span class="nv">approuter_running</span><span class="o">=</span>0
    <span class="k">fi</span>
<span class="o">}</span>

<span class="c"># 检查当前进程数</span>
<span class="k">function </span>CheckProcessNumber<span class="o">()</span> <span class="o">{</span>
    <span class="nv">processNumber</span><span class="o">=</span><span class="si">$(</span>GetProcessNumber<span class="si">)</span>
    <span class="nv">currentNumber</span><span class="o">=</span><span class="si">$(</span>ps aux | <span class="nb">grep</span> <span class="nt">-w</span> <span class="s2">"./</span><span class="nv">$PROCESS</span><span class="s2">"</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s1">'gzip'</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="nb">grep</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="nv">$0</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s2">"appRestart</span><span class="se">\|</span><span class="s2">appStart</span><span class="se">\|</span><span class="s2">appStop</span><span class="se">\|</span><span class="s2">appUpgrade"</span> | <span class="nb">wc</span> <span class="nt">-l</span><span class="si">)</span>
    
    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$currentNumber</span> <span class="nt">-ne</span> <span class="nv">$processNumber</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"current process number: </span><span class="nv">$currentNumber</span><span class="s2">, need process number: </span><span class="nv">$processNumber</span><span class="s2">"</span>
        Unlock
        <span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="o">}</span>

<span class="c"># 检查当前进程数</span>
<span class="k">function </span>CheckNoProcess<span class="o">()</span> <span class="o">{</span>
    <span class="nv">currentNumber</span><span class="o">=</span><span class="si">$(</span>ps aux | <span class="nb">grep</span> <span class="nt">-w</span> <span class="s2">"./</span><span class="nv">$PROCESS</span><span class="s2">"</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s1">'gzip'</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="nb">grep</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="nv">$0</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s2">"appRestart</span><span class="se">\|</span><span class="s2">appStart</span><span class="se">\|</span><span class="s2">appStop</span><span class="se">\|</span><span class="s2">appUpgrade"</span> | <span class="nb">wc</span> <span class="nt">-l</span><span class="si">)</span>

    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$currentNumber</span> <span class="nt">-ne</span> 0 <span class="o">]]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"current process number: </span><span class="nv">$currentNumber</span><span class="s2">, should be 0"</span>
        Unlock
        <span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="o">}</span>

<span class="c"># 停止进程</span>
<span class="k">function </span>Stop<span class="o">()</span> <span class="o">{</span>
    <span class="nb">sudo </span>killall <span class="nt">-q</span> <span class="s2">"</span><span class="nv">$PROCESS</span><span class="s2">"</span>
    <span class="nb">sleep </span>30
    <span class="nb">echo</span> <span class="s2">"Stop Process finished"</span>
    CheckNoProcess
<span class="o">}</span>

<span class="c"># 升级程序</span>
<span class="k">function </span>Upgrade<span class="o">()</span> <span class="o">{</span>
    <span class="c">#检查文件是否存在</span>
    <span class="k">if </span><span class="nb">test</span> <span class="o">!</span> <span class="nt">-e</span> <span class="s2">"</span><span class="nv">$PACKAGE</span><span class="s2">/</span><span class="nv">$SERVICENAME</span><span class="s2">.exe"</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"upgrade package not exist"</span>
        <span class="nb">exit </span>1
    <span class="k">fi</span>
    
    <span class="c">#检查程序及版本</span>
    <span class="nb">local </span><span class="nv">exeVersion</span><span class="o">=</span><span class="si">$(</span><span class="s2">"</span><span class="nv">$PACKAGE</span><span class="s2">/</span><span class="nv">$SERVICENAME</span><span class="s2">.exe"</span> <span class="nt">-v</span> | <span class="nb">awk</span> <span class="s1">'{sub(/^[\t ]*/, "");print}'</span><span class="si">)</span>
    <span class="nb">local </span><span class="nv">upVersion</span><span class="o">=</span><span class="s2">"</span><span class="nv">$PROCESS</span><span class="s2">"</span>_<span class="s2">"</span><span class="nv">$exeVersion</span><span class="s2">"</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="nv">$upVersion</span><span class="s2">"</span> <span class="o">!=</span> <span class="s2">"</span><span class="nv">$VERSION</span><span class="s2">"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"version mismatch, package version: </span><span class="nv">$upVersion</span><span class="s2">, need version: </span><span class="nv">$VERSION</span><span class="s2">"</span>
        Unlock
        <span class="nb">exit </span>1
    <span class="k">fi
    
    if </span><span class="nb">test</span> <span class="o">!</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$BINPATH</span><span class="s2">"</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">sudo mkdir</span> <span class="nt">-p</span> <span class="s2">"</span><span class="nv">$BINPATH</span><span class="s2">"</span>
    <span class="k">fi</span>
    
    <span class="c"># copy程序到bin下</span>
    <span class="nb">sudo cp</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$PACKAGE</span><span class="s2">/</span><span class="nv">$SERVICENAME</span><span class="s2">.exe"</span> <span class="s2">"</span><span class="nv">$BINPATH</span><span class="s2">/</span><span class="nv">$PROCESS</span><span class="s2">"</span>
<span class="o">}</span>

<span class="c"># 启动进程</span>
<span class="k">function </span>Start<span class="o">()</span> <span class="o">{</span>
    <span class="nb">cd</span> <span class="s2">"</span><span class="nv">$BINPATH</span><span class="s2">"</span>
    <span class="nb">sudo </span>bash <span class="nt">-c</span> <span class="s2">"echo 3 &gt; /proc/sys/vm/drop_caches"</span>
    <span class="nb">sleep </span>10
    
    <span class="nv">processNumber</span><span class="o">=</span><span class="si">$(</span>GetProcessNumber<span class="si">)</span>
    <span class="nv">currentNumber</span><span class="o">=</span><span class="si">$(</span>ps aux | <span class="nb">grep</span> <span class="nt">-w</span> <span class="s2">"./</span><span class="nv">$PROCESS</span><span class="s2">"</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s1">'gzip'</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="nb">grep</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="nv">$0</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s2">"appRestart</span><span class="se">\|</span><span class="s2">appStart</span><span class="se">\|</span><span class="s2">appStop</span><span class="se">\|</span><span class="s2">appUpgrade"</span> | <span class="nb">wc</span> <span class="nt">-l</span><span class="si">)</span>
    
    <span class="nb">echo</span> <span class="s2">"Need: </span><span class="nv">$processNumber</span><span class="s2">, Current: </span><span class="nv">$currentNumber</span><span class="s2">"</span>
    <span class="nv">run_process_command</span><span class="o">=</span><span class="k">${</span><span class="nv">PROCESS</span><span class="k">}</span>
    <span class="k">if</span> <span class="o">[</span> <span class="k">${</span><span class="nv">is_hybrid</span><span class="k">}</span> <span class="nt">-eq</span> 1 <span class="o">]</span><span class="p">;</span> <span class="k">then
            </span><span class="nv">run_process_command</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">run_process_command</span><span class="k">}</span><span class="s2"> --disable_xdp=true"</span>
    <span class="k">fi
    for</span> <span class="o">((</span>i <span class="o">=</span> currentNumber<span class="p">;</span> i &lt; <span class="s2">"</span><span class="nv">$processNumber</span><span class="s2">"</span><span class="p">;</span> i++<span class="o">))</span><span class="p">;</span> <span class="k">do
        </span><span class="nb">sudo</span> ./<span class="nv">$run_process_command</span>
        <span class="nb">sleep </span>3
    <span class="k">done</span>
<span class="o">}</span>

<span class="c"># 绑定核心</span>
<span class="k">function </span>BindingProcesstoPhysicalCores<span class="o">()</span> <span class="o">{</span>

    NeedUseCPUTopology <span class="o">&amp;&amp;</span> <span class="k">return </span>0

    <span class="k">if</span> <span class="o">[</span> <span class="k">${</span><span class="nv">is_hybrid</span><span class="k">}</span> <span class="nt">-eq</span> 1 <span class="o">]</span><span class="p">;</span> <span class="k">then
        return </span>0
    <span class="k">fi
    
    </span><span class="nv">TOTAL_CPU</span><span class="o">=</span><span class="si">$(</span><span class="nb">grep</span> <span class="nt">-c</span> processor /proc/cpuinfo<span class="si">)</span>
    <span class="nv">CORE</span><span class="o">=</span><span class="si">$(</span><span class="nb">cat</span> /proc/cpuinfo | <span class="nb">grep</span> <span class="s2">"core id"</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> | <span class="nb">wc</span> <span class="nt">-l</span><span class="si">)</span>
    <span class="nv">PHYSICAL</span><span class="o">=</span><span class="si">$(</span><span class="nb">cat</span> /proc/cpuinfo | <span class="nb">grep</span> <span class="s2">"physical id"</span> | <span class="nb">sort</span> | <span class="nb">uniq</span> | <span class="nb">wc</span> <span class="nt">-l</span><span class="si">)</span>
    <span class="nv">LOGIC</span><span class="o">=</span><span class="k">$((</span>CORE <span class="o">*</span> PHYSICAL<span class="k">))</span>
    <span class="nv">PIDS</span><span class="o">=</span><span class="si">$(</span>ps aux | <span class="nb">grep</span> <span class="nt">-w</span> <span class="s2">"./</span><span class="nv">$PROCESS</span><span class="s2">"</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="nb">grep</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="nv">$0</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s2">"start</span><span class="se">\|</span><span class="s2">ansible"</span> | <span class="nb">awk</span> <span class="s1">'{print $2}'</span><span class="si">)</span>
    
    <span class="k">if</span> <span class="o">[[</span> <span class="k">$((</span><span class="nv">$TOTAL_CPU</span> <span class="o">/</span> <span class="m">2</span><span class="k">))</span> <span class="nt">-eq</span> <span class="nv">$LOGIC</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
        if</span> <span class="o">[[</span> <span class="si">$(</span><span class="nb">cat</span> /sys/devices/system/cpu/cpu0/topology/thread_siblings_list | <span class="nb">grep</span> - | <span class="nb">wc</span> <span class="nt">-l</span><span class="si">)</span> <span class="nt">-eq</span> 1 <span class="o">]]</span><span class="p">;</span> <span class="k">then
            </span><span class="nv">cpu_thread_seq</span><span class="o">=</span><span class="s2">"continuous"</span> <span class="c">#CPU-No. vs Core ID Like CPU0-Core0_Thread0,CPU1-Core0_Thread1,CPU2-Core1_Thread0,CPU3-Core1_Thread1...</span>
        <span class="k">else
            </span><span class="nv">cpu_thread_seq</span><span class="o">=</span><span class="s2">"discontinuous"</span> <span class="c">#CPU-No. vs Core ID Like CPU0-Core0_Thread0,CPU1-Core1_Thread0,..,CPU10-Core0_Thread1,CPU1-Core0_Thread1...</span>
        <span class="k">fi
    elif</span> <span class="o">[[</span> <span class="nv">$TOTAL_CPU</span> <span class="nt">-eq</span> <span class="nv">$LOGIC</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
        </span><span class="nv">cpu_thread_seq</span><span class="o">=</span><span class="s2">"na"</span> <span class="c"># CPU do not enable or not support Hyper-Threading</span>
    <span class="k">fi
    
    if</span> <span class="o">[[</span> <span class="nv">$cpu_thread_seq</span> <span class="o">=</span> <span class="s2">"discontinuous"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
        if</span> <span class="o">[[</span> <span class="nv">$approuter_running</span> <span class="nt">-eq</span> 1 <span class="o">]]</span><span class="p">;</span> <span class="k">then</span> <span class="c">#有app_router保留4个核心，从倒数第5个物理核开始使用</span>
            <span class="nv">cpu</span><span class="o">=</span><span class="k">$((</span><span class="nv">$LOGIC</span> <span class="o">-</span> <span class="m">5</span><span class="k">))</span>
        <span class="k">else
            </span><span class="nv">cpu</span><span class="o">=</span><span class="k">$((</span><span class="nv">$LOGIC</span> <span class="o">-</span> <span class="m">1</span><span class="k">))</span> <span class="c">#没有app_router正常从最后1个物理核开始使用</span>
        <span class="k">fi
    
        for </span>pid <span class="k">in</span> <span class="k">${</span><span class="nv">PIDS</span><span class="p">[@]</span><span class="k">}</span><span class="p">;</span> <span class="k">do
            </span><span class="nb">sudo </span>taskset <span class="nt">-p</span> <span class="nt">--cpu-list</span> <span class="nv">$cpu</span> <span class="nv">$pid</span>
            <span class="nv">cpu</span><span class="o">=</span><span class="k">$((</span><span class="nv">$cpu</span> <span class="o">-</span> <span class="m">1</span><span class="k">))</span>
        <span class="k">done
    elif</span> <span class="o">[[</span> <span class="nv">$cpu_thread_seq</span> <span class="o">=</span> <span class="s2">"continuous"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
        if</span> <span class="o">[[</span> <span class="nv">$approuter_running</span> <span class="nt">-eq</span> 1 <span class="o">]]</span><span class="p">;</span> <span class="k">then</span> <span class="c">#有app_router保留4个核心即8个逻辑核，从倒数第10个逻辑核开始使用</span>
            <span class="nv">cpu</span><span class="o">=</span><span class="k">$((</span><span class="nv">$TOTAL_CPU</span> <span class="o">-</span> <span class="m">10</span><span class="k">))</span>
        <span class="k">else
            </span><span class="nv">cpu</span><span class="o">=</span><span class="k">$((</span><span class="nv">$TOTAL_CPU</span> <span class="o">-</span> <span class="m">2</span><span class="k">))</span> <span class="c">#没有app_router正常从倒数第2个逻辑核开始用</span>
        <span class="k">fi
    
        for </span>pid <span class="k">in</span> <span class="k">${</span><span class="nv">PIDS</span><span class="p">[@]</span><span class="k">}</span><span class="p">;</span> <span class="k">do
            </span><span class="nb">sudo </span>taskset <span class="nt">-p</span> <span class="nt">--cpu-list</span> <span class="nv">$cpu</span> <span class="nv">$pid</span>
            <span class="nv">cpu</span><span class="o">=</span><span class="k">$((</span><span class="nv">$cpu</span> <span class="o">-</span> <span class="m">2</span><span class="k">))</span>
        <span class="k">done
    elif</span> <span class="o">[[</span> <span class="nv">$cpu_thread_seq</span> <span class="o">=</span> <span class="s2">"na"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
        for </span>pid <span class="k">in</span> <span class="k">${</span><span class="nv">PIDS</span><span class="p">[@]</span><span class="k">}</span><span class="p">;</span> <span class="k">do
            </span><span class="nb">sudo </span>taskset <span class="nt">-p</span> 0xFFFF <span class="nv">$pid</span>
        <span class="k">done
    fi</span>

<span class="o">}</span>

CheckApprouterProcessRunningStaus <span class="o">&amp;&amp;</span>
    CheckDir <span class="o">&amp;&amp;</span>
    CheckHybridDeploy <span class="o">&amp;&amp;</span>
    Lock <span class="o">&amp;&amp;</span>
    Stop <span class="o">&amp;&amp;</span>
    Upgrade <span class="o">&amp;&amp;</span>
    Start <span class="o">&amp;&amp;</span>
    BindingProcesstoPhysicalCores <span class="o">&amp;&amp;</span>
    CheckProcessNumber
Unlock
</code></pre></div></div>]]></content><author><name>Mr Chen</name></author><category term="后台" /><summary type="html"><![CDATA[一个 Prod 用的服务启动升级脚本，检查了 CPU 核心数，并按照指定顺序绑定 CPU 核心，以提升性能。]]></summary></entry><entry><title type="html">网络包序号回绕</title><link href="https://gbcpp.github.io/packet_number.html" rel="alternate" type="text/html" title="网络包序号回绕" /><published>2023-04-18T00:00:00+00:00</published><updated>2023-04-18T00:00:00+00:00</updated><id>https://gbcpp.github.io/packet_number</id><content type="html" xml:base="https://gbcpp.github.io/packet_number.html"><![CDATA[<blockquote>
  <p>Transform your plain text into static websites and blogs.</p>
</blockquote>

<h2 id="需求">需求</h2>

<p>在实现一套基于 UDP/DataChannel 自定义可靠传输算法时，自定义的协议头中肯定也是要用到 sequence Id 来标记包序号，用于重传，计算 RTT 等需求。</p>

<h2 id="方案">方案</h2>

<p>一般情况下我们都是使用 32字节的 UINT 记录 sequence id，通过不断的递增包序号总是会达到最大值 UINT_MAX，然后回绕到 0 的，此时需要判断新的 sequence id （比如 1， 2，3， xxx），是要 “大于” 旧的 sequence id （4294967293， 4294967294， 4294967295）的，如果直接通过关系运算符  &gt;  &lt; 等进行判断的话，就会得到错误的结果，回绕后的新包序号 sequence id 要排到旧的包序号 sequence id 之前了，针对此种情况，需要一种特殊的 “关系运算符” 比较，在此提供如下比较方法。</p>

<h3 id="方案一">方案一</h3>

<p>通过比较两个包序号之间差值与 kPacketNumberMask 与运算后的结果，与 UINT_MAX / 4 之间的关系来判断。</p>

<p>此种判断方法的前提是认定递增的包序号，在队列中不可能出现最新和最旧的包序号差值能够达到 (kPacketNumberMask » 1)，即 UINT_MAX / 4 如此之大的，否则说明包序号设计非常的不合理。</p>

<p>有了正确的判断包序号大小的方法，再配合 std::map 可自定义的 key_compare 便可实现对产生回绕的包序号自动排序能力，完整的 Example：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 定义 UINT_MAX 的一半</span>
<span class="c1">// BIN: 01111111111111111111111111111111; HEX:7FFFFFFF; DEC:2147483647</span>
<span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">kPacketNumberMask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1u</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> 

<span class="c1">// 当用 UINT 的较小的数 减去 较大的数不够减时，得到的结果会产生回绕：</span>
<span class="c1">// 如：3 - UINT_MAX = 4， 4 用 二进制表示为：100b</span>
<span class="c1">// 用 kPacketNumberMask &amp; 100b = 100b， 100b 是小于 (kPacketNumberMask &gt;&gt; 1) 的，结果为 true；</span>


<span class="c1">// &gt;</span>
<span class="kt">bool</span> <span class="nf">greaterThan</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">left</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">right</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">kPacketNumberMask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">left</span> <span class="o">-</span> <span class="n">right</span><span class="p">))</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">kPacketNumberMask</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// &lt;</span>
<span class="kt">bool</span> <span class="nf">lessThan</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">left</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">right</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">greaterThan</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// &lt;=</span>
<span class="kt">bool</span> <span class="nf">lessEqual</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">left</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">right</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">==</span> <span class="n">right</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">kPacketNumberMask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">left</span> <span class="o">-</span> <span class="n">right</span><span class="p">))</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">kPacketNumberMask</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="err">​```</span>



<span class="o">-</span> <span class="n">Example</span><span class="o">:</span>

<span class="err">​```</span><span class="n">cpp</span>
<span class="cp">#include</span> <span class="cpf">&lt;map&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;climits&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>


<span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">kPacketNumberMask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1u</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

<span class="kt">bool</span> <span class="nf">greaterThan</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">left</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">right</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">kPacketNumberMask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">left</span> <span class="o">-</span> <span class="n">right</span><span class="p">))</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">kPacketNumberMask</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="nf">lessThan</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">left</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">right</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">greaterThan</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="nf">lessEqual</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">left</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">right</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">==</span> <span class="n">right</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">kPacketNumberMask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">left</span> <span class="o">-</span> <span class="n">right</span><span class="p">))</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">kPacketNumberMask</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="nc">CompareUint</span> <span class="o">:</span> <span class="k">public</span> <span class="n">std</span><span class="o">::</span><span class="n">binary_function</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="p">,</span> <span class="kt">bool</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="kt">bool</span> <span class="k">operator</span><span class="p">()(</span><span class="kt">uint32_t</span> <span class="n">lhs</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">rhs</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="c1">// return !greaterThan(lhs, rhs);</span>
    <span class="k">return</span> <span class="n">lessEqual</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
 <span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">CompareUint</span><span class="o">&gt;</span> <span class="n">pkt_map</span><span class="p">;</span>
  <span class="n">pkt_map</span><span class="p">[</span><span class="n">UINT_MAX</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="s">"UINT_MAX - 3"</span><span class="p">;</span>
  <span class="n">pkt_map</span><span class="p">[</span><span class="n">UINT_MAX</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s">"UINT_MAX - 2"</span><span class="p">;</span>
  <span class="n">pkt_map</span><span class="p">[</span><span class="n">UINT_MAX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">"UINT_MAX - 1"</span><span class="p">;</span>
  <span class="n">pkt_map</span><span class="p">[</span><span class="n">UINT_MAX</span> <span class="o">-</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s">"UINT_MAX - 0"</span><span class="p">;</span>
  <span class="n">pkt_map</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">"1"</span><span class="p">;</span>
  <span class="n">pkt_map</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s">"2"</span><span class="p">;</span>

  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"-------------------------------------------------</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"UINT_MAX: "</span> <span class="o">&lt;&lt;</span> <span class="n">UINT_MAX</span> <span class="o">&lt;&lt;</span> <span class="s">", +1 = "</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">UINT_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"3 - UINT_MAX = "</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">3</span> <span class="o">-</span><span class="n">UINT_MAX</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"0 - UINT_MAX = "</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">0</span> <span class="o">-</span><span class="n">UINT_MAX</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="n">itor</span> <span class="o">:</span> <span class="n">pkt_map</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"key: "</span> <span class="o">&lt;&lt;</span> <span class="n">itor</span><span class="p">.</span><span class="n">first</span> <span class="o">&lt;&lt;</span> <span class="s">", value: "</span> <span class="o">&lt;&lt;</span> <span class="n">itor</span><span class="p">.</span><span class="n">second</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p>运行结果：</p>

    <blockquote>
      <p>编译：g++  main.cpp -std=c++17  -o main.exe</p>
    </blockquote>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">-------------------------------------------------</span>
UINT_MAX: 4294967295, +1 <span class="o">=</span> 0
3 - UINT_MAX <span class="o">=</span> 4
0 - UINT_MAX <span class="o">=</span> 1
key: 4294967292, value: UINT_MAX - 3
key: 4294967293, value: UINT_MAX - 2
key: 4294967294, value: UINT_MAX - 1
key: 4294967295, value: UINT_MAX - 0
key: 1, value: 1
key: 2, value: 2
</code></pre></div></div>

<h3 id="方案二">方案二</h3>
<p>内核中使用的方法：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kr">inline</span> <span class="kt">bool</span> <span class="nf">before</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">seq1</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">seq2</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="kt">int32_t</span><span class="p">)(</span><span class="n">seq1</span><span class="o">-</span><span class="n">seq2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#define after(seq2, seq1)   before(seq1, seq2)
</span></code></pre></div></div>]]></content><author><name>Mr Chen</name></author><category term="协议" /><summary type="html"><![CDATA[Transform your plain text into static websites and blogs.]]></summary></entry><entry><title type="html">H2O-ac theme for Jekyll</title><link href="https://gbcpp.github.io/tech/new-theme-h2o-ac.html" rel="alternate" type="text/html" title="H2O-ac theme for Jekyll" /><published>2021-12-22T11:50:00+00:00</published><updated>2021-12-22T11:50:00+00:00</updated><id>https://gbcpp.github.io/tech/new-theme-h2o-ac</id><content type="html" xml:base="https://gbcpp.github.io/tech/new-theme-h2o-ac.html"><![CDATA[<h2 id="前言">前言</h2>

<p>  正如大家所知，Jekyll 是一款高可定制的、非常流行的静态博客生成工具。围绕着 Jekyll 也衍生出了很多优秀的 Jekyll 主题， 由 <a href="https://github.com/kaeyleo">廖柯宇</a> 开发的 <a href="https://github.com/kaeyleo/jekyll-theme-H2O">H2O</a> 主题就是其中之一。极简主义、风格扁平化、卡片式布局、Medium 及知乎专栏的视觉风格等等特点，为我们带来了或许是迄今为止最漂亮的 Jekyll 主题。</p>

<p>  诞生之初，H2O 主题就在 Github 平台上以 MIT 许可证协议开放了源代码。这吸引了很多小伙伴纷纷转投 Jekyll 和 H2O 主题的阵营，本人也是其中之一。随着使用者越来越多，不少的小伙伴在使用过程中发现了一些小问题并主动修复，最后贡献到了 H2O 的主项目，这让 H2O 主题变得更好。本人在使用过程中也的确是发现了一些与自己实际需求不大一致的地方，并且在原 H2O 主题的基础上做了一些改动。考虑到这些改动可能并不是大多数人的需求，直接向原 H2O 主题提交 pull 请求合并的必要性不大，因此决定将原项目 fork 并改名为 <a href="https://github.com/zhonger/jekyll-theme-H2O-ac">zhonger/jekyll-theme-H2O-ac</a>。现正式将源代码以与 H2O 主题相同的 MIT 许可证协议在 Github 平台上公开。</p>

<p>  在此，非常感谢廖柯宇及其他小伙伴对于 H2O-ac 主题的基础主题 H2O 的代码开发和开放共享。</p>

<h2 id="新特性">新特性</h2>

<h3 id="更适合学术人和运维程序员的页面结构">更适合学术人和运维程序员的页面结构</h3>

<p>  H2O 主题其实在很大程度上已经满足了大部分人的需求，只是对于学术研究人员和运维程序员来说，个人觉得页面结构还是有点不够合适。学术研究人员比较重视在首页直接展示个人信息和研究情况，能够让人很快地了解到所需的信息，这其实是将 About me 这样一个平常的辅助页面当成了主页面来用。另外，运维程序员比较重视能一览所有文章的标题以迅速找到感兴趣的文章。虽然搜索功能、标签页、卡片展示页都能够列出所有的文章，但个人觉得还是不够简洁、方便。而像 Hexo 静态生成工具自带的 Archive 归档页面比较能满足这样的需求。除此之外，整个博客的系统日志变迁记录对于运维程序员来说也非常重要，毕竟如果通过发布一篇文章来描述变迁过程并不适合联系起来完整了解。如果有系统日志页，就可以按照年份、月份、事件的先后进行简要的描述，并且一览无遗。</p>

<p>  因此，在 H2O-ac 主题中，从原来 H2O 的主页中抽出框架做成了页面模板。根据实际页面的内容需求，增加了<strong>学术首页</strong>、<strong>归档页</strong>和<strong>系统日志页</strong>。</p>

<h4 id="学术首页">学术首页</h4>

<p>  学术首页如下图所示，并将原来 H2O 中的卡片首页移动到 blog 子目录下了。如果读者想要看到文章卡片展示页，还是可以点击顶部的导航栏中的 BLOG 直接访问。</p>

<p><img src="https://i.lisz.top/blog/XyT038.webp" alt="首页 Home" /></p>

<h4 id="归档页">归档页</h4>

<p>  归档页设置为由 Jekyll 按照模板自动生成，以年份、日期、文章标题分级列表展示，简洁清晰。</p>

<p><img src="https://i.lisz.top/blog/lj4vUP.webp" alt="归档页 Archives" /></p>

<h4 id="系统日志页">系统日志页</h4>

<p>  系统日志页其实也不是经常更新的，只有在博客整体作出设置或改进的才加以说明。另外，也可以将一些固定的站点信息放置在系统日志页，比如站点的多点部署信息，读者可以根据此信息访问最快、最合适的节点。</p>

<p><img src="https://i.lisz.top/blog/7QLEc6.webp" alt="系统日志 Log" /></p>

<h3 id="使用体验提升">使用体验提升</h3>

<p>  廖柯宇也在 H2O 主题的默认页面中写道，目前 H2O 主题还有一些可优化的内容，比如夜间模式、查看大图等。这里，根据个人的一些实际需求和了解，在 H2O-ac 主题中做了调整。</p>

<h4 id="社交图标扩展">社交图标扩展</h4>

<p>  H2O 原有的社交图标其实已经比较广泛，只是还有些领域局限性，比如学术研究人员可能更希望展示谷歌学术、ResearchGate、ORCID 等社交图标及链接，而运维开发人员可能更希望展示 SegmentFault、CSDN、博客园等社交图标及链接。这里在 H2O 提供的社交图标类型基础上做了这些平台图标的扩充，同时尝试了 Symbol 引用的方式来实现社交图标鼠标悬停的效果，从而简化代码（H2O 采用的是字体图标的方式，需要为每一个社交图标定义不同的主题色）。</p>

<p><img src="https://i.lisz.top/blog/UpnQdk.webp" alt="社交图标 SNS" /></p>

<h4 id="查看大图">查看大图</h4>

<p>  查看大图功能的确对于读者的阅读体验来说有很大的提升。就像我们阅读文献一样，可能首先会只看文章附图来大致掌握文章的核心点。博文的查看大图功能也可能有这样的异曲同工之妙。这里是采用的 <a href="https://fancyapps.com/docs/ui/fancybox">Fancybox</a> 插件实现的。H2O-ac 主题中只使用了最简单的配置，用户可以根据需求查看文档做出更多的修改。</p>

<p><img src="https://i.lisz.top/blog/BzfBoz.webp" alt="查看大图 Fancybox" /></p>

<p>(2022年4月30日更新)</p>

<p>  ，由于 fancybox 库作者对原使用的 v3.5.7 版本不再进行维护和更新，现将版本更新至新的 v4.0 版本，即 <a href="https://github.com/fancyapps/ui">fancyapps/ui</a>。另，新增将 alt 内容作为图片的描述显示在 fancybox 中。</p>

<h4 id="深色模式切换按钮">深色模式切换按钮</h4>

<p>(2022年4月30日更新)</p>

<p>  原来 H2O 主题的深色模式切换需要在 _config.yml 文件中配置开启，并且只能在固定时间段使用。此次更新在页面右上角提供了深色/浅色模式一键切换按钮，如下图所示。由于更新了深色模式采用 cookie 的方式来确定，此深色模式切换按钮可以与原来的深色模式配置共存。</p>

<p><img src="https://i.lisz.top/blog/EPhFN9.webp" alt="浅色模式 Day mode" /></p>

<p><img src="https://i.lisz.top/blog/BD7BqC.webp" alt="深色模式 Night mode" /></p>

<h4 id="提示框">提示框</h4>

<p>(2022年4月30日更新)</p>

<p>  通过引入 <a href="https://github.com/lazee/premonition">lazee/premonition</a> 库新增五种提示框：笔记、提示、警告、错误、引用，完全兼容原生 Markdown 语法，并对样式进行了主题适应。以下为五种提示框的实际效果。</p>

<div class="premonition note"> <div class="header"> <svg class="icon note" aria-hidden="true"> <use xlink:href="#icon-note"></use> </svg> <div class="title"> Note </div> </div> <div class="content"> <p>The body of the note goes here. Premonition allows you to write any <code class="language-plaintext highlighter-rouge">Markdown</code> inside the block.</p>



 </div> </div>
<div class="premonition info"> <div class="header"> <svg class="icon info" aria-hidden="true"> <use xlink:href="#icon-info"></use> </svg> <div class="title"> 小提示 </div> </div> <div class="content"> <p>The body of the info goes here. Premonition allows you to write any <code class="language-plaintext highlighter-rouge">Markdown</code> inside the block.</p>



 </div> </div>
<div class="premonition warning"> <div class="header"> <svg class="icon warning" aria-hidden="true"> <use xlink:href="#icon-warning"></use> </svg> <div class="title"> Warning </div> </div> <div class="content"> <p>The body of the warning goes here. Premonition allows you to write any <code class="language-plaintext highlighter-rouge">Markdown</code> inside the block.</p>



 </div> </div>
<div class="premonition error"> <div class="header"> <svg class="icon error" aria-hidden="true"> <use xlink:href="#icon-error"></use> </svg> <div class="title"> Error </div> </div> <div class="content"> <p>The body of the error goes here. Premonition allows you to write any <code class="language-plaintext highlighter-rouge">Markdown</code> inside the block.</p>



 </div> </div>
<div class="premonition citation"> <div class="header"> <svg class="icon citation" aria-hidden="true"> <use xlink:href="#icon-citation"></use> </svg> </div> <div class="content"> <p>To be or not to be is a question.</p>



 </div> <div class="ref"> ------ 莎士比亚 </div> </div>
<h4 id="代码高亮优化">代码高亮优化</h4>

<p>  本人使用 H2O 主题的时候代码高亮功能还是沿用的 Jekyll 自带的，后来 H2O 主题也开始采用了 <a href="https://prismjs.com/">Prism.js</a>。不过由于使用的是 <code class="language-plaintext highlighter-rouge">OKAIDIA</code> 高亮主题，所以有些段落中的格式化字段显示上有些问题。这里，仍然采用默认主题，并且扩增到 Prism.js 支持的所有编程语言类型。效果可以从前一句的 OKAIDIA 字段和下面即将出现的代码片段看出。</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@font-face</span> <span class="p">{</span>
  <span class="nl">font-family</span><span class="p">:</span> <span class="s2">'Merriweather'</span><span class="p">;</span>
  <span class="nl">src</span><span class="p">:</span> <span class="n">local</span><span class="p">(</span><span class="s2">'Merriweather'</span><span class="p">),</span> <span class="sx">url(https://fonts.gstatic.com/...)</span> <span class="n">format</span><span class="p">(</span><span class="s2">'woff2'</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>(2022年5月14日更新)</p>

<p>  更换 Prism 库加载方式，采用按需自动加载代码类型，尽可能减少因 Prism 造成的阻塞。修复了某些样式问题。增加显示行数支持、官方主题选择支持。如下所示可以进行设置，具体主题风格样式可以访问 <a href="https://prismjs.com/">Prism 官网</a> 了解更多。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Prism</span>
<span class="na">prism</span><span class="pi">:</span>
  <span class="na">theme</span><span class="pi">:</span> <span class="s">tomorrow</span>
  <span class="na">line_numbers</span><span class="pi">:</span> <span class="kc">true</span>
</code></pre></div></div>

<h4 id="代码复制">代码复制</h4>

<p>(2022年5月1日更新)</p>

<p>  由于主题设置有复制自动添加版权保护文字，导致复制代码或无法直接使用。但是如果直接去掉版权保护又不大合适，于是新增代码复制功能。当使用如下所示代码片段右上角的复制按钮时，代码会被复制到粘贴板，且不包含版权保护文字，可以放心直接使用。</p>

<p>(2022年5月14日更新)</p>

<p>  调整复制按钮位置，自动识别代码块的代码类型并显示。</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- Target --&gt;</span>
<span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"foo"</span> <span class="na">value=</span><span class="s">"https://github.com/zenorocha/clipboard.js.git"</span><span class="nt">&gt;</span>

<span class="c">&lt;!-- Trigger --&gt;</span>
<span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"btn"</span> <span class="na">data-clipboard-target=</span><span class="s">"#foo"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"assets/clippy.svg"</span> <span class="na">alt=</span><span class="s">"Copy to clipboard"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/button&gt;</span>
</code></pre></div></div>

<h4 id="字数统计及阅读时间估计">字数统计及阅读时间估计</h4>

<p>  字数统计及阅读时间估计这个小功能其实以前在用 WordPress 的时候比较常见。虽然说统计和估计的结果不一定完全准确，但是还是起到了一定的辅助阅读的作用。效果可以查看本页标题下的基本信息区域。</p>

<h4 id="时间本地化与最近更新时间">时间本地化与最近更新时间</h4>

<p>(2022年5月22日更新)</p>

<p>  为了支持来自不同时区的读者直接可以看到文章发布对应的本地时间，现已利用 dayjs 新增<strong>时间本地化</strong>功能。并利用 Github API 查询页面的最近一次 commit 更新时间作为文章<strong>最近更新时间</strong>。效果如下图所示。</p>

<p><img src="https://i.lisz.top/blog/Anb4xH.webp" alt="构建位置时区 Jekyll deployment timezone" />
<img src="https://i.lisz.top/blog/NMPXmQ.webp" alt="读者时区 Reader timezone" /></p>

<p>  如需使用<strong>最近更新时间</strong>功能，务必在 _config.yml 文件中添加以下配置项：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Github</span>
<span class="na">github</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">owner</span><span class="pi">:</span> <span class="s">github_username</span>
  <span class="na">repository</span><span class="pi">:</span> <span class="s">github_project_name</span>
</code></pre></div></div>

<p>  如未正确进行以上配置，默认会将最近更新时间与发布时间保持一致。</p>

<h4 id="版权显式声明">版权显式声明</h4>

<p>(2022年5月18日更新)</p>

<p>  之前的版本只会在页面底部的信息栏中显示一个 CC 4.0 的小图标，不是很醒目。根据调研其他静态网站主题，发现一般都会在文章的末尾自动生成一个比较醒目的版权声明。另外，在版权声明中也将根据最近更新时间来判断内容是否可能过时。如果最近更新时间距离当前时间大于 365 天，则会显示具体日期并提醒有内容过时的可能。效果如下所示。</p>

<p><img src="https://i.lisz.top/blog/scNRyd.webp" alt="版权显式声明 Copyright" />
<img src="https://i.lisz.top/blog/C8RWtL.webp" alt="内容可能过时提醒 Long time ago notification" /></p>

<h4 id="文章侧边索引导航">文章侧边索引导航</h4>

<p>(2022年1月9日更新)</p>

<p>  在一些基于 Bootstrap 前端框架的 Jekyll 主题中，这个功能比较常见。由于本主题未使用 Bootstrap 前端框架，所以添加起来稍微有些麻烦，现已增加此功能。在浏览器窗口超过 1050 px 的情况下，在文章页面可以正常看到右侧的文章侧边索引导航。当窗口滑动时，侧边索引导航也会跟着滑动。在浏览器窗口不足 1050 px 的情况下，侧边索引导航自动隐藏。在 _config.yml 配置文件中，可以通过设置 <code class="language-plaintext highlighter-rouge">toc: false</code> 来全局禁用此功能。</p>

<p>(2022年4月30日更新)</p>

<p>  在原来的基础上增加了跟随左侧内容滑动高亮。当左侧内容向上或向下滑动时，右侧索引导航将会使对应的对应一级标题高亮。</p>

<p>(2022年5月14日更新)</p>

<p>  为文章的移动端页面添加了索引导航按钮。鉴于单页面的内容有限及侧边位置空间有限，暂未对单页面进行支持。</p>

<h4 id="支持-waline-评论系统">支持 Waline 评论系统</h4>

<p>  目前已支持基于 Valine 衍生的简洁、安全的评论系统。可以根据官方提供的 <a href="https://waline.js.org/guide/get-started.html">快速上手</a> 进行配置，以下为 _config.yml 中需要配置的内容：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># _config.yml</span>

<span class="na">comments</span><span class="pi">:</span>
  <span class="na">waline</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">waline_url</span><span class="pi">:</span> <span class="s">https://xxxxxx.vercel.app</span>
</code></pre></div></div>

<p>  <del>目前未对多评论系统同时支持进行优化，所以如果 Disqus 和 Waline 同时开启时，Disqus 在前 Waline 在后同时出现。如果用户环境无法访问 Disqus 即只能看到 Waline。</del></p>

<p>(2022年5月22日更新)</p>

<p>  新增多评论切换按钮：当同时使用 Disqus 和 Waline 时，会在评论区域的右上角看到一个左右滑动切换按钮。如下所示，从左往右滑动即可从 Disqus 切换到 Waline。</p>

<p>  同时修复了手动切换深色模式时 Disqus 不会自动切换模式而造成的显示问题。目前在模式切换时 Disqus 会主动进行重新加载以适应当前模式。</p>

<p><img src="https://i.lisz.top/blog/WBgbUB.webp" alt="Disqus 评论系统 Disqus comment" />
<img src="https://i.lisz.top/blog/45JQ9H.webp" alt="Waline 评论系统 Waline comments" /></p>

<h4 id="支持-pwa">支持 PWA</h4>

<p>(2022年5月11日更新)</p>

<p>  全面支持 PWA，访问速度得到较大提升。移动端访问可以像原生 APP 那样使用。如果访问过全站一遍之后，则可以完全离线使用。如下所示，可以配置 PWA 的主题色和短名称。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># PWA</span>
<span class="na">pwa</span><span class="pi">:</span>
  <span class="na">color</span><span class="pi">:</span> <span class="s1">'</span><span class="s">#81BBFF'</span>
  <span class="na">short_name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">lisz'</span>
</code></pre></div></div>

<h4 id="配置项">配置项</h4>

<p>  配置项中新增了<strong>友情链接</strong>和<strong>备案号</strong>功能，可以直接在 _config.yml 文件的对应配置项下设置即可，如下所示。友情链接主要是方便跟其他博主交换友链，备案号主要是为了方便部署在国内需备案的 vps 或虚拟主机上。此处，二者都可以置空。</p>

<p>(2022年4月30日更新)</p>

<p>  新增<strong>全站一键灰度化功能</strong>、<strong>时间格式</strong>配置。在国家公祭日等需要灰度化以示哀悼的时候可以将灰度化配置设置为 true，平常使用默认配置 false。时间格式这里一共提供了 3 种：第一种中英文站点使用皆宜，第二种适用于英文站点，第三种适用于中文站点。默认时间格式为第一种。</p>

<p>(2022年5月14日更新)</p>

<p>  新增 <a href="https://busuanzi.ibruce.info/"><strong>不蒜子</strong></a> 统计方式，可以显示全站访问次数、全站访问用户数、文章页面阅读量。如下设置可以开启。</p>

<p>(2022年5月16日更新)</p>

<p>  新增 <a href="https://github.com/mikecao/umami"><strong>umami</strong></a> 统计方式，需要自行先搭建 umami 然后接入。接入配置只需要如下所示配置跟踪 id 和 JS 脚本地址。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Links 友情链接</span>
<span class="na">links</span><span class="pi">:</span>
  <span class="s1">'</span><span class="s">Mr</span><span class="nv"> </span><span class="s">Li'</span><span class="err">:</span> <span class="s1">'</span><span class="s">https://lisz.me'</span>

<span class="c1"># Beian 备案号</span>
<span class="na">beian</span><span class="pi">:</span> <span class="s1">'</span><span class="s">沪ICP备xxxxxxxx号'</span>

<span class="c1"># Gray 灰度化</span>
<span class="na">gray</span><span class="pi">:</span> <span class="kc">true</span>

<span class="c1"># Time format 时间格式 </span>
<span class="c1"># 0 -- 2022-04-29    1 -- 29 Apr 2022   2 -- 2022年4月29日</span>
<span class="na">formats</span><span class="pi">:</span>
  <span class="na">time</span><span class="pi">:</span> <span class="s">0</span> 

<span class="c1"># Busuanzi Analytics</span>
<span class="na">busuanzi</span><span class="pi">:</span> <span class="kc">true</span>

<span class="c1"># Umami Analytics</span>
<span class="na">umami</span><span class="pi">:</span>
  <span class="na">status</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">id</span><span class="pi">:</span> <span class="s">xxxxxxxxxxxxx</span>
  <span class="na">js</span><span class="pi">:</span> <span class="s">https://umami.example.com/umami.js</span>
</code></pre></div></div>

<h4 id="前端自动构建工作流优化">前端自动构建工作流优化</h4>

<p>  H2O 主题中使用了 Gulp + <del>Node-Sass</del> Sass 的方案来自动化前端构建工作流。不得不说，这个方案还是很不错的，只是随着 Gulp 和 <del>Node-Sass</del> Sass 版本的更新，对 NodeJS 环境及其他依赖库都有一些要求。这里，H2O-ac 主题在 package.json 文件中将所有库都更新到目前最新，对应版本列表如下所示。另外，为了减少一些第三方 CSS 样式的请求数，利用自动构建工作流将固定的第三方 CSS 样式文件合并并压缩为 plugins.min.css 文件。app.min.css 仍为多个自编写 CSS 样式文件的合并压缩。</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">运行环境或依赖库</th>
      <th style="text-align: center">版本号</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">NodeJS</td>
      <td style="text-align: center">v17.0.0</td>
    </tr>
    <tr>
      <td style="text-align: center">gulp</td>
      <td style="text-align: center">v4.0.2</td>
    </tr>
    <tr>
      <td style="text-align: center">gulp-clean-css</td>
      <td style="text-align: center">v4.3.0</td>
    </tr>
    <tr>
      <td style="text-align: center">gulp-rename</td>
      <td style="text-align: center">v20.0</td>
    </tr>
    <tr>
      <td style="text-align: center">gulp-sass</td>
      <td style="text-align: center">v5.0.0</td>
    </tr>
    <tr>
      <td style="text-align: center">gulp-uglify</td>
      <td style="text-align: center">v3.0.2</td>
    </tr>
    <tr>
      <td style="text-align: center">gulp-concat</td>
      <td style="text-align: center">v2.6.1</td>
    </tr>
    <tr>
      <td style="text-align: center"><del>node-sass</del></td>
      <td style="text-align: center"><del>v7.0.0</del></td>
    </tr>
    <tr>
      <td style="text-align: center">sass</td>
      <td style="text-align: center">v1.51.0</td>
    </tr>
  </tbody>
</table>

<h2 id="使用方法">使用方法</h2>

<h3 id="初始化">初始化</h3>

<h4 id="方式一从模板新建博客">方式一：从模板新建博客</h4>

<p>  为了方便用户使用 H2O-ac 主题，特别提供了 Github 的模板功能。如下图所示，访问 <a href="https://github.com/zhonger/jekyll-theme-H2O-ac">H2O-ac</a> 可以看到如下的 Use this template 按钮，点击该按钮即可用 H2O-ac 主题创建自己的博客代码仓库。想要了解更多步骤，可以访问 Github 官方文档之 <a href="https://docs.github.com/cn/repositories/creating-and-managing-repositories/creating-a-repository-from-a-template">从模板创建仓库</a>。</p>

<p><img src="https://i.lisz.top/blog/oHHZZh.webp" alt="从模板新建 Start the blog from the template" /></p>

<h4 id="方式二已有博客迁移">方式二：已有博客迁移</h4>

<p>  <del>暂时无法支持 gem 直接切换主题，后续将更新此方式。目前只能使用方式一创建仓库后，将文章的 markdown 文件复制到 _posts 目录下应用 H2O-ac 主题。</del></p>

<p>(2021年12月26日更新)</p>

<p>  现已支持使用 gem 直接切换主题 <code class="language-plaintext highlighter-rouge">jekyll-theme-h2o-ac</code>。同时，也推出了一键式构建工具 <a href="https://github.com/zhonger/easy-to-h2o-ac">easy-to-h2o-ac</a>，详细可以见项目主页。</p>

<h3 id="本地测试">本地测试</h3>

<p>  在进行本地测试时，如果需要修改一些样式，则需要先执行 <code class="language-plaintext highlighter-rouge">npm install</code> 来完成前端自动构建工作流依赖库的安装。注意，这里设定的可用 NodeJS 版本为 v17.0.0，使用老版本会报错。其次，务必使用 <code class="language-plaintext highlighter-rouge">bundle install</code> 安装主题所需的所有 Ruby 依赖库。最后执行 <code class="language-plaintext highlighter-rouge">bundle exec jekyll serve --livereload</code> 命令即可在本地实时同步预览。只要不修改 _config.yml 文件，不必中断后再启动。然后就是在 <code class="language-plaintext highlighter-rouge">_posts</code> 目录下写 markdown 文章即可。</p>

<h3 id="发布部署">发布部署</h3>

<p>  由于 Github 提供 Jekyll 静态生成器的静态页面托管，只要打开仓库的 Pages 功能，当推送更新到 Github 时即会自动部署。此处值得注意的是，如果代码仓库的名字不是 <code class="language-plaintext highlighter-rouge">username.github.io</code>，而也没有为该仓库的 Pages 提供自定义域名，那么这个仓库将会被部署到子目录，因此此时必须在 _config.yml 文件中设置 base_url，从而生成正常的静态页面。</p>

<h2 id="结束语">结束语</h2>

<p>  再次感谢廖柯宇及其他小伙伴们对 H2O 主题的付出，没有 H2O 主题就没有 H2O-ac 主题！H2O-ac 主题后续也将继续更新，欢迎小伙伴们使用和 <a href="https://github.com/zhonger/jekyll-theme-H2O-ac">Star</a>，也欢迎大家一起来贡献代码。</p>

<p>（Ps: <del>由于沿用了 H2O 的 Logo，可能会侵犯廖柯宇的版权。如果的确如此，后续将会设计一个新的 Logo。</del> 已采用新 Logo。）
（2022年1月10日更新）</p>]]></content><author><name>zhonger</name></author><category term="tech" /><category term="jekyll" /><category term="theme" /><category term="blog" /><category term="ac" /><category term="develop" /><category term="主题" /><category term="前端开发" /><category term="学术" /><category term="运维" /><summary type="html"><![CDATA[前言]]></summary></entry><entry><title type="html">MathJax Test</title><link href="https://gbcpp.github.io/test/mathjax-test.html" rel="alternate" type="text/html" title="MathJax Test" /><published>2017-07-30T00:00:00+00:00</published><updated>2017-07-30T00:00:00+00:00</updated><id>https://gbcpp.github.io/test/mathjax-test</id><content type="html" xml:base="https://gbcpp.github.io/test/mathjax-test.html"><![CDATA[<p>mathjax in markdown :)</p>

<p><strong>这是一个不<code class="language-plaintext highlighter-rouge">align</code>的公式</strong>：</p>

\[\forall \alpha \in A, \quad a \cdot b = 0\]

<p><strong>这是一个<code class="language-plaintext highlighter-rouge">align</code>的公式</strong>：</p>

\[\begin{align}
    \Phi(0,x) = \max_{u \in \mathcal{D}} \bigg[
        \mathbb{E} &amp; \Phi\left(1, 
        x + \int_0^1 \sigma^2(s) \, \zeta(s) \, u_s \, ds
        + \int_0^1 \sigma(s) \, dW_s
    \right) \\
        &amp;- \frac{1}{2} \int_0^1 \sigma^2(s) \, \zeta(s) \,
        \mathbb{E} u_s^2  \, ds
    \bigg].
\end{align}\]

<p><strong>注意：</strong>公式块要想有较好的显示效果，必须在公式块标记符<code class="language-plaintext highlighter-rouge">$$</code><strong>前后</strong>留有空行，否则公式将不能正常居中。行内公式无此问题。</p>]]></content><author><name>Mr Chen</name></author><category term="test" /><category term="mathjax" /><summary type="html"><![CDATA[mathjax in markdown :)]]></summary></entry><entry><title type="html">Hello Jekyll</title><link href="https://gbcpp.github.io/hello-jekyll.html" rel="alternate" type="text/html" title="Hello Jekyll" /><published>2017-04-18T00:00:00+00:00</published><updated>2017-04-18T00:00:00+00:00</updated><id>https://gbcpp.github.io/hello-jekyll</id><content type="html" xml:base="https://gbcpp.github.io/hello-jekyll.html"><![CDATA[<blockquote>
  <p>Transform your plain text into static websites and blogs.</p>
</blockquote>

<h3 id="welcome">Welcome</h3>

<p>This site aims to be a comprehensive guide to Jekyll. We’ll cover topics such as getting your site up and running, creating and managing your content, customizing the way your site works and looks, deploying to various environments, and give you some advice on participating in the future development of Jekyll itself.</p>

<h3 id="so-what-is-jekyll-exactlypermalink">So what is Jekyll, exactly?Permalink</h3>

<p>Jekyll is a simple, blog-aware, static site generator. It takes a template directory containing raw text files in various formats, runs it through a converter (like <a href="https://daringfireball.net/projects/markdown/">Markdown</a>) and our <a href="https://github.com/Shopify/liquid/wiki">Liquid</a> renderer, and spits out a complete, ready-to-publish static website suitable for serving with your favorite web server. Jekyll also happens to be the engine behind GitHub Pages, which means you can use Jekyll to host your project’s page, blog, or website from GitHub’s servers for free.</p>

<h3 id="helpful-hintspermalink">Helpful HintsPermalink</h3>

<p>Throughout this guide there are a number of small-but-handy pieces of information that can make using Jekyll easier, more interesting, and less hazardous. Here’s what to look out for.</p>

<h3 id="video-test">Video Test</h3>

<iframe type="text/html" width="100%" height="385" src="https://www.youtube.com/embed/gfmjMWjn-Xg" frameborder="0"></iframe>]]></content><author><name>Jekyll</name></author><category term="jekyll" /><summary type="html"><![CDATA[Transform your plain text into static websites and blogs.]]></summary></entry><entry><title type="html">H2O theme for Jekyll</title><link href="https://gbcpp.github.io/tech/new-theme-h2o.html" rel="alternate" type="text/html" title="H2O theme for Jekyll" /><published>2017-04-18T00:00:00+00:00</published><updated>2017-04-18T00:00:00+00:00</updated><id>https://gbcpp.github.io/tech/new-theme-h2o</id><content type="html" xml:base="https://gbcpp.github.io/tech/new-theme-h2o.html"><![CDATA[<p>正如我在<a href="http://weibo.com/1374146504/profile?topnav=1&amp;wvr=6">微博</a>上所说的，使用<a href="http://jekyll.com.cn/">Jekyll</a>半年以来一直没有令我满意的主题模板，所以开始计划自己写一套好看又好用的主题模板。设计之初就明确了极简主义，风格采用扁平化了，通过卡片式设计来进行区块分明的布局，参考了Medium的ui样式和知乎专栏的视觉风格。</p>

<h2 id="h2o">H2O</h2>

<p><a href="https://github.com/kaeyleo/jekyll-theme-H2O">源码及使用文档 →</a></p>

<p><img src="http://on2171g4d.bkt.clouddn.com/jekyll-theme-h2o-realhome.jpg" alt="" /></p>

<p>新主题名叫”H2O”，基于Jekyll 3.0.x（使用<code class="language-plaintext highlighter-rouge">gem update jekyll</code>升级Jekyll），Markdown的代码高亮不再支持pygments转而使用rouge，咱已经默认配置了 <code class="language-plaintext highlighter-rouge">highlighter: rouge</code> 。用到的技术栈也很简单：引入jQuery类库，使用Sass编写样式，使用Gulp来编译Sass、合并压缩css、js，开源在<a href="https://github.com/kaeyleo/jekyll-theme-H2O">Github</a>上，稍作配置即可用于你的Jekyll博客上。</p>

<p><img src="http://on2171g4d.bkt.clouddn.com/jekyll-theme-h2o-sketchdesign.png" alt="Design with Sketch" /></p>

<p>使用Sketch完成H2O主题的原型设计</p>

<p><img src="http://on2171g4d.bkt.clouddn.com/jekyll-theme-vs.jpg" alt="My Jekyll themes" /></p>

<p>比之前漂亮不少吧，下面聊聊H2O的新特性。</p>

<h2 id="新特性">新特性</h2>

<h3 id="主题配色">主题配色</h3>

<p>支持两种主题配色——蓝色和粉色。</p>

<p><img src="https://github.com/kaeyleo/jekyll-theme-H2O/blob/master/screenshot/jekyll-theme-h2o-themecolor.jpg?raw=true" alt="" /></p>

<h3 id="侧边栏">侧边栏</h3>

<p>相比自己上一个版本的博客主题，首页增加了侧边栏，方便展示博主的个人信息和文章标签。</p>

<h3 id="社交图标">社交图标</h3>

<p>使用阿里的图标管理平台<a href="http://iconfont.cn/">Iconfont</a>整理了一套<strike>墙内外</strike>常用的社交图标，包括微博、知乎、掘金、简书、Github等十多个网站，鼠标悬停会显示该站的主题色。</p>

<p><img src="http://on2171g4d.bkt.clouddn.com/jekyll-theme-h2o-snstext.jpg" alt="social iconfont" /></p>

<h3 id="前后文导航">前后文导航</h3>

<p><img src="http://on2171g4d.bkt.clouddn.com/jekyll-theme-h2o-nextpostnav.png" alt="Next post navigator" /></p>

<h3 id="自定义文章封面">自定义文章封面</h3>

<p>在Markdown的<a href="http://jekyll.com.cn/docs/frontmatter/">文章头信息</a>里添加cover参数来配置文章的封面图片，如果没有配置封面，则默认【主题色+底纹】的组合作为文章封面。值得一提的是，H2O有两种（粉、蓝）主题色和六种底纹（电路板、食物、云海、钻石等等）供你选择。</p>

<h3 id="头图个性化底纹">头图个性化底纹</h3>

<p>在没有图片的情况下单纯显示颜色会不会太无趣了点？于是想到了加入底纹元素，底纹素材是SVG格式的（保存在css样式里），加载比图片快很多。</p>

<p><img src="http://on2171g4d.bkt.clouddn.com/jekyll-theme-h2o-headerpatterns.jpg" alt="" /></p>

<h3 id="代码高亮">代码高亮</h3>

<p>模板引入了<a href="http://prismjs.com">Prism.js</a>，一款轻量、可扩展的代码语法高亮库。</p>

<p>很多知名网站如<a href="https://developer.mozilla.org/">MDN</a>、<a href="https://css-tricks.com/">css-tricks</a>也在用它，JavaScript 之父 <a href="https://brendaneich.com/">Brendan Eich</a> 也在个人博客上使用。</p>

<p><img src="http://on2171g4d.bkt.clouddn.com/jekyll-theme-h2o-highlight.png" alt="代码高亮" /></p>

<p>遵循 <a href="https://www.w3.org/TR/html5/grouping-content.html#the-pre-element">HTML5</a> 标准，Prism 使用语义化的 <code class="language-plaintext highlighter-rouge">&lt;pre&gt;</code> 元素和 <code class="language-plaintext highlighter-rouge">&lt;code&gt;</code> 元素来标记代码区块：</p>

<div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;pre&gt;&lt;code</span> <span class="na">class=</span><span class="s">"language-css"</span><span class="nt">&gt;</span>p { color: red }<span class="nt">&lt;/code&gt;&lt;/pre&gt;</span>
</code></pre></div></div>

<p>在Markdown中你可以这样写：</p>

<div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">```</span><span class="nl">css
</span><span class="nt">p</span> <span class="p">{</span> <span class="nl">color</span><span class="p">:</span> <span class="no">red</span> <span class="p">}</span>
<span class="p">```</span>
</code></pre></div></div>

<p>支持语言：</p>

<ul>
  <li>HTML</li>
  <li>CSS</li>
  <li>Sass</li>
  <li>JavaScript</li>
  <li>CoffeeScript</li>
  <li>Java</li>
  <li>C-like</li>
  <li>Swift</li>
  <li>PHP</li>
  <li>Go</li>
  <li>Python</li>
</ul>

<h3 id="第三方评论">第三方评论</h3>

<p>由于多说关闭，又对国内其他第三方评论插件无感，所以将<a href="https://disqus.com/">Disqus</a>列为首选（目前模板也只提供了这个），请自备梯子。</p>

<h3 id="移动端优化">移动端优化</h3>

<p>响应式设计，对手机和平板等移动设备做了优化。</p>

<p><img src="http://on2171g4d.bkt.clouddn.com/jekyll-theme-h2o-realm.png" alt="" /></p>

<h3 id="关于阅读体验">关于阅读体验</h3>

<p>我认为在内容质量相同的情况下，出色的沉浸式阅读体验是博客的核心。</p>

<p>H2O在这方面还有很多需要完善的地方，比如：<strike>代码高亮</strike>、夜间模式、查看大图…</p>

<h3 id="其他特性">其他特性：</h3>

<ul>
  <li>网页标题SEO优化</li>
  <li>标签索引，点击标签跳转到标签目录，即可查看对应的全部文章</li>
  <li>漂亮</li>
  <li>好看</li>
  <li>美</li>
</ul>

<h2 id="最后">最后</h2>

<p>本想趁这次机会将整站https化的，但折腾了半天发现弹性web托管并不支持，所以暂时搁置https的想法。另外，博客统计工具一直使用的是<a href="https://tongji.baidu.com">百度统计</a>，这次新增了Google Analytics。</p>

<p>这次从0到1，独自设计、开发再到发布大约用了一周时间，也算完成一个小小的开源项目了，后续也将持续完善和更新，欢迎<a href="https://github.com/kaeyleo/jekyll-theme-H2O">Star</a>。</p>]]></content><author><name>kaeyleo</name></author><category term="tech" /><category term="jekyll" /><category term="前端开发" /><category term="设计" /><summary type="html"><![CDATA[正如我在微博上所说的，使用Jekyll半年以来一直没有令我满意的主题模板，所以开始计划自己写一套好看又好用的主题模板。设计之初就明确了极简主义，风格采用扁平化了，通过卡片式设计来进行区块分明的布局，参考了Medium的ui样式和知乎专栏的视觉风格。]]></summary></entry></feed>