<!DOCTYPE html>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script>


<html lang="zh-Hans">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›´æ’­åœºæ™¯TCPç§’å¼€ä¼˜åŒ– - Mr Chen</title>
    <meta name="author"  content="Mr Chen">
    <meta name="description" content="ç›´æ’­åœºæ™¯TCPç§’å¼€ä¼˜åŒ–">
    <meta name="keywords"  content="Life, Protocol">
    <!-- Open Graph -->
    <meta property="og:title" content="ç›´æ’­åœºæ™¯TCPç§’å¼€ä¼˜åŒ– - Mr Chen">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://gbcpp.github.io/notes/tcp-optimize-livestream-scene.html">
    <meta property="og:baseurl" content="">
    <meta property="og:description" content="ä¸ªäººçš„ä¸€ä¸ªæŠ€æœ¯åšå®¢ç«™ç‚¹ï¼Œä¸»è¦ç”¨äºè®°å½•ä¸ªäººåœ¨å­¦ä¹ è¿‡ç¨‹ä¸­é‡åˆ°çš„æŠ€æœ¯é—®é¢˜åŠè§£å†³æ–¹æ³•ã€æŠ€æœ¯å®éªŒï¼Œä»¥åŠä¸€äº›æ¯”è¾ƒæœ‰è¶£çš„äº‹æƒ…ã€‚">
    <meta property="og:site_name" content="Mr Chen">
    <meta property="og:gray" content="false">
    
    <meta property="og:previous_url" content="/notes/optimize-back-to-source.html">
    
    
    <meta property="og:next_url" content="/notes/ubuntu24.04-static-ip.html">
    
    <meta property="post-date-format" content="0">
    
    <meta property="post-date" content="2025-01-10 00:00:00 +0000" />
    
    
    
    <meta name="theme-color" content="#81BBFF" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="apple-touch-icon" href="/assets/img/touch/apple-touch-icon.png"/>
    <link rel="Shortcut Icon" href="/favicon.ico">
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="bookmark" href="/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.1.0/style.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5.2.0/github-markdown-light.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css">
    
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prism-themes@1.9.0/themes/prism-one-light.min.css" />
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.28.0/plugins/line-numbers/prism-line-numbers.min.css">
    
    <link rel="stylesheet" href="/assets/css/app.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@waline/client/dist/waline.css" />
    <script src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
</head>



<body class="line-numbers" ontouchstart="">




  <!--[if lt IE 10]>
  <div class="alert-danger" role="alert">ä½ çš„æµè§ˆå™¨å®åœ¨å¤ªå¤ªå¤ªæ—§äº†ï¼Œæ”¾å­¦åˆ«èµ°ï¼Œå‡çº§å®Œæµè§ˆå™¨å†è¯´ï¼<a target="_blank" class="alert-link" href="http://browsehappy.com">ç«‹å³å‡çº§</a></div>
  <![endif]-->
  
  <div id="all" class="post" data-theme="default">
  
    <div class="alert-tip" id="no-previous">
      å·²ç»æ˜¯æœ€æ–°ä¸€ç¯‡æ–‡ç« äº†ï¼
    </div>
    <div class="alert-tip" id="no-next">
      å·²ç»æ˜¯æœ€åä¸€ç¯‡æ–‡ç« äº†ï¼
    </div>
    <input id="nm-switch" type="hidden" value="false"> <header class="g-header" data-theme="default">
    <div class="g-logo">
      <a href="/" aria-label="logo"></a>
    </div>
    <!-- <i id="menu-toggle" class="iconfont icon-menu"></i> -->
    <div id="mode-toggle">
        <svg class="icon icon-day" aria-hidden="true">
            <use xlink:href="#icon-day"></use>
        </svg>
        <svg class="icon icon-night" aria-hidden="true">
            <use xlink:href="#icon-night"></use>
        </svg>
    </div>
    <svg id="menu-toggle" class="icon-menu" aria-hidden="true">
        <use xlink:href="#icon-menu"></use>
    </svg>
    <nav class="g-nav">
        <ul>
            
                
                <li>
                    <a href="/" aria-label="home">
                        home
                    </a>
                </li>
                
            
                
                <li>
                    <a href="/blog/index.html" aria-label="blog">
                        blog
                    </a>
                </li>
                
            
                
                <li>
                    <a href="/archives.html" aria-label="archives">
                        archives
                    </a>
                </li>
                
            
                
                <li>
                    <a href="/tags.html" aria-label="tags">
                        tags
                    </a>
                </li>
                
            
                
                <li class="dropdown">
                    <a class="dropdown-toggle"> about </a>
                    <ul class="dropdown-menu">
                    
                        <li>
                            <a href="/feed.xml" aria-label="RSS">
                                RSS
                            </a>
                        </li>
                    
                    </ul> 
                </li>
                
            
            <li class="mode">
                <svg class="icon day" aria-hidden="true">
                    <use xlink:href="#icon-day"></use>
                </svg>
                <svg class="icon night" aria-hidden="true">
                    <use xlink:href="#icon-night"></use>
                </svg>
            </li>
        </ul>
    </nav>
</header>


    <header
      class="g-banner post-header post-pattern-circuitBoard bgcolor-default "
      data-theme="default"
    >
      <div class="post-wrapper">
        <div class="post-tags">
          
            
              <a href="/tags.html#Life" class="post-tag">Life</a>
            
              <a href="/tags.html#Protocol" class="post-tag">Protocol</a>
            
          
        </div>
        <h1>ç›´æ’­åœºæ™¯TCPç§’å¼€ä¼˜åŒ–</h1>
        <div class="post-meta">
          <span class="post-meta-item">
            <svg class="icon" aria-hidden="true">
              <use xlink:href="#icon-user"></use>
            </svg>
            Mr Chen
          </span>
          <time class="post-meta-item" datetime="25-01-10">
            <svg class="icon" aria-hidden="true">
              <use xlink:href="#icon-calendar"></use>
            </svg>
            <span class="create-at"></span>
          </time>
          <time class="post-meta-item" datetime="25-01-10">
            <svg class="icon" aria-hidden="true">
              <use xlink:href="#icon-update"></use>
            </svg>
            <span class="update-at"></span>
          </time>
            <span class="post-meta-item">
              <svg class="icon words" aria-hidden="true">
                <use xlink:href="#icon-words"></use>
              </svg>
              
              æœ¬æ–‡æ€»å…±  13.0k  å­—
            </span>
            <span class="post-meta-item">
              <svg class="icon time" aria-hidden="true">
                <use xlink:href="#icon-time"></use>
              </svg>
              é˜…è¯»å…¨æ–‡å¤§çº¦éœ€è¦ 38 åˆ†é’Ÿ
            </span>
            
              <span class="post-meta-item">
                <svg class="icon pv" aria-hidden="true">
                  <use xlink:href="#icon-pv"></use>
                </svg>
                æœ¬æ–‡æ€»é˜…è¯»é‡ <span id="busuanzi_value_page_pv"></span> æ¬¡
              </span>
            
            
        </div>
      </div>
      
      <div class="filter"></div>
        <div class="post-cover" style="background: url('/assets/img/shan.jpg') center no-repeat; background-size: cover;"></div>
      
    </header>
    <div class="post-content visible">
      

      
      
      <div class="container">  
        <div class="contents">
          <article class="markdown-body post">
              
            <blockquote>
  <p>å½“å‰å…¬å¸ç›´æ’­é¡¹ç›®æ‹¨æµ‹çš„ç§’å¼€æŒ‡æ ‡è¿œæœªè¾¾åˆ°é¢„æœŸï¼Œç»è¿‡æ•°æ®å¯¹æ¯”å’Œåˆ†æï¼Œå‘ç°åœ¨æ‹¨æµ‹èŠ‚ç‚¹ Player ä¸è¾¹ç¼˜èŠ‚ç‚¹ä¹‹é—´çš„ Lastmile ç½‘ç»œè´¨é‡ä¸Šå­˜åœ¨æ¯”è¾ƒå¤§çš„é—®é¢˜ï¼Œç”±äºç›®å‰ Player çš„æ‹‰æµåè®®ä½¿ç”¨çš„æ˜¯åŸºäº TCP çš„æ ‡å‡†åè®®(HTTP-FLVï¼‰ï¼Œå¹¶ä¸” Player ä½äºç¬¬ä¸‰æ–¹å¹³å°ï¼Œä¸å—æ§åˆ¶ï¼Œæ‰€ä»¥é‡ç‚¹åªèƒ½é€šè¿‡å•è¾¹ä¼˜åŒ–å…¬å¸è¾¹ç¼˜èŠ‚ç‚¹ä¸ Player ä¹‹é—´çš„ TCP è¿æ¥å‚æ•°ï¼Œå°½é‡åŠ å¿« TCP çš„å»ºè¿å’Œæ•°æ®ä¸‹å‘çš„é€Ÿåº¦ã€‚</p>
</blockquote>

<h1 id="ç°çŠ¶">ç°çŠ¶</h1>

<p>å…¬å¸ä½¿ç”¨é™æ€èŠ‚ç‚¹å’ŒåŠ¨æ€èŠ‚ç‚¹ä½œä¸ºè¾¹ç¼˜ä»¥èŠ‚çœæˆæœ¬ï¼Œä¸”å¤šç§ä¸šåŠ¡é›†ä¸­è¿›è¡Œæ··å¸ƒï¼Œå…¶ä¸­åŠ¨æ€èŠ‚ç‚¹è´¨é‡è¾ƒå·®ï¼Œä½†æˆæœ¬è¾ƒä½ï¼Œä¹Ÿæ˜¯å¯¼è‡´é—®é¢˜çš„å…³é”®æ‰€åœ¨ï¼Œåœ¨å¯¹Linux å†…æ ¸çš„å‡çº§å’Œå‚æ•°è°ƒæ•´æ“ä½œä¸Šä¸€å®šè¦æ…é‡ã€‚</p>

<p><strong>å½“å‰åŠ¨æ€èŠ‚ç‚¹ç‰ˆæœ¬åŠç›¸å…³é…ç½®ï¼š</strong></p>

<ul>
  <li>å†…æ ¸ç‰ˆæœ¬ï¼š5.4.119-19-0006</li>
  <li>è§ä¸‹é¢ç« èŠ‚</li>
</ul>

<h1 id="ä¼˜åŒ–éªŒè¯">ä¼˜åŒ–éªŒè¯</h1>

<h2 id="ç¯å¢ƒå‡†å¤‡">ç¯å¢ƒå‡†å¤‡</h2>

<h3 id="tc-é…ç½®">TC é…ç½®</h3>

<p>é¦–å…ˆå®‰è£… tc å·¥å…·ï¼Œç³»ç»Ÿé»˜è®¤ä¸å®‰è£…ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt update
<span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> iproute2

tc <span class="nt">--version</span>
</code></pre></div></div>

<p><strong>å¯åŠ¨é…ç½®ç½‘æŸ:</strong></p>

<p>æ¯”å¦‚é…ç½® <code class="language-plaintext highlighter-rouge">lo</code> ç½‘å¡ 50ï½150ms å·¦å³çš„å»¶è¿Ÿï¼Œä¸”åŒ…å« 0ï½15% çš„ä¸€ä¸ªéšæœºä¸¢åŒ…ï¼Œé…ç½®å¦‚ä¸‹ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>su
<span class="nv">$ </span>tc qdisc add dev lo root netem delay 50ms 25ms distribution normal loss random 0% 15%

<span class="c"># æŸ¥çœ‹é…ç½®æ˜¯å¦ç”Ÿæ•ˆ</span>
<span class="nv">$ </span>tc qdisc show dev lo
  qdisc netem 8002: root refcnt 2 limit 1000 delay 50ms  25ms
</code></pre></div></div>

<p><strong>éªŒè¯ï¼š</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ping 127.0.0.1 <span class="nt">-i</span> 0.2
PING 127.0.0.1 <span class="o">(</span>127.0.0.1<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
64 bytes from 127.0.0.1: <span class="nv">icmp_seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>64 <span class="nb">time</span><span class="o">=</span>102 ms
64 bytes from 127.0.0.1: <span class="nv">icmp_seq</span><span class="o">=</span>2 <span class="nv">ttl</span><span class="o">=</span>64 <span class="nb">time</span><span class="o">=</span>115 ms
64 bytes from 127.0.0.1: <span class="nv">icmp_seq</span><span class="o">=</span>3 <span class="nv">ttl</span><span class="o">=</span>64 <span class="nb">time</span><span class="o">=</span>175 ms
64 bytes from 127.0.0.1: <span class="nv">icmp_seq</span><span class="o">=</span>4 <span class="nv">ttl</span><span class="o">=</span>64 <span class="nb">time</span><span class="o">=</span>80.4 ms
<span class="nt">---</span> 127.0.0.1 ping statistics <span class="nt">---</span>
21 packets transmitted, 20 received, 4.7619% packet loss, <span class="nb">time </span>4016ms
rtt min/avg/max/mdev <span class="o">=</span> 48.201/113.013/207.390/42.338 ms, pipe 2
</code></pre></div></div>

<p><strong>æ¢å¤ï¼š</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># åˆ é™¤é…ç½®</span>
<span class="nv">$ </span>tc qdisc del dev lo root
</code></pre></div></div>

<p><strong>æ³¨æ„ï¼š</strong> ä¸è¦æ— è„‘ copy åˆ«äººçš„ tc é…ç½®å‘½ä»¤ï¼Œä½¿ç”¨äº† <code class="language-plaintext highlighter-rouge">channge</code> è€Œé <code class="language-plaintext highlighter-rouge">add</code>ï¼Œå¯¼è‡´ <code class="language-plaintext highlighter-rouge">Error: Qdisc not found. To create specify NLM_F_CREATE flag.</code> æŠ¥é”™ï¼Œè¿˜ä»¥ä¸ºå†…æ ¸ç¼ºå°‘ sch_netem æ¨¡å—ï¼Œå·®ç‚¹é‡æ–°å®‰è£…å®Œæ•´å†…æ ¸ã€‚
å¯ä»¥é€šè¿‡å‘½ä»¤ï¼š<code class="language-plaintext highlighter-rouge">modinfo sch_netem</code> æŸ¥çœ‹ç³»ç»Ÿæ˜¯å¦å·²ç»å®‰è£…æœ‰ <code class="language-plaintext highlighter-rouge">sche_netem</code> æ¨¡å—ï¼Œå¦‚æœæ²¡æœ‰å°±ä¼šæŠ¥é”™ï¼Œæœ‰çš„è¯ä¼šæœ‰æ¨¡å—ä¿¡æ¯è¾“å‡ºï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>filename:       /lib/modules/6.8.0-51-generic/kernel/net/sched/sch_netem.ko.zst
description:    Network characteristics emulator qdisc
license:        GPL
srcversion:     7631AD62974660130A36DCA
depends:
retpoline:      Y
intree:         Y
name:           sch_netem
vermagic:       6.8.0-51-generic SMP preempt mod_unload modversions
sig_id:         PKCS#7
signer:         Build <span class="nb">time </span>autogenerated kernel key
sig_key:        29:0D:80:5A:E0:B3:D6:D4:D4:D3:D0:EF:AB:48:F3:DB:73:58:2F:63
sig_hashalgo:   sha512
signature:      03:A4:1E:0E:CA:01:0F:58:3E:93:93:A7:25:97:FC:82:3E:4F:60:CA:
                00:84:75:DF:A3:20:F7:1B:92:9D:B1:58:6D:E2:47:92:84:83:00:FD:
                ...
</code></pre></div></div>

<h3 id="netperf">NetPerf</h3>

<ul>
  <li>å¯åŠ¨ netserver</li>
</ul>

<p>å¯åŠ¨ <code class="language-plaintext highlighter-rouge">netserver</code>, <code class="language-plaintext highlighter-rouge">netserver</code> ä¸ <code class="language-plaintext highlighter-rouge">netperf</code> æ˜¯åŒä¸€å¥— Toolsï¼Œåªæ˜¯ server æµ‹å¯åŠ¨å‘½ä»¤ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>~<span class="nv">$ </span>netserver <span class="nt">-h</span>

Usage: netserver <span class="o">[</span>options]

Options:
    <span class="nt">-h</span>                Display this text
    <span class="nt">-D</span>                Do not daemonize
    <span class="nt">-d</span>                Increase debugging output
    <span class="nt">-f</span>                Do not spawn chilren <span class="k">for </span>each <span class="nb">test</span>, run serially
    <span class="nt">-L</span> name,family    Use name to pick listen address and family <span class="k">for </span>family
    <span class="nt">-N</span>                No debugging output, even <span class="k">if </span>netperf asks
    <span class="nt">-p</span> portnum        Listen <span class="k">for </span>connect requests on portnum.
    <span class="nt">-4</span>                Do IPv4
    <span class="nt">-6</span>                Do IPv6
    <span class="nt">-v</span> verbosity      Specify the verbosity level
    <span class="nt">-V</span>                Display version information and <span class="nb">exit</span>
    <span class="nt">-Z</span> passphrase     Expect passphrase as the first thing received


<span class="c"># å¯åŠ¨å‘½ä»¤</span>
<span class="nv">$ </span>~<span class="nv">$ </span><span class="nb">sudo </span>netserver <span class="nt">-p</span> 1234 <span class="nt">-D</span> <span class="nt">-4</span>
check_if_inetd: enter
setup_listens: enter
create_listens: called with host <span class="s1">'0.0.0.0'</span> port <span class="s1">'1234'</span> family AF_INET<span class="o">(</span>2<span class="o">)</span>
getaddrinfo returned the following <span class="k">for </span>host <span class="s1">'0.0.0.0'</span> port <span class="s1">'1234'</span>  family AF_INET
        cannonical name: <span class="s1">'(nil)'</span>
        flags: 1 family: AF_INET: socktype: SOCK_STREAM protocol IPPROTO_TCP addrlen 16
        sa_family: AF_INET sadata: 4 210 0 0 0 0 0 0 0 0 0 0 0 0 0 0
Starting netserver with host <span class="s1">'IN(6)ADDR_ANY'</span> port <span class="s1">'1234'</span> and family AF_INET
accept_connections: enter
set_fdset: enter list 0x5f3130ac4740 fd_set 0x7fff92fb9450
setting 3 <span class="k">in </span>fdset

</code></pre></div></div>

<p>ä½¿ <code class="language-plaintext highlighter-rouge">netserver</code> ç›‘å¬åœ¨ 1234 ç«¯å£ä¸Šï¼Œå¹¶æŒ‡å®š IPv4 åè®®ï¼Œ-D è¡¨ç¤ºä¸åœ¨åå°è¿è¡Œã€‚</p>

<ul>
  <li>å¯åŠ¨ Client</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netperf <span class="nt">-H</span> 127.0.0.1  <span class="nt">-p</span> 1234 <span class="nt">-l</span> 10  <span class="nt">-t</span> TCP_CRR <span class="nt">--</span> <span class="nt">-r</span> 100,3000000
</code></pre></div></div>

<p>å‚æ•°è¯´æ˜ï¼š
-Hï¼š æŒ‡å®š server çš„ IP åœ°å€
-pï¼š æŒ‡å®š server çš„ port
-lï¼š æŒ‡å®šæµ‹è¯•è¿è¡Œå¤šé•¿æ—¶é—´ï¼Œå•ä½ï¼šç§’
-tï¼š è¿è¡Œæ¨¡å¼ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">TCP_CRR</code> æ¥æ¨¡æ‹Ÿ client è¯·æ±‚ä¸ server å»ºè¿ä»¥åï¼Œç”±server ä¸‹å‘ä¸€å®šçš„æ•°æ®é‡ä»¥åï¼Œå…³é—­è¿æ¥çš„è¿™ç§ request/response æ¨¡å¼
-rï¼š åˆ†åˆ«æŒ‡å®š request å’Œ response çš„å­—èŠ‚æ•°å¤§å°</p>

<h2 id="é»˜è®¤é…ç½®benchmark">é»˜è®¤é…ç½®Benchmark</h2>

<p>è®°å½•ä¸‹å½“å‰å†…æ ¸å‚æ•°ä¸­ä¸ tcp ç›¸å…³çš„é…ç½®ï¼Œå¹¶è·å–å½“å‰é…ç½®çš„ Benchmark æ•°æ®ï¼Œç”¨ä»¥åœ¨åç»­çš„ä¼˜åŒ–ä¸­è¿›è¡Œå¯¹æ¯”ã€‚
é¦–å…ˆç›´æ¥ç”¨ <code class="language-plaintext highlighter-rouge">netperf</code> æ‰§è¡Œ 20åˆ†é’Ÿçš„æµ‹è¯•æ•°æ®è·å–ï¼š</p>

<p>é¦–å…ˆè·å–ä¸‹å½“å‰æµ‹è¯•æµçš„å…³é”®å¸§çš„å¤§å°ç”¨ä»¥æ¨¡æ‹Ÿå°½é‡è´´è¿‘å®é™…ä¸šåŠ¡åœºæ™¯çš„æ¨¡æ‹Ÿï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># é¦–å…ˆ dump åˆ°æœ¬åœ°</span>
ffmpeg <span class="nt">-i</span> http://xxxx/yyyyy/zzzzzzz.flv <span class="nt">-c</span> copy  1.flv

<span class="c"># ç„¶åè·å–è¯¥ç‰‡æ®µçš„çš„é¦–ä¸ªå…³é”®å¸§çš„å¤§å°</span>
ffmpeg <span class="nt">-i</span> 1.flv <span class="nt">-frames</span>:v 1 <span class="nt">-f</span> image2pipe <span class="nt">-vcodec</span> mjpeg - | <span class="nb">wc</span> <span class="nt">-c</span>

<span class="c"># å¯ä»¥çœ‹åˆ°æœ€åè¾“å‡ºçš„ä¸ºï¼š117118ï¼Œå³ 114KB å·¦å³ã€‚</span>
</code></pre></div></div>

<p>netperf æ¨¡æ‹Ÿ Player è¯·æ±‚ä¸‹å‘ç›´æ’­æ•°æ®ï¼Œè¿™é‡Œè®¾ç½®è®© server ä¸€æ¬¡æ€§ä¸‹å‘ 300KB çš„æ•°æ®ï¼ŒåŒæ—¶å‡è®¾ Client çš„ request é»˜è®¤ä¸º 1KB,
æµ‹è¯• 20åˆ†é’Ÿï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<p><strong>æµ‹è¯•æ•°æ®ï¼š</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>~<span class="nv">$ </span>netperf <span class="nt">-H</span> 127.0.0.1  <span class="nt">-p</span> 1234 <span class="nt">-l</span> 1200  <span class="nt">-t</span> TCP_CRR <span class="nt">--</span> <span class="nt">-r</span> 1000,3000000
MIGRATED TCP Connect/Request/Response TEST from 0.0.0.0 <span class="o">(</span>0.0.0.0<span class="o">)</span> port 0 AF_INET to 127.0.0.1 <span class="o">()</span> port 0 AF_INET : demo
Local /Remote
Socket Size   Request  Resp.   Elapsed  Trans.
Send   Recv   Size     Size    Time     Rate
bytes  Bytes  bytes    bytes   secs.    per sec

16384  131072 100      3000000  100.01      0.79
16384  131072
</code></pre></div></div>

<blockquote>
  <p>ä¸Šè¿°æµ‹è¯•æ•°æ®è¾“å‡ºçš„ <code class="language-plaintext highlighter-rouge">Local /Remote</code> å¯ä»¥çœ‹åˆ°åœ¨ä¸‹é¢å¤šå‡ºä¸€è¡Œï¼Œåˆ†åˆ«è¡¨ç¤ºçš„æ˜¯ local å’Œ remote çš„ socket send and recv bufferâ€™s bytesã€‚
æœ€åä¸€åˆ— <code class="language-plaintext highlighter-rouge">Trans</code> è¡¨ç¤ºçš„ä¾¿æ˜¯åœ¨æµ‹è¯•çš„è¿™æ®µæ—¶é—´å†…å¹³å‡æ¯ç§’é’Ÿå¯ä»¥æ‰§è¡Œäº†å¤šå°‘æ¬¡è¯·æ±‚ï¼Œå³ 0.79 æ¬¡ï¼Œç›¸å½“äº Qpsï¼Œè¶Šå¤§è¯´æ˜æ•ˆç‡è¶Šé«˜ã€‚</p>
</blockquote>

<h1 id="tcp-å†…æ ¸å‚æ•°ä¼˜åŒ–">TCP å†…æ ¸å‚æ•°ä¼˜åŒ–ï¼š</h1>

<p><a href="https://www.kernel.org/doc/Documentation/networking/ip-sysctl.txt" rel="nofollow" target="_blank" class="extlinks">å†…æ ¸ç½‘ç»œå‚æ•°è¯´æ˜</a></p>

<h2 id="å†…æ ¸å‚æ•°é…ç½®">å†…æ ¸å‚æ•°é…ç½®</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@XXXLink64 ~]# sysctl <span class="nt">-a</span> | <span class="nb">grep</span> <span class="s2">"net</span><span class="se">\.</span><span class="s2">ipv4</span><span class="se">\.</span><span class="s2">tcp"</span>

<span class="c"># ä¸‹é¢ 4 ä¸ªå‚æ•°ä¸åŒºåˆ†åè®®</span>
<span class="c"># é»˜è®¤çš„ socket æ¥æ”¶çª—å£å¤§å° ï¼ˆbytesï¼‰</span>
net.core.rmem_default <span class="o">=</span> 327680
<span class="c"># æœ€å¤§çš„ socket æ¥æ”¶çª—å£å¤§å° ï¼ˆbytesï¼‰</span>
net.core.rmem_max <span class="o">=</span> 327680
<span class="c"># é»˜è®¤çš„ socket å‘é€çª—å£å¤§å° ï¼ˆbytesï¼‰</span>
net.core.wmem_default <span class="o">=</span> 327680
<span class="c"># æœ€å¤§çš„ socket å‘é€çª—å£å¤§å° ï¼ˆbytesï¼‰</span>
net.core.wmem_max <span class="o">=</span> 3276800

<span class="c"># åœ¨æ¯ä¸ªç½‘ç»œæ¥å£æ¥æ”¶æ•°æ®åŒ…çš„é€Ÿç‡æ¯”å†…æ ¸å¤„ç†è¿™äº›åŒ…çš„é€Ÿç‡å¿«æ—¶ï¼Œå…è®¸é€åˆ°é˜Ÿåˆ—çš„æ•°æ®åŒ…çš„æœ€å¤§æ•°ç›®ï¼Œé»˜è®¤å€¼æ˜¯ 1000</span>
net.core.netdev_max_backlog <span class="o">=</span> 3000

<span class="c"># å®šä¹‰äº†ç³»ç»Ÿä¸­æ¯ä¸€ä¸ªç«¯å£æœ€å¤§çš„ç›‘å¬é˜Ÿåˆ—çš„é•¿åº¦ï¼Œæ˜¯ä¸ªå…¨å±€çš„å‚æ•°</span>
net.core.somaxconn <span class="o">=</span> 2048

<span class="c"># è¡¨ç¤ºæ¯ä¸ªå¥—æ¥å­—æ‰€å…è®¸çš„æœ€å¤§ç¼“å†²åŒºçš„å¤§å°</span>
net.core.optmem_max <span class="o">=</span> 81920

<span class="c"># è‡ªåŠ¨è°ƒæ•´ tcp recv buffer</span>
net.ipv4.tcp_moderate_rcvbuf <span class="o">=</span> 1
net.ipv4.tcp_rmem <span class="o">=</span> 131072      1048576 49152000
net.ipv4.tcp_wmem <span class="o">=</span> 12288000    49152000        98304000
net.ipv4.udp_rmem_min <span class="o">=</span> 4096
net.ipv4.udp_wmem_min <span class="o">=</span> 4096
vm.lowmem_reserve_ratio <span class="o">=</span> 256   256     32      0       0

<span class="c"># ç”¨äºæ§åˆ¶å½“æœåŠ¡å™¨çš„ç›‘å¬é˜Ÿåˆ—ï¼ˆlisten é˜Ÿåˆ—ï¼‰æº¢å‡ºæ—¶ï¼Œæ˜¯å¦å‘å®¢æˆ·ç«¯å‘é€ TCP é‡ç½®ï¼ˆRSTï¼‰ä¿¡å·ä»¥ç»ˆæ­¢è¿æ¥</span>
net.ipv4.tcp_abort_on_overflow <span class="o">=</span> 0

<span class="c"># å†…æ ¸ä¸­ä¸ TCP çª—å£å¤§å°ç›¸å…³çš„ä¸€ä¸ªå‚æ•°ï¼Œå®ƒå½±å“æ¥æ”¶çª—å£çš„å¤§å°è°ƒæ•´è¡Œä¸º</span>
net.ipv4.tcp_adv_win_scale <span class="o">=</span> 1

net.ipv4.tcp_allowed_congestion_control <span class="o">=</span> reno cubic bbr
net.ipv4.tcp_app_win <span class="o">=</span> 31

<span class="c"># å°½é‡åˆå¹¶åŒ…ä¸€èµ·å‘é€ï¼Œå‡å°‘å‘åŒ…æ•°é‡ã€‚enable äº†ä¼šå¢åŠ å»¶è¿Ÿï¼Œå»ºè®®å…³é—­</span>
net.ipv4.kcp_autocorking <span class="o">=</span> 1

net.ipv4.tcp_available_congestion_control <span class="o">=</span> reno cubic bbr
net.ipv4.tcp_available_ulp <span class="o">=</span> 
net.ipv4.tcp_base_mss <span class="o">=</span> 1024
net.ipv4.tcp_challenge_ack_limit <span class="o">=</span> 1000
net.ipv4.tcp_comp_sack_delay_ns <span class="o">=</span> 1000000
net.ipv4.tcp_comp_sack_nr <span class="o">=</span> 44
net.ipv4.tcp_congestion_control <span class="o">=</span> bbr
net.ipv4.tcp_dsack <span class="o">=</span> 1
net.ipv4.tcp_early_demux <span class="o">=</span> 1
net.ipv4.tcp_early_retrans <span class="o">=</span> 3
net.ipv4.tcp_ecn <span class="o">=</span> 2
net.ipv4.tcp_ecn_fallback <span class="o">=</span> 1
net.ipv4.tcp_fack <span class="o">=</span> 0
net.ipv4.tcp_fastopen <span class="o">=</span> 1
net.ipv4.tcp_fastopen_blackhole_timeout_sec <span class="o">=</span> 3600
net.ipv4.tcp_fastopen_key <span class="o">=</span> 5b1b3bb0-e9881f5a-8bf3fda0-1c410b36
net.ipv4.tcp_fin_timeout <span class="o">=</span> 30
net.ipv4.tcp_frto <span class="o">=</span> 2
net.ipv4.tcp_fwmark_accept <span class="o">=</span> 0
net.ipv4.tcp_inherit_buffsize <span class="o">=</span> 1
net.ipv4.tcp_init_cwnd <span class="o">=</span> 15
net.ipv4.tcp_init_rto <span class="o">=</span> 1000
net.ipv4.tcp_invalid_ratelimit <span class="o">=</span> 500

<span class="c"># TCPå‘é€keepaliveæ¢æµ‹æ¶ˆæ¯çš„é—´éš”æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œç”¨äºç¡®è®¤TCPè¿æ¥æ˜¯å¦æœ‰æ•ˆ</span>
net.ipv4.tcp_keepalive_time <span class="o">=</span> 7200
<span class="c"># æ¢æµ‹æ¶ˆæ¯æœªè·å¾—å“åº”æ—¶ï¼Œé‡å‘è¯¥æ¶ˆæ¯çš„é—´éš”æ—¶é—´ï¼ˆç§’ï¼‰</span>
net.ipv4.tcp_keepalive_intvl <span class="o">=</span> 75
<span class="c"># åœ¨è®¤å®šTCPè¿æ¥å¤±æ•ˆä¹‹å‰ï¼Œæœ€å¤šå‘é€å¤šå°‘ä¸ªkeepaliveæ¢æµ‹æ¶ˆæ¯</span>
net.ipv4.tcp_keepalive_probes <span class="o">=</span> 9

net.ipv4.tcp_l3mdev_accept <span class="o">=</span> 0
net.ipv4.tcp_limit_output_bytes <span class="o">=</span> 1048576
net.ipv4.tcp_loss_init_cwnd <span class="o">=</span> 10
<span class="c"># å…è®¸TCP/IPæ ˆé€‚åº”åœ¨é«˜ååé‡æƒ…å†µä¸‹ä½å»¶æ—¶çš„æƒ…å†µï¼Œè¿™ä¸ªé€‰é¡¹åº”è¯¥ç¦ç”¨</span>
net.ipv4.tcp_low_latency <span class="o">=</span> 0
net.ipv4.tcp_max_orphans <span class="o">=</span> 524288
net.ipv4.tcp_max_reordering <span class="o">=</span> 300
net.ipv4.tcp_max_syn_backlog <span class="o">=</span> 62144
net.ipv4.tcp_max_tw_buckets <span class="o">=</span> 6000
net.ipv4.tcp_mem <span class="o">=</span> 2621440      3932160 5242880
net.ipv4.tcp_min_rtt_wlen <span class="o">=</span> 300
net.ipv4.tcp_min_snd_mss <span class="o">=</span> 48
net.ipv4.tcp_min_tso_segs <span class="o">=</span> 2
net.ipv4.tcp_moderate_rcvbuf <span class="o">=</span> 1
net.ipv4.tcp_mtu_probe_floor <span class="o">=</span> 48
net.ipv4.tcp_mtu_probing <span class="o">=</span> 0
net.ipv4.tcp_no_metrics_save <span class="o">=</span> 1
net.ipv4.tcp_notsent_lowat <span class="o">=</span> 8388608
net.ipv4.tcp_orphan_retries <span class="o">=</span> 0

net.ipv4.tcp_pacing_ca_ratio <span class="o">=</span> 120
net.ipv4.tcp_pacing_ss_ratio <span class="o">=</span> 200
net.ipv4.tcp_probe_interval <span class="o">=</span> 600
net.ipv4.tcp_probe_threshold <span class="o">=</span> 8
net.ipv4.tcp_proc_sched <span class="o">=</span> 1
net.ipv4.tcp_recovery <span class="o">=</span> 1
net.ipv4.tcp_reordering <span class="o">=</span> 5
net.ipv4.tcp_retrans_collapse <span class="o">=</span> 1
net.ipv4.tcp_retries1 <span class="o">=</span> 5
net.ipv4.tcp_retries2 <span class="o">=</span> 15
net.ipv4.tcp_rfc1337 <span class="o">=</span> 0
net.ipv4.tcp_rmem <span class="o">=</span> 131072      1048576 16384000
net.ipv4.tcp_rto_max <span class="o">=</span> 120
net.ipv4.tcp_rto_min <span class="o">=</span> 200
net.ipv4.tcp_rx_skb_cache <span class="o">=</span> 0
net.ipv4.tcp_sack <span class="o">=</span> 1
net.ipv4.tcp_slow_start_after_idle <span class="o">=</span> 0
net.ipv4.tcp_stdurg <span class="o">=</span> 0
net.ipv4.tcp_syn_retries <span class="o">=</span> 2
net.ipv4.tcp_synack_retries <span class="o">=</span> 2
net.ipv4.tcp_synack_rto_interval <span class="o">=</span> 200

<span class="c"># è¡¨ç¤ºæ˜¯å¦æ‰“å¼€TCPåŒæ­¥æ ‡ç­¾ï¼ˆsyncookieï¼‰ï¼Œå†…æ ¸å¿…é¡»æ‰“å¼€äº†CONFIG_SYN_COOKIESé¡¹è¿›è¡Œç¼–è¯‘ï¼ŒåŒæ­¥æ ‡ç­¾å¯ä»¥é˜²æ­¢ä¸€ä¸ªå¥—æ¥å­—åœ¨æœ‰è¿‡å¤šè¯•å›¾è¿æ¥åˆ°è¾¾æ—¶å¼•èµ·è¿‡è½½</span>
net.ipv4.tcp_syncookies <span class="o">=</span> 1
net.ipv4.tcp_thin_linear_timeouts <span class="o">=</span> 0

<span class="c"># TCPæ—¶é—´æˆ³ï¼ˆä¼šåœ¨TCPåŒ…å¤´å¢åŠ 12ä¸ªå­—èŠ‚ï¼‰ï¼Œä»¥ä¸€ç§æ¯”é‡å‘è¶…æ—¶æ›´ç²¾ç¡®çš„æ–¹æ³•ï¼ˆå‚è€ƒRFC 1323ï¼‰æ¥å¯ç”¨å¯¹RTT çš„è®¡ç®—ï¼Œä¸ºå®ç°æ›´å¥½çš„æ€§èƒ½åº”è¯¥å¯ç”¨è¿™ä¸ªé€‰é¡¹</span>
net.ipv4.tcp_timestamps <span class="o">=</span> 1
net.ipv4.tcp_tso_win_divisor <span class="o">=</span> 3
net.ipv4.tcp_tw_ignore_syn_tsval_zero <span class="o">=</span> 1

<span class="c"># è¡¨ç¤ºæ˜¯å¦å…è®¸å°†å¤„äºTIME-WAITçŠ¶æ€çš„socketï¼ˆTIME-WAITçš„ç«¯å£ï¼‰ç”¨äºæ–°çš„TCPè¿æ¥ </span>
net.ipv4.tcp_tw_reuse <span class="o">=</span> 1
<span class="c"># å¯¹äºæœ¬ç«¯æ–­å¼€çš„socketè¿æ¥ï¼ŒTCPä¿æŒåœ¨FIN-WAIT-2çŠ¶æ€çš„æ—¶é—´ï¼ˆç§’ï¼‰ã€‚å¯¹æ–¹å¯èƒ½ä¼šæ–­å¼€è¿æ¥æˆ–ä¸€ç›´ä¸ç»“æŸè¿æ¥æˆ–ä¸å¯é¢„æ–™çš„è¿›ç¨‹æ­»äº¡</span>
net.ipv4.tcp_fin_timeout <span class="o">=</span> 30

<span class="c"># èƒ½å¤Ÿæ›´å¿«åœ°å›æ”¶TIME-WAITå¥—æ¥å­—</span>
net.ipv4.tcp_tw_recycle <span class="o">=</span> 1
net.ipv4.tcp_tw_timeout <span class="o">=</span> 60
net.ipv4.tcp_tx_skb_cache <span class="o">=</span> 0
net.ipv4.tcp_wan_timestamps <span class="o">=</span> 0
net.ipv4.tcp_window_scaling <span class="o">=</span> 1
net.ipv4.tcp_wmem <span class="o">=</span> 4096000     16384000        32768000
net.ipv4.tcp_workaround_signed_windows <span class="o">=</span> 0
</code></pre></div></div>

<h2 id="ä¼˜åŒ–å†…å®¹">ä¼˜åŒ–å†…å®¹</h2>

<blockquote>
  <p>ä»¥ä¸‹å‡ä¸ºä»…ä¼˜åŒ–å•è¾¹çš„ Server æµ‹å‚æ•°ã€‚</p>
</blockquote>

<h3 id="bbr">BBR</h3>

<p>ç¼–è¾‘ <code class="language-plaintext highlighter-rouge">/etc/sysctl.conf</code>ï¼Œæ·»åŠ æˆ–ä¿®æ”¹å¦‚ä¸‹å‚æ•°ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># è®¾ç½® tcp æ‹¥å¡ç®—æ³•ä¸º bbr</span>
net.ipv4.tcp_congestion_control <span class="o">=</span> bbr

</code></pre></div></div>

<p>ä½¿å‚æ•°ç«‹å³ç”Ÿæ•ˆï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>sysctl <span class="nt">-p</span>
</code></pre></div></div>

<p><strong>æµ‹è¯•ç»“æœ</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>~<span class="nv">$ </span>netperf <span class="nt">-H</span> 127.0.0.1  <span class="nt">-p</span> 1234 <span class="nt">-l</span> 300  <span class="nt">-t</span> TCP_CRR <span class="nt">--</span> <span class="nt">-r</span> 1000,3000000
MIGRATED TCP Connect/Request/Response TEST from 0.0.0.0 <span class="o">(</span>0.0.0.0<span class="o">)</span> port 0 AF_INET to 127.0.0.1 <span class="o">()</span> port 0 AF_INET : demo
Local /Remote
Socket Size   Request  Resp.   Elapsed  Trans.
Send   Recv   Size     Size    Time     Rate
bytes  Bytes  bytes    bytes   secs.    per sec

436600 87380  100      3000000  300.00      1.06
436600 87380
</code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°åœ¨å¼€å¯äº† bbr æ‹¥å¡ç®—æ³•åï¼Œ<code class="language-plaintext highlighter-rouge">Trans</code> ç”± 0.79 å‡åˆ°äº† 1.06ï¼Œæœ‰äº†æ˜æ˜¾çš„æå‡ã€‚
ä½†æ˜¯å®é™…ä¼˜åŒ–æ•°æ®ä¸ä¼šè¿™ä¹ˆæ˜æ˜¾ï¼Œå› ä¸ºçº¿ä¸Šç¯å¢ƒæˆ‘ä»¬åªèƒ½å¼€å¯ server æµ‹çš„ bbrï¼Œè€Œæ— æ³•æ§åˆ¶ client åŒæ—¶å¼€å¯ã€‚</p>

<h3 id="socketbuffer">SocketBuffer</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>sysctl <span class="nt">-a</span> | egrep <span class="s2">"rmem|wmem|adv_win|moderate"</span>
net.core.rmem_default <span class="o">=</span> 327680
net.core.rmem_max <span class="o">=</span> 327680
net.core.wmem_default <span class="o">=</span> 327680
net.core.wmem_max <span class="o">=</span> 3276800
net.ipv4.tcp_adv_win_scale <span class="o">=</span> 1
net.ipv4.tcp_moderate_rcvbuf <span class="o">=</span> 1
net.ipv4.tcp_rmem <span class="o">=</span> 131072      1048576 49152000
net.ipv4.tcp_wmem <span class="o">=</span> 12288000    49152000        98304000
net.ipv4.udp_rmem_min <span class="o">=</span> 4096
net.ipv4.udp_wmem_min <span class="o">=</span> 4096
vm.lowmem_reserve_ratio <span class="o">=</span> 256   256     32      0       0
</code></pre></div></div>

<p><strong>æµ‹è¯•ç»“æœå¯¹æ¯”</strong></p>

<ul>
  <li>ä¸Šè¿°é»˜è®¤é…ç½®ï¼Œæ— è°ƒæ•´ buffer</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>netperf <span class="nt">-H</span> 100.100.57.20  <span class="nt">-p</span> 1234 <span class="nt">-l</span> 600  <span class="nt">-t</span> TCP_CRR <span class="nt">--</span> <span class="nt">-r</span> 1000,300000
MIGRATED TCP Connect/Request/Response TEST from <span class="o">(</span>null<span class="o">)</span> <span class="o">(</span>0.0.0.0<span class="o">)</span> port 0 AF_INET to <span class="o">(</span>null<span class="o">)</span> <span class="o">()</span> port 0 AF_INET : demo
Local /Remote
Socket Size   Request  Resp.   Elapsed  Trans.
Send   Recv   Size     Size    Time     Rate
bytes  Bytes  bytes    bytes   secs.    per sec

131072 131072 1000     300000  599.99      1.59
16384000 1048576
</code></pre></div></div>

<ul>
  <li>å¼ºåˆ¶64KB buffer</li>
</ul>

<p>é…ç½® net.ipv4.tcp_wmem ä¸º 65536 åçš„æµ‹è¯•ç»“æœ <code class="language-plaintext highlighter-rouge">sysctl -w net.ipv4.tcp_wmem="65536 65536 65536"</code> :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>netperf <span class="nt">-H</span> 100.100.57.20  <span class="nt">-p</span> 1234 <span class="nt">-l</span> 600  <span class="nt">-t</span> TCP_CRR <span class="nt">--</span> <span class="nt">-r</span> 1000,300000
MIGRATED TCP Connect/Request/Response TEST from <span class="o">(</span>null<span class="o">)</span> <span class="o">(</span>0.0.0.0<span class="o">)</span> port 0 AF_INET to <span class="o">(</span>null<span class="o">)</span> <span class="o">()</span> port 0 AF_INET : demo
Local /Remote
Socket Size   Request  Resp.   Elapsed  Trans.
Send   Recv   Size     Size    Time     Rate
bytes  Bytes  bytes    bytes   secs.    per sec

131072 131072 1000     300000  599.99      1.16
65535  1048576
</code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°ä¹‹å‰é…ç½®äº† 64KB çš„ send buffer åï¼ŒTrans ç”± 1.59 ä¸‹é™åˆ°äº† 1.16ï¼Œæœ‰æ˜æ˜¾çš„ä¸‹é™ï¼Œä½†æ˜¯ä¸Šè¿°é…ç½®æ˜¯å°† minã€defaultã€max å‡å…¨éƒ¨å¼ºè¡Œé…ç½®ä¸º 64KBï¼Œå¤±å»äº†åŠ¨æ€ä¼¸ç¼©çš„èƒ½åŠ›ï¼Œå¦‚æœä»…é…ç½® default ä¸º 64KBï¼Œä¸é™åˆ¶æœ€å¤§å€¼ï¼Œåˆ™ä¸å—å½±å“ã€‚</p>

<h3 id="tcp_fastopen">tcp_fastopen</h3>

<p>åœ¨ä¸Šè¿°é…ç½®ä¸­ï¼Œtcp_fastopen é…ç½®ä¸º 1ï¼Œå³ä»…å¼€å¯ Client çš„ fastopenï¼Œè€Œæœªå¼€å¯ server æµ‹çš„ fastopenï¼Œä¸æ˜¯æœ€ä½³é…ç½®ï¼Œéœ€è¦è°ƒæ•´ä¸º 3 åŒæ—¶å¼€å¯ client å’Œ server æµ‹çš„ fastopenã€‚
tcp_fastopen é…ç½®é¡¹è¯´æ˜ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tcp_fastopen - INTEGER
	Enable TCP Fast Open (RFC7413) to send and accept data in the opening
	SYN packet.

	The client support is enabled by flag 0x1 (on by default). The client
	then must use sendmsg() or sendto() with the MSG_FASTOPEN flag,
	rather than connect() to send data in SYN.

	The server support is enabled by flag 0x2 (off by default). Then
	either enable for all listeners with another flag (0x400) or
	enable individual listeners via TCP_FASTOPEN socket option with
	the option value being the length of the syn-data backlog.

	The values (bitmap) are

	=====  ======== ======================================================
	  0x1  (client) enables sending data in the opening SYN on the client.
	  0x2  (server) enables the server support, i.e., allowing data in
			a SYN packet to be accepted and passed to the
			application before 3-way handshake finishes.
	  0x4  (client) send data in the opening SYN regardless of cookie
			availability and without a cookie option.
	0x200  (server) accept data-in-SYN w/o any cookie option present.
	0x400  (server) enable all listeners to support Fast Open by
			default without explicit TCP_FASTOPEN socket option.
	=====  ======== ======================================================

</code></pre></div></div>

<h2 id="ç»“è®º">ç»“è®º</h2>

<p>åœ¨ç›®å‰ç¯å¢ƒä¸­çš„å†…æ ¸é…ç½®ä¸­ï¼Œå¯¹é¦–å¼€æœ‰æ˜æ˜¾å½±å“çš„åªæœ‰ä¸¤ä¸ªå‚æ•°ï¼š1ã€BBR çš„æ‹¥å¡ç®—æ³•ï¼›2ã€TCP çš„ send buffer æœ€å¤§å€¼è¦è¶³å¤Ÿå¤§ï¼›3ã€å¼€å¯ tcp_fastopen éœ€è¦å¼€å¯ server æµ‹ï¼Œè‡³å°‘ä¸º 2ã€‚</p>

<h1 id="è·¯ç”±ä¼˜åŒ–è®°å½•">è·¯ç”±ä¼˜åŒ–è®°å½•</h1>

<p>ç›´æ’­ç‰‡æºé€‰ç”¨ 3.4Mbps çš„ç ç‡ï¼Œæ’­æ”¾å™¨é€‰æ‹© ffplay è¿›è¡Œæ‹‰å–ï¼Œåœ¨å‘é€ç«¯ï¼ˆç›´æ’­æœåŠ¡å™¨ï¼‰é€šè¿‡ tcpdump æŠ“åŒ…ï¼Œå¯¹æ¯”æŸ¥çœ‹å‘é€ 1MB æ•°æ®æ‰€è€—è´¹çš„æ—¶é—´çº¿ï¼Œè¿™é‡Œæ˜¯å±€åŸŸç½‘ç¯å¢ƒï¼Œæ‰€ä»¥ lastmile çš„å¸¦å®½ä¸æ˜¯ç“¶é¢ˆã€‚</p>

<p>Tcp çš„ initcwnd é»˜è®¤å€¼ä¸º 10ï¼Œå€˜è‹¥è®¾ç½®è¿‡å¤§ä¼šé€ æˆå¯¹ç½‘ç»œçš„å†²å‡»ï¼Œæ ¹æ®ç»éªŒé€‰æ‹©<code class="language-plaintext highlighter-rouge">é»˜è®¤é…ç½® 10</code> ä¸ <code class="language-plaintext highlighter-rouge">40</code> ä¸¤è€…ä¹‹é—´è¿›è¡Œå¯¹æ¯”ã€‚</p>

<h2 id="ç¯å¢ƒå‡†å¤‡-1">ç¯å¢ƒå‡†å¤‡</h2>

<p>é¦–å…ˆåœ¨å‘é€ç«¯ç›´æ’­æœåŠ¡å™¨ä¸Šä¸ºæŒ‡å®šç½‘å¡å¢åŠ  100ms çš„ä¸»åŠ¨å»¶è¿Ÿï¼Œä»¥æ”¾å¤§æ•°æ®å½±å“ï¼Œæ–¹ä¾¿å¯¹æ¯”ç»“æœã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># å¢åŠ  100ms çš„å›ºå®šå»¶è¿Ÿ
$ sudo tc qdisc change dev eno1 root netem delay 100ms
  
# ping éªŒè¯
$ ping 100.100.32.108
PING 100.100.32.108 (100.100.32.108) 56(84) bytes of data.
64 bytes from 100.100.32.108: icmp_seq=1 ttl=63 time=104 ms
64 bytes from 100.100.32.108: icmp_seq=2 ttl=63 time=103 ms
64 bytes from 100.100.32.108: icmp_seq=3 ttl=63 time=104 ms
64 bytes from 100.100.32.108: icmp_seq=4 ttl=63 time=103 ms
^C
--- 100.100.32.108 ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3003ms
rtt min/avg/max/mdev = 102.763/103.307/103.550/0.322 ms
</code></pre></div></div>

<h2 id="case1">Case1</h2>

<blockquote>
  <p>æœªä¿®æ”¹ tcp initcwnd çš„æµ‹è¯•åœºæ™¯ã€‚</p>
</blockquote>

<ul>
  <li>åœ¨å‘é€ç«¯ï¼ˆç›´æ’­æœåŠ¡å™¨ï¼‰æµ‹æŠ“åŒ…ï¼š
    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>sudo tcpdump -i eno1 -s 1500 tcp and host 100.100.32.108 and port 8080 -w tcp_10cwnd_100msdelay.pcap
</code></pre></div>    </div>
  </li>
  <li>åœ¨è¿œç«¯è¿›è¡Œæ‹‰æµï¼ˆ100.100.32.108ï¼‰ï¼š</li>
</ul>

<p>â€ƒâ€ƒæ‹‰å–æ’­æ”¾ 10ç§’å·¦å³å³å¯ã€‚</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ffplay http://100.100.57.20:8080/ztest/A123.flv\?domain\=h3.xxx.com
</code></pre></div></div>

<ul>
  <li>Wireshark åˆ†æï¼š</li>
</ul>

<p>â€ƒâ€ƒå¯ä»¥çœ‹åˆ°å¦‚ä¸‹æˆªå›¾ï¼Œæ¥æ”¶ 1 * 10^6 å³1MBçš„æ•°æ®æ—¶å¤§çº¦è€—æ—¶åœ¨ 900msã€‚
<img src="/assets/img/blog/tcp_10cwnd_100ms.png" alt="TCP 10 INITCWND åˆ†æå›¾"></p>

<h2 id="case2">Case2</h2>

<p>è°ƒæ•´ initcwnd ä¸º 40ï¼Œé€šè¿‡ ip route è¿›è¡Œè°ƒæ•´ã€‚</p>

<ul>
  <li>é¦–å…ˆé€šè¿‡ <code class="language-plaintext highlighter-rouge">sudo ip route show</code> è¿›è¡ŒæŸ¥çœ‹ï¼š</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~$ sudo ip route show
default via 100.100.56.254 dev eno1 initcwnd 10
default via 100.100.56.254 dev eno1 proto static metric 100
default via 100.100.56.254 dev eno1 proto dhcp src 100.100.57.20 metric 100
100.100.56.0/23 dev eno1 proto static scope link initcwnd 10
100.100.56.0/23 dev eno1 proto kernel scope link src 100.100.57.20 metric 100
100.100.56.254 dev eno1 scope link initcwnd 10
172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 linkdown
</code></pre></div></div>

<ul>
  <li>ç„¶åä¾æ¬¡å¯¹å„ route è¿›è¡Œé…ç½®ï¼š</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo ip route change 100.100.56.254 dev eno1 scope link initcwnd 40
sudo ip route change via 100.100.56.254 dev eno1  initcwnd 40
sudo ip route change 100.100.56.0/23 dev eno1 proto static scope link  initcwnd 40
</code></pre></div></div>

<ul>
  <li>é…ç½®åå¦‚ä¸‹ï¼š</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ~$ sudo ip route show
default via 100.100.56.254 dev eno1 initcwnd 40
default via 100.100.56.254 dev eno1 proto static metric 100
default via 100.100.56.254 dev eno1 proto dhcp src 100.100.57.20 metric 100
100.100.56.0/23 dev eno1 proto static scope link initcwnd 40
100.100.56.0/23 dev eno1 proto kernel scope link src 100.100.57.20 metric 100
100.100.56.254 dev eno1 scope link initcwnd 40
172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 linkdown
</code></pre></div></div>

<ul>
  <li>åœ¨å‘é€ç«¯ï¼ˆç›´æ’­æœåŠ¡å™¨ï¼‰æµ‹æŠ“åŒ…</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo tcpdump -i eno1 -s 1500 tcp and host 100.100.32.108 and port 8080 -w tcp_40cwnd_100msdelay.pcap
</code></pre></div></div>

<ul>
  <li>Wireshark åˆ†æ</li>
</ul>

<p>â€ƒâ€ƒå¯ä»¥çœ‹åˆ° init cwnd ä¸º 40 åï¼Œåœ¨ tcp çš„æ…¢å¯åŠ¨çŠ¶æ€å‘åŒ…å˜å¾—å¾ˆæ¿€è¿›ï¼Œæ¥æ”¶ç«¯æ¥æ”¶ 1MB çš„æ•°æ®å¤§çº¦ä¸º 550msï¼ŒèŠ‚çœäº†å¤§çº¦ 350msï¼Œå¤§çº¦ 3 ä¸ª rtt çš„æ—¶é—´ã€‚
<img src="/assets/img/blog/tcp_40cwnd_100ms.png" alt="TCP 40 INITCWND åˆ†æå›¾"></p>

<h2 id="ç»“è®º-1">ç»“è®º</h2>

<p>â€ƒâ€ƒå¦‚ä¸Šï¼Œè°ƒæ•´ INITCWND ä¸º 40åï¼Œåœ¨ç§’å¼€æ•°æ®ä¸º 1MB çš„åœºæ™¯ä¸­ï¼Œå¤§çº¦å¯ä¸ºç§’å¼€èŠ‚çœ 3 ä¸ªå·¦å³çš„ rtt æ—¶é—´ï¼Œä¸‹ä¸€æ­¥å¯ä»¥åœ¨çº¿ä¸Šè¿›è¡Œåˆæ­¥çš„éªŒè¯ï¼Œå¯é€æ­¥æ”¾å¼€è¯¥å€¼ä¸º 20ã€30ã€40ï¼Œåœ¨æ•°æ®ä¸æ–­çš„ä¼˜åŒ–çš„æƒ…å†µä¸‹é™ä½è°ƒæ•´é£é™©ï¼Œé€æ­¥å®ç°ä¼˜åŒ–ã€‚</p>


            <div class="post-copyright">
              <p>
                <span>ç‰ˆæƒå£°æ˜ï¼š</span>
                å¦‚æ— ç‰¹åˆ«å£°æ˜ï¼Œæœ¬æ–‡ç‰ˆæƒå½’
                <a href="https://gbcpp.github.io" class="cplink">Mr Chen</a>
                æ‰€æœ‰ï¼Œè½¬è½½è¯·æ³¨æ˜æœ¬æ–‡é“¾æ¥ã€‚ 
              </p>
              
                <p> 
                  ï¼ˆé‡‡ç”¨ 
                  <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" class="extlinks">CC BY-NC-SA 4.0</a> 
                  è®¸å¯åè®®è¿›è¡Œæˆæƒï¼‰
                </p>
              
              <p><span>æœ¬æ–‡æ ‡é¢˜ï¼š</span>ã€Š ç›´æ’­åœºæ™¯TCPç§’å¼€ä¼˜åŒ– ã€‹</p>
              <p><span>æœ¬æ–‡é“¾æ¥ï¼š</span><a href="https://gbcpp.github.io/notes/tcp-optimize-livestream-scene.html" class="cplink">https://gbcpp.github.io/notes/tcp-optimize-livestream-scene.html</a></p>
              <p class="tips">æœ¬æ–‡æœ€åä¸€æ¬¡æ›´æ–°ä¸º <span></span> å¤©å‰ï¼Œæ–‡ç« ä¸­çš„æŸäº›å†…å®¹å¯èƒ½å·²è¿‡æ—¶ï¼</p>
            </div>
          </article>
        </div>   
        <div class="table-of-contents">
          <h2>ç›®å½•</h2>
          <ul><li><a onclick="scrollToAdjust('ç°çŠ¶')">ç°çŠ¶</a></li><li><a onclick="scrollToAdjust('ä¼˜åŒ–éªŒè¯')">ä¼˜åŒ–éªŒè¯</a><ul><li><a onclick="scrollToAdjust('ç¯å¢ƒå‡†å¤‡')">ç¯å¢ƒå‡†å¤‡</a><ul><li><a onclick="scrollToAdjust('tc-é…ç½®')">TC é…ç½®</a></li><li><a onclick="scrollToAdjust('netperf')">NetPerf</a></li></ul></li><li><a onclick="scrollToAdjust('é»˜è®¤é…ç½®benchmark')">é»˜è®¤é…ç½®Benchmark</a></li></ul></li><li><a onclick="scrollToAdjust('tcp-å†…æ ¸å‚æ•°ä¼˜åŒ–')">TCP å†…æ ¸å‚æ•°ä¼˜åŒ–ï¼š</a><ul><li><a onclick="scrollToAdjust('å†…æ ¸å‚æ•°é…ç½®')">å†…æ ¸å‚æ•°é…ç½®</a></li><li><a onclick="scrollToAdjust('ä¼˜åŒ–å†…å®¹')">ä¼˜åŒ–å†…å®¹</a><ul><li><a onclick="scrollToAdjust('bbr')">BBR</a></li><li><a onclick="scrollToAdjust('socketbuffer')">SocketBuffer</a></li><li><a onclick="scrollToAdjust('tcp_fastopen')">tcp_fastopen</a></li></ul></li><li><a onclick="scrollToAdjust('ç»“è®º')">ç»“è®º</a></li></ul></li><li><a onclick="scrollToAdjust('è·¯ç”±ä¼˜åŒ–è®°å½•')">è·¯ç”±ä¼˜åŒ–è®°å½•</a><ul><li><a onclick="scrollToAdjust('ç¯å¢ƒå‡†å¤‡')">ç¯å¢ƒå‡†å¤‡</a></li><li><a onclick="scrollToAdjust('case1')">Case1</a></li><li><a onclick="scrollToAdjust('case2')">Case2</a></li><li><a onclick="scrollToAdjust('ç»“è®º')">ç»“è®º</a></li></ul></li></ul>
        </div>
      </div>
      

      
      <div class="social-share-wrapper">
        <div class="social-share"></div>
      </div>
      
    </div>

    <div>
     
     <section class="post-footer-item comment" style="padding-bottom: 4em">
     <div id="gitalk_container"></div>
     <div id="disqus_thread"></div>
     </section>
     
    </div>

    <section class="author-detail">
      <section class="post-footer-item author-card">
        <div class="avatar">
          <img src="/assets/img/wx_avatar.jpg" alt="">
        </div>
        <div class="author-name" rel="author">Mr Chen</div>
        <div class="bio">
          <p>èµ„æ·±æµåª’ä½“å¼€å‘å·¥ä½œè€…</p>
        </div>
        
        <ul class="sns-links">
          
          <li>
            <a href="https://github.com/gbcpp" target="_blank" aria-label="github">
              <svg class="icon" aria-hidden="true">
                <use xlink:href="#icon-github"></use>
              </svg>
            </a>
          </li>
          
          <li>
            <a href="https://blog.csdn.net/m0_59561186?spm=1010.2135.3001.5343)" target="_blank" aria-label="csdn">
              <svg class="icon" aria-hidden="true">
                <use xlink:href="#icon-csdn"></use>
              </svg>
            </a>
          </li>
          
        </ul>
        
      </section>
      <section class="post-footer-item read-next">
        
        <div class="read-next-item">
          <a href="/notes/optimize-back-to-source.html" class="read-next-link" aria-label="ç›´æ’­å›æºä¼˜åŒ–"></a>
          <section>
            <span>ç›´æ’­å›æºä¼˜åŒ–</span>
            <p>  è¯¥æ–‡æ¡£ä¸»è¦è€ƒè™‘çš„æ˜¯é’ˆå¯¹éœ€è¦å›æºæ—¶ç§’å¼€çš„ä¼˜åŒ–ã€‚</p>
          </section>
          
          <div class="filter"></div>
          <img src="/assets/img/shan.jpg" alt="">
          
      </div>
        

        
        <div class="read-next-item">
          <a href="/notes/ubuntu24.04-static-ip.html" class="read-next-link" aria-label="Ubuntu24.04 é…ç½®é™æ€ IP"></a>
            <section>
              <span>Ubuntu24.04 é…ç½®é™æ€ IP</span>
              <p>  å…¬å¸é»˜è®¤ç»™é…ç½®çš„ 2016 å¹´çš„ MBPï¼Œå®åœ¨å¿å—ä¸äº†é€€è€Œæ±‚å…¶æ¬¡ç”³è¯·äº†ä¸€å°å°å¼æœºä½œä¸ºå¼€å‘æœºã€å·¥ä½œç«™ä½¿ç”¨ã€‚å®‰è£…çš„...</p>
            </section>
            
            <div class="filter"></div>
            <img src="/assets/img/shan.jpg" alt="">
            
        </div>
        
      </section>
      
   
      

      
    </section>

  
  <script>
    var gitalk = new Gitalk({
      id: '2025-01-10 00:00:00 +0000',
      clientID: '7795ee35cc3373147f6e',  //è¿™é‡Œå…¶å®å¯ä»¥ç›´æ¥å¡«å€¼ï¼Œä½†æ˜¯è€ƒè™‘åˆ°é¡µé¢å®‰å…¨æ€§ï¼Œè¿˜æ˜¯é€šè¿‡é…ç½®çš„æ–¹å¼æ·»åŠ 
      clientSecret: '3c90889603d18c17cfd73289591b50a716925392',
      repo: 'gbcpp.github.io',
      owner: 'gbcpp',
      admin: 'gbcpp',
      distractionFreeMode: 'true'
    })

    gitalk.render('disqus_thread')
  </script>
  

    


<footer class="g-footer">
  <div class="g-container">
    <div class="g-left">
      <section class="links">
        æœ¬ç«™ç”± <a href="//jekyllrb.com" target="_blank" class="extlinks">Jekyll</a> å’Œ (åŸºäº <a href="https://github.com/kaeyleo/jekyll-theme-H2O" target="_blank" class="extlinks">H2O</a> çš„) <a href="https://github.com/zhonger/jekyll-theme-H2O-ac" target="_blank" class="extlinks">H2O-ac</a> å¼ºåŠ›é©±åŠ¨
         (<a href="https://github.com/zhonger/jekyll-theme-H2O-ac/releases/tag/v.1.2.1" target="_blank" class="extlinks">v1.2.1</a>)  
        
      </section>
      <section class="links">Mr Chen Â©
        
        
          2023
          -
        
        2025
        
          <a href="https://beian.miit.gov.cn/" target="_blank" class="extlinks">æ²ªICPå¤‡xxxxxxxxå·</a>
        
      </section>
      
      <section>
        <span id="busuanzi_container_site_pv">
          ğŸ‘ï¸ æ€»æµè§ˆé‡ <span id="busuanzi_value_site_pv"></span> <b>Â·</b>
        </span>
        <span id="busuanzi_container_site_uv">
          ğŸ‘¤ æ€»è®¿é—®é‡ <span id="busuanzi_value_site_uv"></span>
        </span>
      </section>
      
      <section>
        
      </section>
    </div>
    <div class="g-right">
      
      
    </div>
    
  </div>
</footer>
<div class="cookie-tip">
   ä¸ºäº†æå‡æœ¬ç«™çš„ä½¿ç”¨ä½“éªŒå’Œå¿…è¦åŠŸèƒ½çš„æ­£å¸¸ä½¿ç”¨ï¼Œæœ¬ç«™ä¼šä½¿ç”¨æœ¬åœ° Cookieã€‚è¯¦ç»†è¯·æŸ¥çœ‹ã€Œ <a href="/tos.html">æœ¬ç«™ä½¿ç”¨æ¡æ¬¾</a> ã€äº†è§£æ›´å¤šã€‚

  <button id="accept-tos">åŒæ„</button>
</div>
<button id="list" aria-label="Scroll back to top" class="mobile-list" type="button">
  <svg class="icon list day" aria-hidden="true">
    <use xlink:href="#icon-list-day"></use>
  </svg>
  <svg class="icon list night" aria-hidden="true">
    <use xlink:href="#icon-list-night"></use>
  </svg>
  <svg class="icon exit day" aria-hidden="true">
    <use xlink:href="#icon-exit-day"></use>
  </svg>
  <svg class="icon exit night" aria-hidden="true">
    <use xlink:href="#icon-exit-night"></use>
  </svg>
</button>
<button id="bttb" aria-label="Scroll back to top" class="bttb" type="button">
  <svg class="icon up day" aria-hidden="true">
    <use xlink:href="#icon-up-day"></use>
  </svg>
  <svg class="icon up night" aria-hidden="true">
    <use xlink:href="#icon-up-night"></use>
  </svg>
</button>


    
    <div class="modal">
        <div class="modal-content">
          <header>
            <span class="close">&times;</span>
          </header>
          <div class="container"></div>
        </div>
    </div>
    
  </div>

  <script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script>
  <script>
    socialShare('.social-share', {
      sites: [
        
          'wechat'
          ,
          
        
          'weibo'
          ,
          
        
          'douban'
          ,
          
        
          'twitter'
          
        
      ],
      wechatQrcodeTitle: "åˆ†äº«åˆ°å¾®ä¿¡æœ‹å‹åœˆ",
      wechatQrcodeHelper: '<p>æ‰«ç åç‚¹å‡»å³ä¸Šè§’</p><p>å°†æœ¬æ–‡åˆ†äº«è‡³æœ‹å‹åœˆ</p>'
    });
    $("a.social-share-icon").each(function() {
      $(this).attr("aria-label", $(this).attr("class").split(' ')[1])
    });
  </script>

  

  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
  <script src="/assets/js/app.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hotkeys-js/dist/hotkeys.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js" async></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.2/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.2/plugin/customParseFormat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.2/plugin/relativeTime.js"></script>
  <script>
    /**
    * Better Scroll Experience
    */
    function scrollToAdjust(id){
      var element = document.getElementById(id);
      var headerOffset = 90;
      var elementPosition = element.getBoundingClientRect().top;
      var offsetPosition = elementPosition + window.scrollY - headerOffset;
      window.scrollTo({
          top: offsetPosition,
          behavior: "smooth"
      });
    }
      // ç»™å›¾ç‰‡æ·»åŠ é“¾æ¥
      $(document).ready(function() {
          var baseurl = $("meta[property='og:baseurl']").attr('content');
          $("p img").each(function() {
              $(this).attr('data-src', $(this).attr('src')).removeAttr('src').addClass("lazyload").attr('src', baseurl + '/assets/img/loading.gif');
              var strA = "<a data-fancybox='gallery' ref='gallery' href='" + $(this).attr('data-src') + "' data-caption='" + $(this).attr('alt') + "'></a>";
              $(this).wrapAll(strA);
              var caption = $(this)[0].alt;
              $(this).parent().after('<span class="caption">' + caption + '</span>');
          });

          Fancybox.bind('[data-fancybox]', {
            on: {
              load: (fancybox, slide) => {
                var gray = $("meta[property='og:gray']").attr('content');
                if(gray == "true"){
                    $(".fancybox__content img").addClass("gray");
                    $(".carousel__track .fancybox__thumb").addClass("gray");
                }
              }
            }
          });   
          
          

          if($("#comments-switch").length > 0){
            var comment_status = $("#cmn-toggle-4")[0].checked;
            if(comment_status){
              $("#waline").addClass("active");
            }else {
              $("#disqus_thread").addClass("active");
            }
            $("#cmn-toggle-4").click(function(){
              $("#disqus_thread").toggleClass("active");
              $("#waline").toggleClass("active");
            })
          }else {
            if($("#disqus_thread").length > 0) {
              $("#disqus_thread").addClass("active");
            }else if($("#waline").length > 0) {
              $("#waline").addClass("active");
            }
          }

          var time_formats = ['YYYY-MM-DD HH:mm:ss ZZ', 'YYYY DD MMM HH:mm:ss ZZ', 'YYYYå¹´MMæœˆDDæ—¥ HH:mm:ss ZZ'];
          function dateFormat(date, format){
            var date_org = dayjs(date, time_formats[format]);
            var date     = date_org.format(time_formats[format]);
            return {"date_org": date_org, "date": date}
          }

          dayjs.extend(window.dayjs_plugin_customParseFormat);
          dayjs.extend(window.dayjs_plugin_relativeTime);
          var post_date = $("meta[property='post-date']").attr('content');
          var post_date_format = $("meta[property='post-date-format']").attr('content');
          var local_post_date = dateFormat(post_date, post_date_format);

          $(".post time span.create-at").html(local_post_date["date"]);

          fetch("https://api.github.com/repos/gbcpp/gbcpp.github.io/commits?path=_posts/notes/2025-01-10-tcp-optimize-livestream-scene.md")
          .then((response) => {
            return response.json();
          })
          .then((commits) => {
            if(commits.length != 0){
              var update_at = dayjs(commits[0]['commit']['committer']['date']);
            }else {
              var update_at = post_date
            }

            var local_update_at = dateFormat(update_at, post_date_format);
            $('.post time span.update-at').html(local_update_at["date"]);

            var relative_time = dayjs().diff(local_update_at["date_org"], 'day');
            $(".post-copyright .tips span").append(relative_time);
            if(relative_time > 365){
              $(".post-copyright .tips").addClass("active");
            }
          });   
          
          /*
          * Keyboard shortcut bind: left and right
          */

          var previous_url = $("meta[property='og:previous_url']").attr('content');
          var next_url = $("meta[property='og:next_url']").attr('content');

          hotkeys('left', function(event, handler){
              // Prevent the default refresh event under WINDOWS system
              event.preventDefault();
              if(previous_url){
                  console.log('you pressed left!');
                  window.location.href = previous_url;
              }else {
                  $("#no-previous").addClass("active");
                  setTimeout(function(){$("#no-previous").removeClass("active");}, 1500);
              }
          });

          hotkeys('right', function(event, handler){
              // Prevent the default refresh event under WINDOWS system
              event.preventDefault();
              if(next_url){
                  console.log('you pressed right!');
                  window.location.href = next_url;
              }else {
                  $("#no-next").addClass("active");
                  setTimeout(function(){$("#no-next").removeClass("active");}, 1500);
              }
          });
      });
  </script>
  <script src="https://at.alicdn.com/t/font_3046306_skfh9jzzbbf.js"></script>

  
  
  
<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  <script>
    if ("serviceWorker" in navigator) {
        if (navigator.serviceWorker.controller) {
            console.log("An active service worker found, no need to register");
        } else {
            // Register the service worker
            navigator.serviceWorker
            .register("/sw.js", {
                scope: "/"
            })
            .then(function (reg) {
                console.log("Service worker has been registered for scope: " + reg.scope);
            });
        }
    }

// æ£€æµ‹æµè§ˆå™¨æ˜¯å¦æ”¯æŒSW
// if(navigator.serviceWorker != null){
//     navigator.serviceWorker.register("/sw.js")
//         .then(function(registartion){
//             console.log('æ”¯æŒsw:',registartion.scope)
//         })
// } else {
//     console.log('ä¸æ”¯æŒsw')
// }
</script>
	<!--
Author: Ray-Eldath
refer to:
 - http://docs.mathjax.org/en/latest/options/index.html
-->

	<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
		jax: ["input/TeX", "output/HTML-CSS"],
		tex2jax: {
			inlineMath: [ ["$", "$"] ],
			displayMath: [ ["$$", "$$"] ],
			skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
		},
		"HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
      });
    </script>

   
    <script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.6/dist/mermaid.min.js"></script>
    <script>
        $(document).ready(function (){
            mermaid.initialize({
                startOnLoad:true,
                theme: "default",
            });
            mermaid.init(undefined, $('.mermaid2'));
        });
    </script>
 
   
</body>

</html>
