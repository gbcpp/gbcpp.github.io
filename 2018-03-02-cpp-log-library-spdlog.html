<h1 id="c日志组件-spdlog">C++日志组件 spdlog</h1>

<p><code class="language-plaintext highlighter-rouge">spdlog</code> 是基于C++ 11的开源的轻量级的日志组件，引入也非常简单，仅仅需要引入头文件就可以了。</p>

<!--more-->

<h2 id="线程安全">线程安全</h2>

<p>命名空间 <code class="language-plaintext highlighter-rouge">spdlog</code> 之下的大多数函数都是线程安全的，除了：</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">spdlog</span><span class="o">::</span><span class="n">set_pattern</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">spdlog</span><span class="o">::</span><span class="n">set_formatter</span><span class="p">(</span><span class="n">formatter_ptr</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">spdlog</span><span class="o">::</span><span class="n">set_error_handler</span><span class="p">(</span><span class="n">log_err_handler</span><span class="p">);</span>
</code></pre></div></div>

<p>日志器对象的大部分方法也是线程安全的，除了：</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">spdlog</span><span class="o">::</span><span class="n">logger</span><span class="o">::</span><span class="n">set_pattern</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">spdlog</span><span class="o">::</span><span class="n">logger</span><span class="o">::</span><span class="n">set_formatter</span><span class="p">(</span><span class="n">formatter_ptr</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">spdlog</span><span class="o">::</span><span class="n">set_error_handler</span><span class="p">(</span><span class="n">log_err_handler</span><span class="p">);</span>
</code></pre></div></div>

<p>所有以 <code class="language-plaintext highlighter-rouge">_mt</code> 结尾的 Sink 都是用于多线程的，以 <code class="language-plaintext highlighter-rouge">_st</code> 结尾的则是用于单线程的，不过现在单线程的程序很少了吧，建议直接用以 <code class="language-plaintext highlighter-rouge">_mt</code> 结尾的多线程安全的日志对象；</p>

<h2 id="代码示例">代码示例</h2>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">"spdlog/spdlog.h"</span><span class="cp">
#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span> 
<span class="c1">// 多线程的基于控制台（stdout）的日志记录器，支持高亮。类似的stdout_color_st是单线程版本</span>
<span class="k">auto</span> <span class="n">console</span> <span class="o">=</span> <span class="n">spdlog</span><span class="o">::</span><span class="n">stdout_color_mt</span><span class="p">(</span> <span class="s">"console"</span> <span class="p">);</span>
<span class="c1">// 基于文件的简单日志</span>
<span class="k">auto</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">spdlog</span><span class="o">::</span><span class="n">basic_logger_mt</span><span class="p">(</span><span class="s">"basic_logger"</span><span class="p">,</span> <span class="s">"logs/basic.txt"</span><span class="p">);</span>
<span class="c1">// 基于滚动文件的日志，每个文件5MB，三个文件</span>
<span class="k">auto</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">spdlog</span><span class="o">::</span><span class="n">rotating_logger_mt</span><span class="p">(</span><span class="s">"file_logger"</span><span class="p">,</span> <span class="s">"myfilename"</span><span class="p">,</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
 
<span class="c1">// 定制输出格式</span>
<span class="n">spdlog</span><span class="o">::</span><span class="n">set_pattern</span><span class="p">(</span><span class="s">"*** [%H:%M:%S %z] [thread %t] %v ***"</span><span class="p">);</span>
 
<span class="c1">// 多个日志器共享SINK</span>
<span class="k">auto</span> <span class="n">daily_sink</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">spdlog</span><span class="o">::</span><span class="n">sinks</span><span class="o">::</span><span class="n">daily_file_sink_mt</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"logfile"</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">59</span><span class="p">);</span>
<span class="c1">// 下面几个同步日志器共享的输出到目标文件</span>
<span class="k">auto</span> <span class="n">net_logger</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">spdlog</span><span class="o">::</span><span class="n">logger</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"net"</span><span class="p">,</span> <span class="n">daily_sink</span><span class="p">);</span>
<span class="k">auto</span> <span class="n">hw_logger</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">spdlog</span><span class="o">::</span><span class="n">logger</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"hw"</span><span class="p">,</span> <span class="n">daily_sink</span><span class="p">);</span>
<span class="k">auto</span> <span class="n">db_logger</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">spdlog</span><span class="o">::</span><span class="n">logger</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"db"</span><span class="p">,</span> <span class="n">daily_sink</span><span class="p">);</span> 
 
<span class="c1">// 一个日志器使用多个SINK</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">spdlog</span><span class="o">::</span><span class="n">sink_ptr</span><span class="o">&gt;</span> <span class="n">sinks</span><span class="p">;</span>
<span class="n">sinks</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">spdlog</span><span class="o">::</span><span class="n">sinks</span><span class="o">::</span><span class="n">stdout_sink_st</span><span class="o">&gt;</span><span class="p">());</span>
<span class="n">sinks</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">spdlog</span><span class="o">::</span><span class="n">sinks</span><span class="o">::</span><span class="n">daily_file_sink_st</span><span class="o">&gt;</span><span class="p">(</span> <span class="s">"logfile"</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">59</span> <span class="p">));</span>
<span class="k">auto</span> <span class="n">combined_logger</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">spdlog</span><span class="o">::</span><span class="n">logger</span><span class="o">&gt;</span><span class="p">(</span> <span class="s">"name"</span><span class="p">,</span> <span class="n">begin</span><span class="p">(</span> <span class="n">sinks</span> <span class="p">),</span> <span class="n">end</span><span class="p">(</span> <span class="n">sinks</span> <span class="p">));</span>
<span class="n">spdlog</span><span class="o">::</span><span class="n">register_logger</span><span class="p">(</span> <span class="n">combined_logger</span> <span class="p">);</span>
 
<span class="c1">// 异步</span>
<span class="c1">// 每个日志器分配8192长度的队列，队列长度必须2的幂</span>
<span class="n">spdlog</span><span class="o">::</span><span class="n">set_async_mode</span><span class="p">(</span><span class="mi">8192</span><span class="p">);</span> 
<span class="c1">// 程序退出前清理</span>
<span class="n">spdlog</span><span class="o">::</span><span class="n">drop_all</span><span class="p">();</span>
 
<span class="c1">// 注册日志器</span>
<span class="n">spdlog</span><span class="o">::</span><span class="n">register_logger</span><span class="p">(</span><span class="n">net_logger</span><span class="p">);</span>
<span class="c1">// 注册后，其它代码可以根据名称获得日志器</span>
<span class="k">auto</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">spdlog</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">net_logger</span><span class="p">);</span>
 
<span class="c1">// 记录日志</span>
<span class="c1">// 设置最低级别</span>
<span class="n">console</span><span class="o">-&gt;</span><span class="n">set_level</span><span class="p">(</span><span class="n">spdlog</span><span class="o">::</span><span class="n">level</span><span class="o">::</span><span class="n">debug</span><span class="p">);</span>
<span class="n">console</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">(</span><span class="s">"Hello World"</span><span class="p">)</span> <span class="p">;</span>
<span class="c1">// 使用占位符</span>
<span class="n">console</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">(</span><span class="s">"Hello {}"</span> <span class="p">,</span><span class="s">"World"</span><span class="p">);</span> 
<span class="c1">// 带格式化的占位符：d整数，x十六进制，o八进制，b二进制                </span>
<span class="n">console</span><span class="o">-&gt;</span><span class="n">warn</span><span class="p">(</span><span class="s">"Support for int: {0:d}; hex: {0:x}; oct: {0:o}; bin: {0:b}"</span><span class="p">,</span> <span class="mi">42</span><span class="p">);</span>
<span class="c1">// 带格式化的占位符：f浮点数</span>
<span class="n">console</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">(</span><span class="s">"Support for floats {:03.2f}"</span><span class="p">,</span> <span class="mf">1.23456</span><span class="p">);</span>
<span class="c1">// 左对齐，保证30字符宽度</span>
<span class="n">console</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">(</span><span class="s">"{:&lt;30}"</span><span class="p">,</span> <span class="s">"left aligned"</span><span class="p">);</span>
<span class="c1">// 指定占位符位置序号</span>
<span class="n">console</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">(</span><span class="s">"Positional args are {1} {0}.."</span><span class="p">,</span> <span class="s">"too"</span><span class="p">,</span> <span class="s">"supported"</span><span class="p">);</span>
 
<span class="c1">// 记录自定义类型，需要重载&lt;&lt;操作符</span>
<span class="cp">#include</span> <span class="cpf">&lt;spdlog/fmt/ostr.h&gt;</span><span class="c1"> </span><span class="cp">
</span><span class="k">class</span> <span class="nc">Duck</span><span class="p">{}</span>
<span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="k">const</span> <span class="n">Duck</span><span class="o">&amp;</span> <span class="n">duck</span><span class="p">){</span> 
    <span class="k">return</span> <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">duck</span><span class="p">.</span><span class="n">getName</span><span class="p">();</span> 
<span class="p">}</span>
<span class="n">Duck</span> <span class="n">duck</span><span class="p">;</span>
<span class="n">console</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">(</span><span class="s">"custom class with operator&lt;&lt;: {}.."</span><span class="p">,</span> <span class="n">duck</span><span class="p">);</span>
</code></pre></div></div>
<p>输出格式</p>

<p>spdlog默认的输出格式为：</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[2018-03-01 23:46:59.678] [info] [my_loggername] Some message
</code></pre></div></div>
<p>要定制输出格式，可以调用：</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//估计大部分人都喜欢下面这样的格式输出格式：</span>
<span class="n">spdlog</span><span class="o">::</span><span class="n">set_pattern</span><span class="p">(</span><span class="s">"[%Y-%m-%d %H:%M:%S.%e][%t][%l] %v"</span><span class="p">);</span>
<span class="c1">//或者实现自己的格式化器：</span>
<span class="n">spdlog</span><span class="o">::</span><span class="n">set_formatter</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">my_custom_formatter</span><span class="o">&gt;</span><span class="p">());</span>
</code></pre></div></div>

<p>输出格式为：</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[2018-03-01 23:28:04.285][13464][info] Input host name:gobert, ptr:0x9c6a78
</code></pre></div></div>

<p>Pattern 格式说明</p>

<p>输出格式的 Pattern 中可以有若干 <code class="language-plaintext highlighter-rouge">%</code> 开头的标记，含义如下表：</p>

<table>
  <thead>
    <tr>
      <th>标记</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>%v</td>
      <td>实际需要被日志记录的文本，如果文本中有{占位符}会被替换</td>
    </tr>
    <tr>
      <td>%t</td>
      <td>线程标识符</td>
    </tr>
    <tr>
      <td>%P</td>
      <td>进程标识符</td>
    </tr>
    <tr>
      <td>%n</td>
      <td>日志记录器名称</td>
    </tr>
    <tr>
      <td>%l</td>
      <td>日志级别</td>
    </tr>
    <tr>
      <td>%L</td>
      <td>日志级别简写</td>
    </tr>
    <tr>
      <td>%a</td>
      <td>简写的周几，例如Thu</td>
    </tr>
    <tr>
      <td>%A</td>
      <td>周几，例如Thursday</td>
    </tr>
    <tr>
      <td>%b</td>
      <td>简写的月份，例如Aug</td>
    </tr>
    <tr>
      <td>%B</td>
      <td>月份，例如August</td>
    </tr>
    <tr>
      <td>%c</td>
      <td>日期时间，例如Thu Aug 23 15:35:46 2014</td>
    </tr>
    <tr>
      <td>%C</td>
      <td>两位年份，例如14</td>
    </tr>
    <tr>
      <td>%Y</td>
      <td>四位年份，例如2014</td>
    </tr>
    <tr>
      <td>%D 或 %x</td>
      <td>MM/DD/YY格式日期，例如”08/23/14</td>
    </tr>
    <tr>
      <td>%m</td>
      <td>月份，1-12之间</td>
    </tr>
    <tr>
      <td>%d</td>
      <td>月份中的第几天，1-31之间</td>
    </tr>
    <tr>
      <td>%H</td>
      <td>24小时制的小时，0-23之间</td>
    </tr>
    <tr>
      <td>%I</td>
      <td>12小时制的小时，1-12之间</td>
    </tr>
    <tr>
      <td>%M</td>
      <td>分钟，0-59</td>
    </tr>
    <tr>
      <td>%S</td>
      <td>秒，0-59</td>
    </tr>
    <tr>
      <td>%e</td>
      <td>当前秒内的毫秒，0-999</td>
    </tr>
    <tr>
      <td>%f</td>
      <td>当前秒内的微秒，0-999999</td>
    </tr>
    <tr>
      <td>%F</td>
      <td>当前秒内的纳秒， 0-999999999</td>
    </tr>
    <tr>
      <td>%p</td>
      <td>AM或者PM</td>
    </tr>
    <tr>
      <td>%r</td>
      <td>12小时时间，例如02:55:02 pm</td>
    </tr>
    <tr>
      <td>%R</td>
      <td>等价于%H:%M，例如23:55</td>
    </tr>
    <tr>
      <td>%T 或 %X</td>
      <td>HH:MM:SS</td>
    </tr>
    <tr>
      <td>%z</td>
      <td>时区UTC偏移，例如+02:00</td>
    </tr>
    <tr>
      <td>%+</td>
      <td>表示默认格式</td>
    </tr>
  </tbody>
</table>

<h2 id="个人实战应用源码">个人实战应用源码</h2>

<p>根据个人的习惯，喜欢在开发后端程序时，喜欢将 log 同时输出到控制台和文件中，那么根据 spdlog 的接口，需要在创建对象时将 console 和 file sink 均传入即可，代码如下：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">spdlog</span><span class="o">::</span><span class="n">set_async_mode</span><span class="p">(</span><span class="mi">4096</span><span class="p">);</span>
    <span class="n">spdlog</span><span class="o">::</span><span class="n">set_pattern</span><span class="p">(</span><span class="s">"[%Y-%m-%d %H:%M:%S.%e][%t][%l] %v"</span><span class="p">);</span>
    <span class="c1">//创建控制台对象指针</span>
    <span class="k">auto</span> <span class="n">console_log_ptr</span> <span class="o">=</span> <span class="n">spdlog</span><span class="o">::</span><span class="n">stdout_logger_mt</span><span class="p">(</span><span class="s">"console"</span><span class="p">);</span>
    <span class="c1">//创建文件对象指针</span>
    <span class="k">auto</span> <span class="n">file_log_ptr</span> <span class="o">=</span> <span class="n">spdlog</span><span class="o">::</span><span class="n">rotating_logger_mt</span><span class="p">(</span><span class="s">"file"</span><span class="p">,</span> <span class="s">"opc-collector.log"</span><span class="p">,</span> <span class="mi">100</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="c1">//将以上两种日志对象 sink 组合在一起</span>
    <span class="n">spdlog</span><span class="o">::</span><span class="n">sinks_init_list</span> <span class="n">sink_list</span> <span class="o">=</span> <span class="p">{</span> <span class="n">console_log_ptr</span><span class="o">-&gt;</span><span class="n">sinks</span><span class="p">().</span><span class="n">front</span><span class="p">(),</span> <span class="n">file_log_ptr</span><span class="o">-&gt;</span><span class="n">sinks</span><span class="p">().</span><span class="n">front</span><span class="p">()</span> <span class="p">};</span>
    <span class="c1">//创建一个新的日志对象，以上面两个日志对象作为初始化参数，即实现了同时输出 console 和 file</span>
    <span class="k">auto</span> <span class="n">log_ptr</span> <span class="o">=</span> <span class="n">spdlog</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="s">"loggername"</span><span class="p">,</span> <span class="n">sink_list</span><span class="p">);</span>
    
    <span class="n">log_ptr</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">(</span><span class="s">"Test spdlog output:string:{}, int:{}"</span><span class="p">,</span> <span class="s">"spdlog info test string"</span><span class="p">,</span> <span class="mi">123456</span><span class="p">);</span>
    <span class="n">log_ptr</span><span class="o">-&gt;</span><span class="n">flush</span><span class="p">();</span>
</code></pre></div></div>
<p><strong>注：将多个日志对象同时输出到一个日志对象时，其 loggername 不能保持一致，否则报错警告称：loggername 重复！</strong></p>

<p>以上内容大部分参考自：https://blog.gmem.cc/spdlog</p>
